#!/bin/bash

# ===================================================================
# СКРИПТ АВТОМАТИЧЕСКОГО ИМПОРТА СЕБЕСТОИМОСТИ ИЗ EXCEL ФАЙЛОВ
# Запускается каждое утро в 5:00 через cron
# Ищет файл cost_price.xlsx и обновляет себестоимость в dim_products
# ===================================================================

# --- НАСТРОЙКИ ---
export PYTHONIOENCODING=utf-8 # Устанавливаем кодировку
export LANG=ru_RU.UTF-8
export LC_ALL=ru_RU.UTF-8

# Определяем директорию проекта относительно расположения скрипта
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR"
LOG_DIR="$PROJECT_DIR/logs"
LOG_FILE="$LOG_DIR/cost_import_$(date +%Y-%m-%d).log"
LOCK_FILE="$PROJECT_DIR/cost_import.lock"

# --- ФУНКЦИЯ ДЛЯ ЗАПУСКА КОМАНД С ЛОГИРОВАНИЕМ ---
run_task() {
    echo "--- $(date): Запускаем: $@ ---"
    # Запускаем команду, перенаправляя ее вывод в наш лог
    "$@"
    # Проверяем код выхода последней команды
    if [ $? -ne 0 ]; then
        echo "❌ ОШИБКА: Команда '$@' завершилась с ошибкой."
        # Можно добавить отправку уведомления в Telegram/email
    else
        echo "✅ Успех: Команда '$@' завершена."
    fi
    echo "" # Пустая строка для читаемости
}

# --- ЗАЩИТА ОТ ПОВТОРНОГО ЗАПУСКА ---
# Проверяем, не запущен ли уже процесс импорта себестоимости
if [ -f "$LOCK_FILE" ]; then
    # Проверяем, активен ли процесс с PID из lock файла
    LOCK_PID=$(cat "$LOCK_FILE" 2>/dev/null)
    if [ -n "$LOCK_PID" ] && kill -0 "$LOCK_PID" 2>/dev/null; then
        echo "⚠️ Процесс импорта себестоимости уже запущен (PID: $LOCK_PID). Выходим."
        exit 1
    else
        echo "🧹 Удаляем устаревший lock файл"
        rm -f "$LOCK_FILE"
    fi
fi

# Создаем lock файл с PID текущего процесса
echo $$ > "$LOCK_FILE"

# Функция для очистки lock файла при завершении
cleanup() {
    echo "🧹 Очищаем lock файл при завершении"
    rm -f "$LOCK_FILE"
}

# Устанавливаем trap для очистки при любом завершении скрипта
trap cleanup EXIT INT TERM

# Создаем папку для логов, если ее нет
mkdir -p "$LOG_DIR"

# Переходим в директорию проекта. Если не получилось - выходим.
cd "$PROJECT_DIR" || exit 1

# --- ОСНОВНАЯ ЛОГИКА СКРИПТА ---

# Весь вывод этого блока будет записан в лог-файл
{
    echo "==================================================="
    echo "Запуск импорта себестоимости: $(date)"
    echo "==================================================="

    # Находим абсолютные пути к программам
    PYTHON_PATH="$PROJECT_DIR/venv/bin/python3"
    
    # Проверяем существование Python в виртуальном окружении
    if [ ! -f "$PYTHON_PATH" ]; then
        echo "ПРЕДУПРЕЖДЕНИЕ: Виртуальное окружение не найдено, используем системный Python"
        PYTHON_PATH=$(which python3)
    fi

    # Запускаем импорт себестоимости
    run_task "$PYTHON_PATH" cost_importer.py

    echo "==================================================="
    echo "Завершение импорта себестоимости: $(date)"
    echo "==================================================="

} >> "$LOG_FILE" 2>&1
