<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤</h1>

    <div class="test-section">
      <h2>1. –¢–µ—Å—Ç API —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º limit</h2>
      <button class="btn" onclick="testAPILimit()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API</button>
      <div id="api-results"></div>
    </div>

    <div class="test-section">
      <h2>2. –¢–µ—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö</h2>
      <button class="btn" onclick="testDataStructure()">
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
      </button>
      <div id="structure-results"></div>
    </div>

    <div class="test-section">
      <h2>3. –¢–µ—Å—Ç JavaScript –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</h2>
      <button class="btn" onclick="testController()">
        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
      </button>
      <div id="controller-results"></div>
    </div>

    <div class="test-section">
      <h2>4. –¢–µ—Å—Ç CSS —Å—Ç–∏–ª–µ–π</h2>
      <button class="btn" onclick="testStyles()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∏–ª–∏</button>
      <div id="styles-results"></div>
    </div>

    <div class="test-section">
      <h2>5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç</h2>
      <button class="btn" onclick="runIntegrationTest()">–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
      <div id="integration-results"></div>
    </div>

    <script>
      // –¢–µ—Å—Ç API —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º limit
      async function testAPILimit() {
        const resultsDiv = document.getElementById("api-results");
        resultsDiv.innerHTML = '<div class="info">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...</div>';

        const tests = [
          {
            name: "limit=10",
            url: "../api/inventory-analytics.php?action=dashboard&limit=10",
          },
          {
            name: "limit=all",
            url: "../api/inventory-analytics.php?action=dashboard&limit=all",
          },
          {
            name: "no limit",
            url: "../api/inventory-analytics.php?action=dashboard",
          },
        ];

        let results = "";

        for (const test of tests) {
          try {
            const response = await fetch(test.url);
            const data = await response.json();

            if (data.status === "success") {
              const critical = data.data.critical_products;
              const lowStock = data.data.low_stock_products;
              const overstock = data.data.overstock_products;

              results += `<div class="success">
                            ‚úÖ ${test.name}: 
                            –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: ${
                              critical.count || critical.length
                            } (–ø–æ–∫–∞–∑–∞–Ω–æ: ${
                critical.items ? critical.items.length : critical.length
              })
                            | –ù–∏–∑–∫–∏–µ: ${
                              lowStock.count || lowStock.length
                            } (–ø–æ–∫–∞–∑–∞–Ω–æ: ${
                lowStock.items ? lowStock.items.length : lowStock.length
              })
                            | –ò–∑–±—ã—Ç–æ–∫: ${
                              overstock.count || overstock.length
                            } (–ø–æ–∫–∞–∑–∞–Ω–æ: ${
                overstock.items ? overstock.items.length : overstock.length
              })
                        </div>`;
            } else {
              results += `<div class="error">‚ùå ${test.name}: ${data.message}</div>`;
            }
          } catch (error) {
            results += `<div class="error">‚ùå ${test.name}: ${error.message}</div>`;
          }
        }

        resultsDiv.innerHTML = results;
      }

      // –¢–µ—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
      async function testDataStructure() {
        const resultsDiv = document.getElementById("structure-results");
        resultsDiv.innerHTML =
          '<div class="info">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö...</div>';

        try {
          const response = await fetch(
            "../api/inventory-analytics.php?action=dashboard&limit=all"
          );
          const data = await response.json();

          let results = "";

          if (data.status === "success") {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É critical_products
            const critical = data.data.critical_products;
            if (
              critical &&
              typeof critical === "object" &&
              critical.count !== undefined &&
              critical.items !== undefined
            ) {
              results +=
                '<div class="success">‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ critical_products –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞</div>';
            } else {
              results +=
                '<div class="error">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ critical_products</div>';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É low_stock_products
            const lowStock = data.data.low_stock_products;
            if (
              lowStock &&
              typeof lowStock === "object" &&
              lowStock.count !== undefined &&
              lowStock.items !== undefined
            ) {
              results +=
                '<div class="success">‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ low_stock_products –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞</div>';
            } else {
              results +=
                '<div class="error">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ low_stock_products</div>';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É overstock_products
            const overstock = data.data.overstock_products;
            if (
              overstock &&
              typeof overstock === "object" &&
              overstock.count !== undefined &&
              overstock.items !== undefined
            ) {
              results +=
                '<div class="success">‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ overstock_products –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞</div>';
            } else {
              results +=
                '<div class="error">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ overstock_products</div>';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
            results +=
              '<div class="info"><strong>–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:</strong><pre>' +
              JSON.stringify(
                {
                  critical_products: {
                    count: critical.count,
                    items_sample: critical.items
                      ? critical.items.slice(0, 2)
                      : [],
                  },
                },
                null,
                2
              ) +
              "</pre></div>";
          } else {
            results += `<div class="error">‚ùå –û—à–∏–±–∫–∞ API: ${data.message}</div>`;
          }

          resultsDiv.innerHTML = results;
        } catch (error) {
          resultsDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
      }

      // –¢–µ—Å—Ç JavaScript –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
      function testController() {
        const resultsDiv = document.getElementById("controller-results");
        let results = "";

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ –∫–ª–∞—Å—Å InventoryDisplayController
        if (typeof InventoryDisplayController !== "undefined") {
          results +=
            '<div class="success">‚úÖ –ö–ª–∞—Å—Å InventoryDisplayController –∑–∞–≥—Ä—É–∂–µ–Ω</div>';

          try {
            // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            const controller = new InventoryDisplayController();
            results +=
              '<div class="success">‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω</div>';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥—ã
            const methods = [
              "getCurrentMode",
              "switchMode",
              "refresh",
              "isLoading",
            ];
            methods.forEach((method) => {
              if (typeof controller[method] === "function") {
                results += `<div class="success">‚úÖ –ú–µ—Ç–æ–¥ ${method} –¥–æ—Å—Ç—É–ø–µ–Ω</div>`;
              } else {
                results += `<div class="error">‚ùå –ú–µ—Ç–æ–¥ ${method} –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;
              }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            const currentMode = controller.getCurrentMode();
            results += `<div class="info">‚ÑπÔ∏è –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: ${currentMode}</div>`;
          } catch (error) {
            results += `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞: ${error.message}</div>`;
          }
        } else {
          results +=
            '<div class="error">‚ùå –ö–ª–∞—Å—Å InventoryDisplayController –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
        }

        resultsDiv.innerHTML = results;
      }

      // –¢–µ—Å—Ç CSS —Å—Ç–∏–ª–µ–π
      function testStyles() {
        const resultsDiv = document.getElementById("styles-results");
        let results = "";

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ CSS —Å—Ç–∏–ª–∏
        const stylesheets = Array.from(document.styleSheets);
        const inventoryStyles = stylesheets.find(
          (sheet) =>
            sheet.href && sheet.href.includes("inventory-display-styles.css")
        );

        if (inventoryStyles) {
          results +=
            '<div class="success">‚úÖ CSS —Ñ–∞–π–ª inventory-display-styles.css –∑–∞–≥—Ä—É–∂–µ–Ω</div>';

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ CSS –∫–ª–∞—Å—Å—ã
          const testElement = document.createElement("div");
          testElement.className = "display-controls";
          document.body.appendChild(testElement);

          const computedStyle = window.getComputedStyle(testElement);
          if (computedStyle.marginBottom) {
            results +=
              '<div class="success">‚úÖ CSS —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</div>';
          } else {
            results += '<div class="error">‚ùå CSS —Å—Ç–∏–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è</div>';
          }

          document.body.removeChild(testElement);
        } else {
          results +=
            '<div class="error">‚ùå CSS —Ñ–∞–π–ª inventory-display-styles.css –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
        }

        resultsDiv.innerHTML = results;
      }

      // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
      async function runIntegrationTest() {
        const resultsDiv = document.getElementById("integration-results");
        resultsDiv.innerHTML =
          '<div class="info">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...</div>';

        let results = "<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>";
        let passedTests = 0;
        let totalTests = 0;

        // –¢–µ—Å—Ç 1: API –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        totalTests++;
        try {
          const response = await fetch(
            "../api/inventory-analytics.php?action=dashboard&limit=all"
          );
          const data = await response.json();
          if (data.status === "success") {
            results +=
              '<div class="success">‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ</div>';
            passedTests++;
          } else {
            results += '<div class="error">‚ùå API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É</div>';
          }
        } catch (error) {
          results += '<div class="error">‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
        }

        // –¢–µ—Å—Ç 2: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        totalTests++;
        if (typeof InventoryDisplayController !== "undefined") {
          results +=
            '<div class="success">‚úÖ JavaScript –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
          passedTests++;
        } else {
          results +=
            '<div class="error">‚ùå JavaScript –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
        }

        // –¢–µ—Å—Ç 3: CSS —Å—Ç–∏–ª–∏
        totalTests++;
        const stylesheets = Array.from(document.styleSheets);
        const inventoryStyles = stylesheets.find(
          (sheet) =>
            sheet.href && sheet.href.includes("inventory-display-styles.css")
        );
        if (inventoryStyles) {
          results += '<div class="success">‚úÖ CSS —Å—Ç–∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>';
          passedTests++;
        } else {
          results += '<div class="error">‚ùå CSS —Å—Ç–∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>';
        }

        // –¢–µ—Å—Ç 4: localStorage
        totalTests++;
        try {
          localStorage.setItem("test-inventory-display", "test");
          localStorage.removeItem("test-inventory-display");
          results += '<div class="success">‚úÖ localStorage –¥–æ—Å—Ç—É–ø–µ–Ω</div>';
          passedTests++;
        } catch (error) {
          results += '<div class="error">‚ùå localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
        }

        // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const successRate = Math.round((passedTests / totalTests) * 100);
        if (successRate >= 75) {
          results += `<div class="success"><strong>üéâ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: ${passedTests}/${totalTests} (${successRate}%)</strong></div>`;
        } else {
          results += `<div class="error"><strong>‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω: ${passedTests}/${totalTests} (${successRate}%)</strong></div>`;
        }

        resultsDiv.innerHTML = results;
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("load", function () {
        setTimeout(() => {
          testController();
          testStyles();
        }, 1000);
      });
    </script>
  </body>
</html>
