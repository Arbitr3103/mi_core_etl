# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é Wildberries ETL

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API Wildberries –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é ETL —Å–∏—Å—Ç–µ–º—É `mi_core_etl`. –ú–æ–¥—É–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –ø—Ä–æ–¥–∞–∂, –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **`wb_importer.py`** (813 —Å—Ç—Ä–æ–∫) - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å ETL –¥–ª—è Wildberries
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `main.py`** —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `--source=wb`
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤ `run_weekly_etl.sh`** –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- **SQL –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º—É–ª—å—Ç–∏–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### üìä –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–ü—Ä–æ–¥–∞–∂–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã** (`/api/v1/supplier/sales`)
- **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏** (`/api/v5/supplier/reportDetailByPeriod`)
- **–°—ã—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è** –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ `dim_products`

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
```
fact_orders:        –ø—Ä–æ–¥–∞–∂–∏/–≤–æ–∑–≤—Ä–∞—Ç—ã —Å source_id=WB
fact_transactions:  —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–æ–º–∏—Å—Å–∏–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, —à—Ç—Ä–∞—Ñ—ã)
raw_events:         —Å—ã—Ä—ã–µ JSON —Å event_type='wb_sale'/'wb_finance_detail'
```

## üõ†Ô∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
mysql -u username -p database_name < setup_wb_data.sql

# 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é fact_transactions
mysql -u username -p database_name < migrate_fact_transactions.sql
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```bash
# Wildberries API
WB_API_KEY=your_wildberries_api_key_here
WB_API_URL=https://statistics-api.wildberries.ru
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

```bash
# –¢–µ—Å—Ç API –±–µ–∑ –ë–î
python3 test_wb_api_only.py

# –ü–æ–ª–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –ë–î)
python3 test_wb_integration.py
```

### 4. –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞

```bash
# –ò–º–ø–æ—Ä—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
python3 main.py --source=wb --last-7-days

# –ò–º–ø–æ—Ä—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥
python3 main.py --source=wb --date-from=2024-01-01 --date-to=2024-01-31

# –¢–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–∂–∏ (–±–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π)
python3 main.py --source=wb --orders-only --last-7-days

# –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏
python3 main.py --source=wb --transactions-only --last-7-days
```

## ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π ETL
–°–∫—Ä–∏–ø—Ç `run_weekly_etl.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:

```bash
# –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
./run_weekly_etl.sh

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron (–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00)
0 2 * * 0 /path/to/mi_core_etl/run_weekly_etl.sh
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `logs/`:
- `logs/wb_import_YYYY-MM-DD.log` - –ª–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞ Wildberries
- `logs/ozon_import_YYYY-MM-DD.log` - –ª–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞ Ozon

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
SELECT 
    s.name as source,
    COUNT(*) as orders_count,
    SUM(CASE WHEN transaction_type = '–ø—Ä–æ–¥–∞–∂–∞' THEN 1 ELSE 0 END) as sales,
    SUM(CASE WHEN transaction_type = '–≤–æ–∑–≤—Ä–∞—Ç' THEN 1 ELSE 0 END) as returns
FROM fact_orders fo
JOIN sources s ON fo.source_id = s.id
WHERE fo.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY s.name;

-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
SELECT 
    s.name as source,
    COUNT(*) as transactions_count,
    SUM(amount) as total_amount
FROM fact_transactions ft
JOIN sources s ON ft.source_id = s.id
WHERE ft.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY s.name;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—ã—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π

```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è Wildberries
SELECT 
    event_type,
    COUNT(*) as count,
    MAX(created_at) as last_event
FROM raw_events 
WHERE event_type IN ('wb_sale', 'wb_finance_detail')
GROUP BY event_type;
```

## üö® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ API Wildberries

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- **Rate Limit**: 1 –∑–∞–ø—Ä–æ—Å –≤ –º–∏–Ω—É—Ç—É
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂**: –¥–æ 80,000 –∑–∞–ø–∏—Å–µ–π –∑–∞ –∑–∞–ø—Ä–æ—Å
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤**: –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É `rrdid`

### SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
```python
# –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è SSL (—Ç–æ–ª—å–∫–æ –¥–ª—è Wildberries API)
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
```

## üìà –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–∞–Ω–Ω—ã–µ –∏–∑ Wildberries –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:

```bash
# –ó–∞–ø—É—Å–∫ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫
python3 run_aggregation.py
```

–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—É–º–º–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ `client_id` –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –µ–¥–∏–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞.

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
curl -H "Authorization: YOUR_API_KEY" \
  "https://statistics-api.wildberries.ru/api/v1/supplier/sales?dateFrom=2024-01-01"
```

### –û—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
mysql -e "DESCRIBE fact_transactions;" database_name

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
mysql -e "SELECT * FROM sources WHERE code = 'WB';" database_name
mysql -e "SELECT * FROM clients WHERE name = '–¢–î –ú–∞–Ω—Ö—ç—Ç—Ç–µ–Ω';" database_name
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–º–ø–æ—Ä—Ç–æ–º
```bash
# –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
export LOG_LEVEL=DEBUG
python3 main.py --source=wb --last-1-days
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **`WB_SETUP.md`** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- **`test_wb_api_only.py`** - —Ç–µ—Å—Ç API –±–µ–∑ –ë–î
- **`test_wb_integration.py`** - –ø–æ–ª–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
- **–õ–æ–≥–∏ –≤ `logs/`** - –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

‚úÖ **API –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω** - –≤—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ **–î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã  
‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞** - —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞** - –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫  
‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞** - –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞  

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**
