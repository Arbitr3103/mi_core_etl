<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ozon Analytics - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .ozon-container {
        margin: 20px;
      }
      .stats-card {
        margin-bottom: 20px;
      }
      #ozon-chart {
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid ozon-container">
      <div class="row">
        <div class="col-12">
          <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ Ozon</h2>
          <p class="text-muted">
            –ü–µ—Ä–∏–æ–¥: <span id="current-period">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          </p>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
      <div id="ozon-analytics-container"></div>
    </div>

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript -->
    <script>
      // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞—à –∫–æ–¥ –ø—Ä—è–º–æ –≤ HTML
      class OzonAnalyticsFixed {
        constructor() {
          this.apiBaseUrl = "/api/ozon-analytics.php";
          this.isLoading = false;
          this.currentData = null;
          console.log("OzonAnalyticsFixed initialized");
        }

        init() {
          console.log("Initializing Ozon Analytics...");
          this.createUI();
          this.loadInitialData();
        }

        createUI() {
          const container = document.getElementById("ozon-analytics-container");
          container.innerHTML = `
                    <div id="ozon-loading" style="display: none;" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Ozon...</p>
                    </div>
                    
                    <div id="ozon-error" class="alert alert-danger" style="display: none;"></div>
                    
                    <div id="ozon-content">
                        <div class="row mb-4" id="ozon-stats">
                            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–ì—Ä–∞—Ñ–∏–∫ –≤–æ—Ä–æ–Ω–∫–∏</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="ozon-chart" width="600" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–¢–æ–ø —Ç–æ–≤–∞—Ä—ã</h5>
                                    </div>
                                    <div class="card-body" id="ozon-products">
                                        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="ozon-table" class="table-responsive">
                                            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        loadInitialData() {
          const urlParams = new URLSearchParams(window.location.search);
          const startDate = urlParams.get("start_date") || "2025-09-01";
          const endDate = urlParams.get("end_date") || "2025-09-28";

          document.getElementById(
            "current-period"
          ).textContent = `${startDate} - ${endDate}`;
          this.loadData(startDate, endDate);
        }

        async loadData(startDate, endDate) {
          if (this.isLoading) return;

          this.isLoading = true;
          this.showLoading();

          try {
            console.log("Loading Ozon data:", { startDate, endDate });

            const params = new URLSearchParams({
              action: "funnel-data",
              start_date: startDate,
              end_date: endDate,
            });

            const response = await fetch(`${this.apiBaseUrl}?${params}`);

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "–û—à–∏–±–∫–∞ API");
            }

            this.currentData = result.data || [];
            this.updateUI(this.currentData);
            this.hideLoading();

            console.log("Ozon data loaded:", this.currentData);
          } catch (error) {
            console.error("Error loading Ozon data:", error);
            this.showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + error.message);
            this.hideLoading();
          } finally {
            this.isLoading = false;
          }
        }

        updateUI(data) {
          if (!data || data.length === 0) {
            this.showNoData();
            return;
          }

          const stats = this.aggregateData(data);
          this.updateStats(stats);
          this.updateChart(stats);
          this.updateProductsList(data);
          this.updateTable(data);
        }

        aggregateData(data) {
          return data.reduce(
            (acc, item) => {
              acc.views += item.views || 0;
              acc.cart_additions += item.cart_additions || 0;
              acc.orders += item.orders || 0;
              acc.revenue += item.revenue || 0;
              return acc;
            },
            { views: 0, cart_additions: 0, orders: 0, revenue: 0 }
          );
        }

        updateStats(stats) {
          const container = document.getElementById("ozon-stats");
          if (!container) return;

          const conversionViewToCart =
            stats.views > 0
              ? ((stats.cart_additions / stats.views) * 100).toFixed(2)
              : 0;
          const conversionCartToOrder =
            stats.cart_additions > 0
              ? ((stats.orders / stats.cart_additions) * 100).toFixed(2)
              : 0;
          const conversionOverall =
            stats.views > 0
              ? ((stats.orders / stats.views) * 100).toFixed(2)
              : 0;

          container.innerHTML = `
                    <div class="col-md-3">
                        <div class="card bg-primary text-white stats-card">
                            <div class="card-body text-center">
                                <h5>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</h5>
                                <h3>${stats.views.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white stats-card">
                            <div class="card-body text-center">
                                <h5>–í –∫–æ—Ä–∑–∏–Ω—É</h5>
                                <h3>${stats.cart_additions.toLocaleString()}</h3>
                                <small>${conversionViewToCart}% –æ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white stats-card">
                            <div class="card-body text-center">
                                <h5>–ó–∞–∫–∞–∑—ã</h5>
                                <h3>${stats.orders.toLocaleString()}</h3>
                                <small>${conversionCartToOrder}% –æ—Ç –∫–æ—Ä–∑–∏–Ω—ã</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white stats-card">
                            <div class="card-body text-center">
                                <h5>–í—ã—Ä—É—á–∫–∞</h5>
                                <h3>${stats.revenue.toLocaleString()} ‚ÇΩ</h3>
                                <small>${conversionOverall}% –æ–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</small>
                            </div>
                        </div>
                    </div>
                `;
        }

        updateChart(stats) {
          const canvas = document.getElementById("ozon-chart");
          if (!canvas) return;

          const ctx = canvas.getContext("2d");
          const width = canvas.width;
          const height = canvas.height;

          ctx.clearRect(0, 0, width, height);

          const data = [
            { label: "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã", value: stats.views, color: "#007bff" },
            {
              label: "–í –∫–æ—Ä–∑–∏–Ω—É",
              value: stats.cart_additions,
              color: "#ffc107",
            },
            { label: "–ó–∞–∫–∞–∑—ã", value: stats.orders, color: "#28a745" },
          ];

          const maxValue = Math.max(...data.map((d) => d.value));
          const barHeight = 50;
          const barSpacing = 80;
          const startY = 60;

          data.forEach((item, index) => {
            const barWidth =
              maxValue > 0 ? (item.value / maxValue) * (width - 250) : 0;
            const y = startY + index * barSpacing;

            // –†–∏—Å—É–µ–º –ø–æ–ª–æ—Å—É
            ctx.fillStyle = item.color;
            ctx.fillRect(180, y, barWidth, barHeight);

            // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            ctx.strokeRect(180, y, barWidth, barHeight);

            // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç
            ctx.fillStyle = "#333";
            ctx.font = "16px Arial";
            ctx.fillText(item.label, 20, y + 32);
            ctx.fillText(
              item.value.toLocaleString(),
              190 + barWidth + 10,
              y + 32
            );
          });
        }

        updateProductsList(data) {
          const container = document.getElementById("ozon-products");
          if (!container) return;

          const sortedData = [...data]
            .sort((a, b) => (b.revenue || 0) - (a.revenue || 0))
            .slice(0, 5);

          let html = '<div class="list-group list-group-flush">';

          sortedData.forEach((item, index) => {
            const productName = item.product_id || `–¢–æ–≤–∞—Ä ${index + 1}`;
            html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${productName}</h6>
                                <small class="text-muted">${
                                  item.orders || 0
                                } –∑–∞–∫–∞–∑–æ–≤</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">${(
                              item.revenue || 0
                            ).toLocaleString()} ‚ÇΩ</span>
                        </div>
                    `;
          });

          html += "</div>";
          container.innerHTML = html;
        }

        updateTable(data) {
          const container = document.getElementById("ozon-table");
          if (!container) return;

          let html = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                                <th>–í –∫–æ—Ä–∑–∏–Ω—É</th>
                                <th>–ó–∞–∫–∞–∑—ã</th>
                                <th>–í—ã—Ä—É—á–∫–∞</th>
                                <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

          data.forEach((item, index) => {
            const productName = item.product_id || `–¢–æ–≤–∞—Ä ${index + 1}`;
            const conversion = item.conversion_overall || 0;

            html += `
                        <tr>
                            <td>${productName}</td>
                            <td>${(item.views || 0).toLocaleString()}</td>
                            <td>${(
                              item.cart_additions || 0
                            ).toLocaleString()}</td>
                            <td>${(item.orders || 0).toLocaleString()}</td>
                            <td>${(item.revenue || 0).toLocaleString()} ‚ÇΩ</td>
                            <td>${conversion}%</td>
                        </tr>
                    `;
          });

          html += "</tbody></table>";
          container.innerHTML = html;
        }

        showLoading() {
          const loading = document.getElementById("ozon-loading");
          const content = document.getElementById("ozon-content");
          const error = document.getElementById("ozon-error");

          if (loading) loading.style.display = "block";
          if (content) content.style.opacity = "0.5";
          if (error) error.style.display = "none";
        }

        hideLoading() {
          const loading = document.getElementById("ozon-loading");
          const content = document.getElementById("ozon-content");

          if (loading) loading.style.display = "none";
          if (content) content.style.opacity = "1";
        }

        showError(message) {
          const error = document.getElementById("ozon-error");
          const content = document.getElementById("ozon-content");

          if (error) {
            error.innerHTML = `<strong>–û—à–∏–±–∫–∞!</strong> ${message}`;
            error.style.display = "block";
          }
          if (content) content.style.display = "none";
        }

        showNoData() {
          const content = document.getElementById("ozon-content");
          if (content) {
            content.innerHTML = `
                        <div class="alert alert-info text-center">
                            <h4>üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API Ozon</p>
                        </div>
                    `;
          }
        }
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Initializing Ozon Analytics Fixed...");
        const ozonAnalytics = new OzonAnalyticsFixed();
        ozonAnalytics.init();
        window.ozonAnalytics = ozonAnalytics;
      });
    </script>
  </body>
</html>
