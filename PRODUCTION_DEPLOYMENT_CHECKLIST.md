# Контрольный список развертывания в продакшн

## Предварительная подготовка

### Системные требования

- [ ] Python 3.8+ установлен
- [ ] MySQL 8.0+ доступен
- [ ] Свободное место на диске: минимум 2GB
- [ ] Права администратора для настройки cron
- [ ] Доступ к серверу базы данных

### Подготовка окружения

- [ ] Репозиторий склонирован и обновлен до последней версии
- [ ] Файл `.env` создан и настроен с продакшн данными
- [ ] Python зависимости установлены (`pip install -r requirements.txt`)
- [ ] API ключи Ozon и Wildberries получены и добавлены в `.env`
- [ ] SMTP настройки для уведомлений настроены

### Тестирование

- [ ] Миграция протестирована на копии продакшн данных
- [ ] API подключения протестированы
- [ ] Синхронизация протестирована в тестовом режиме
- [ ] Все скрипты имеют права на выполнение

## Процесс развертывания

### Этап 1: Подготовка к развертыванию

```bash
# Проверка готовности системы
./scripts/deploy_production.sh health-check

# Тестирование миграции (обязательно!)
./scripts/test_migration.sh full
```

**Результат:** ✅ Все тесты пройдены успешно

### Этап 2: Создание резервных копий

```bash
# Автоматическое создание бэкапа (выполняется скриптом развертывания)
# Или ручное создание:
mysqldump -u username -p --single-transaction database_name > backup_$(date +%Y%m%d_%H%M%S).sql
```

**Результат:** ✅ Резервная копия создана и проверена

### Этап 3: Развертывание

```bash
# Полное развертывание
./scripts/deploy_production.sh deploy
```

**Ожидаемые этапы:**

- [ ] Проверка предварительных условий
- [ ] Тестирование API подключений
- [ ] Развертывание миграции базы данных
- [ ] Развертывание кода приложения
- [ ] Настройка cron задач
- [ ] Настройка мониторинга
- [ ] Выполнение тестов развертывания

**Результат:** ✅ Развертывание завершено успешно

### Этап 4: Проверка развертывания

```bash
# Проверка статуса
./scripts/deploy_production.sh status

# Проверка здоровья системы
./scripts/deploy_production.sh health-check

# Валидация миграции
./scripts/migrate_production.sh validate
```

**Результат:** ✅ Все проверки пройдены

## Послеразвертывательная проверка

### Проверка базы данных

```sql
-- Проверка структуры таблиц
DESCRIBE inventory_data;
DESCRIBE sync_logs;

-- Проверка данных
SELECT
    source,
    COUNT(*) as total_products,
    COUNT(CASE WHEN warehouse_name IS NOT NULL THEN 1 END) as with_warehouse,
    COUNT(CASE WHEN last_sync_at IS NOT NULL THEN 1 END) as with_sync_time
FROM inventory_data
GROUP BY source;

-- Проверка логов миграции
SELECT * FROM migration_log ORDER BY created_at DESC LIMIT 5;
```

**Ожидаемые результаты:**

- [ ] Таблица `inventory_data` содержит новые поля
- [ ] Таблица `sync_logs` создана
- [ ] Все существующие записи обновлены
- [ ] Миграция отмечена как завершенная

### Проверка cron задач

```bash
# Просмотр установленных задач
crontab -l

# Проверка статуса cron сервиса
sudo systemctl status cron

# Проверка логов cron
sudo tail -f /var/log/syslog | grep CRON
```

**Ожидаемые результаты:**

- [ ] Задачи синхронизации настроены (каждые 6 часов)
- [ ] Задачи мониторинга настроены (каждый час)
- [ ] Еженедельная пересинхронизация настроена
- [ ] Cron сервис активен и работает

### Проверка синхронизации

```bash
# Ручной запуск синхронизации для тестирования
python3 inventory_sync_service.py --test-mode --source=ozon

# Проверка результатов в базе данных
mysql -u username -p database_name -e "
SELECT * FROM sync_logs ORDER BY started_at DESC LIMIT 5;
"
```

**Ожидаемые результаты:**

- [ ] Синхронизация выполняется без ошибок
- [ ] Данные записываются в `inventory_data`
- [ ] Логи записываются в `sync_logs`
- [ ] Время выполнения разумное (< 5 минут для тестового режима)

### Проверка мониторинга

```bash
# Запуск мониторинга
./scripts/monitor_deployment.sh

# Проверка логов мониторинга
tail -f /var/log/inventory_sync/monitor.log
```

**Ожидаемые результаты:**

- [ ] Мониторинг выполняется без ошибок
- [ ] Логи записываются корректно
- [ ] Email уведомления настроены (если требуется)

## Функциональное тестирование

### Тест 1: Полная синхронизация

```bash
# Запуск полной синхронизации
python3 inventory_sync_service.py --source=all

# Проверка результатов
mysql -u username -p database_name -e "
SELECT
    source,
    COUNT(*) as products_synced,
    MAX(last_sync_at) as last_sync
FROM inventory_data
WHERE last_sync_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY source;
"
```

**Критерии успеха:**

- [ ] Синхронизация Ozon завершена успешно
- [ ] Синхронизация Wildberries завершена успешно
- [ ] Количество товаров соответствует ожидаемому
- [ ] Время синхронизации обновлено

### Тест 2: Обработка ошибок

```bash
# Тест с неверными API ключами (временно изменить в .env)
# Проверить, что ошибки логируются корректно
tail -f /var/log/inventory_sync/cron.log
```

**Критерии успеха:**

- [ ] Ошибки API логируются
- [ ] Система не падает при ошибках
- [ ] Retry логика работает
- [ ] Уведомления отправляются при критических ошибках

### Тест 3: Производительность

```bash
# Измерение времени выполнения
time python3 inventory_sync_service.py --source=all

# Проверка использования ресурсов
top -p $(pgrep -f inventory_sync_service.py)
```

**Критерии успеха:**

- [ ] Время выполнения < 30 минут для полной синхронизации
- [ ] Использование памяти < 1GB
- [ ] CPU нагрузка разумная
- [ ] Нет утечек памяти

## Мониторинг после развертывания

### Первые 24 часа

- [ ] Проверять логи каждые 2 часа
- [ ] Мониторить выполнение cron задач
- [ ] Проверять актуальность данных в дашборде
- [ ] Отслеживать производительность системы

### Первая неделя

- [ ] Ежедневная проверка логов синхронизации
- [ ] Еженедельный отчет о работе системы
- [ ] Проверка корректности данных
- [ ] Оптимизация параметров при необходимости

### Команды для мониторинга

```bash
# Проверка статуса системы
./scripts/deploy_production.sh status

# Проверка здоровья
./scripts/deploy_production.sh health-check

# Просмотр логов
tail -f /var/log/inventory_sync/cron.log
tail -f /var/log/inventory_sync/monitor.log

# Проверка последних синхронизаций
mysql -u username -p database_name -e "
SELECT
    source,
    status,
    records_processed,
    started_at,
    duration_seconds
FROM sync_logs
ORDER BY started_at DESC
LIMIT 10;
"
```

## План отката

### Автоматический откат

```bash
# Полный откат развертывания
./scripts/deploy_production.sh rollback
```

### Ручной откат

```bash
# Откат базы данных
./scripts/migrate_production.sh rollback

# Восстановление cron задач
crontab /backup/inventory_sync_deployment/crontab_backup_YYYYMMDD_HHMMSS.txt

# Восстановление кода (если необходимо)
# Использовать резервную копию из /backup/inventory_sync_deployment/
```

## Контакты и эскалация

### Уровень 1: Автоматическое восстановление

- Retry логика в коде
- Автоматические уведомления
- Самодиагностика системы

### Уровень 2: Операционная поддержка

- Проверка логов и статуса
- Перезапуск сервисов
- Базовая диагностика

### Уровень 3: Техническая поддержка

- Анализ кода и конфигурации
- Исправление ошибок
- Обновление системы

### Критические проблемы

- Немедленный откат: `./scripts/deploy_production.sh rollback`
- Уведомление команды разработки
- Документирование проблемы

## Финальная проверка

### Контрольный список завершения

- [ ] Все этапы развертывания выполнены успешно
- [ ] Функциональные тесты пройдены
- [ ] Мониторинг настроен и работает
- [ ] Документация обновлена
- [ ] Команда уведомлена о завершении развертывания
- [ ] План мониторинга на первые 24 часа активирован

### Подтверждение развертывания

**Дата развертывания:** ******\_\_\_******  
**Время завершения:** ******\_\_\_******  
**Ответственный:** ******\_\_\_******  
**Статус:** ✅ Успешно / ❌ Требует внимания

### Примечания

```
Дополнительные замечания, проблемы или рекомендации:

_________________________________________________________________
_________________________________________________________________
_________________________________________________________________
```

---

**Важно:** Сохраните этот контрольный список с отметками о выполнении для документирования процесса развертывания.
