#!/bin/bash

# –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

set -e

echo "üîß –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•"
echo "==================================="

# –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
if [ -f "importers/config.py" ]; then
    echo "üìã –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º python –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    CURRENT_PASSWORD=$(python3 -c "
import sys
sys.path.append('importers')
try:
    from config import DB_CONFIG
    print(DB_CONFIG['password'])
except:
    print('ERROR')
")
    
    if [ "$CURRENT_PASSWORD" = "ERROR" ]; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–∞—Ä–æ–ª—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        CURRENT_PASSWORD=""
    else
        echo "‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–≤–ª–µ—á–µ–Ω: ${CURRENT_PASSWORD:0:8}..."
    fi
else
    echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    CURRENT_PASSWORD=""
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
if [ -n "$CURRENT_PASSWORD" ]; then
    if mysql -u replenishment_user -p"$CURRENT_PASSWORD" replenishment_db -e "SELECT '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!' as status;" 2>/dev/null; then
        echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü..."
        mysql -u replenishment_user -p"$CURRENT_PASSWORD" replenishment_db -e "SHOW TABLES;" 2>/dev/null
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º Python –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        echo "üêç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Python –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
        python3 -c "
import sys
sys.path.append('.')
from replenishment_db_connector import test_connection
if test_connection():
    print('‚úÖ Python –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!')
else:
    print('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å Python –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º')
    sys.exit(1)
"
        
        echo ""
        echo "üéâ –í–°–ï –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û!"
        echo "======================"
        echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é."
        echo ""
        echo "üöÄ –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "python3 simple_api_server.py"
        exit 0
    else
        echo "‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
else
    echo "‚ùå –ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "‚ùå –¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"
echo "======================="
echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å API —Å–µ—Ä–≤–µ—Ä –Ω–∞–ø—Ä—è–º—É—é:"
echo "python3 simple_api_server.py"
echo ""
echo "–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "./fix_server_db.sh"