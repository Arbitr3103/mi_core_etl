#!/bin/bash

# ===================================================================
# Ð•Ð–Ð•ÐÐ•Ð”Ð•Ð›Ð¬ÐÐ«Ð™ ETL Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð”Ð›Ð¯ CRON JOB
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 3:00
# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ ÑƒÐ½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´
# ===================================================================

# --- ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ ---
export PYTHONIOENCODING=utf-8 # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²ÐºÑƒ
PROJECT_DIR="/home/vladimir/mi_core_etl" # ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
LOG_DIR="$PROJECT_DIR/logs"
LOG_FILE="$LOG_DIR/etl_run_$(date +%Y-%m-%d).log"
LOCK_FILE="$PROJECT_DIR/etl_process.lock"

# --- Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð—ÐÐŸÐ£Ð¡ÐšÐ ÐšÐžÐœÐÐÐ” Ð¡ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•Ðœ ---
run_task() {
    echo "--- $(date): Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼: $@ ---"
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ, Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÑ ÐµÐµ Ð²Ñ‹Ð²Ð¾Ð´ Ð² Ð½Ð°Ñˆ Ð»Ð¾Ð³
    "$@"
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð´ Ð²Ñ‹Ñ…Ð¾Ð´Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    if [ $? -ne 0 ]; then
        echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° '$@' Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð°ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹."
        # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Telegram/email
    else
        echo "âœ… Ð£ÑÐ¿ÐµÑ…: ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° '$@' Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°."
    fi
    echo "" # ÐŸÑƒÑÑ‚Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð´Ð»Ñ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸
}

# --- Ð—ÐÐ©Ð˜Ð¢Ð ÐžÐ¢ ÐŸÐžÐ’Ð¢ÐžÐ ÐÐžÐ“Ðž Ð—ÐÐŸÐ£Ð¡ÐšÐ ---
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ETL
if [ -f "$LOCK_FILE" ]; then
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð»Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ñ PID Ð¸Ð· lock Ñ„Ð°Ð¹Ð»Ð°
    LOCK_PID=$(cat "$LOCK_FILE" 2>/dev/null)
    if [ -n "$LOCK_PID" ] && kill -0 "$LOCK_PID" 2>/dev/null; then
        echo "âš ï¸ ETL Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID: $LOCK_PID). Ð’Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼."
        exit 1
    else
        echo "ðŸ§¹ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ð¹ lock Ñ„Ð°Ð¹Ð»"
        rm -f "$LOCK_FILE"
    fi
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ lock Ñ„Ð°Ð¹Ð» Ñ PID Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
echo $$ > "$LOCK_FILE"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ lock Ñ„Ð°Ð¹Ð»Ð° Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸
cleanup() {
    echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ lock Ñ„Ð°Ð¹Ð» Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸"
    rm -f "$LOCK_FILE"
}

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ trap Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
trap cleanup EXIT INT TERM

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð², ÐµÑÐ»Ð¸ ÐµÐµ Ð½ÐµÑ‚
mkdir -p "$LOG_DIR"

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°. Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ - Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼.
cd "$PROJECT_DIR" || exit 1

# --- ÐžÐ¡ÐÐžÐ’ÐÐÐ¯ Ð›ÐžÐ“Ð˜ÐšÐ Ð¡ÐšÐ Ð˜ÐŸÐ¢Ð ---

# Ð’ÐµÑÑŒ Ð²Ñ‹Ð²Ð¾Ð´ ÑÑ‚Ð¾Ð³Ð¾ Ð±Ð»Ð¾ÐºÐ° Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½ Ð² Ð»Ð¾Ð³-Ñ„Ð°Ð¹Ð»
{
    echo "==================================================="
    echo "Ð—Ð°Ð¿ÑƒÑÐº ETL-Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°: $(date)"
    echo "==================================================="

    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ Ðº Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°Ð¼
    GIT_PATH=$(which git)
    PYTHON_PATH="$PROJECT_DIR/venv/bin/python3"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Python Ð² Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸
    if [ ! -f "$PYTHON_PATH" ]; then
        echo "ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•: Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Python"
        PYTHON_PATH=$(which python3)
    fi

    # 1. ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐšÐžÐ”Ð
    run_task "$GIT_PATH" pull

    # 2. Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™
    run_task "$PYTHON_PATH" -m pip install -r requirements.txt

    # 3. Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð”ÐÐÐÐ«Ð¥ Ð˜Ð— Ð˜Ð¡Ð¢ÐžÐ§ÐÐ˜ÐšÐžÐ’
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ main.py Ð´Ð»Ñ Ozon Ð¸ WB Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 7 Ð´Ð½ÐµÐ¹
    run_task "$PYTHON_PATH" main.py --last-7-days

    # 4. ÐÐ“Ð Ð•Ð“ÐÐ¦Ð˜Ð¯ Ð”ÐÐÐÐ«Ð¥
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚-Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð¾Ñ€. ÐžÐ½ ÑÐ°Ð¼ Ð½Ð°Ð¹Ð´ÐµÑ‚, ÐºÐ°ÐºÐ¸Ðµ Ð´Ð½Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ.
    run_task "$PYTHON_PATH" run_aggregation.py

    echo "==================================================="
    echo "Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ ETL-Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°: $(date)"
    echo "==================================================="

} >> "$LOG_FILE" 2>&1
