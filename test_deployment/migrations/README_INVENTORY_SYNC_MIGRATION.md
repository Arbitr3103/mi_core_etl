# Миграция схемы БД для исправления синхронизации остатков

## Описание

Данная миграция исправляет проблемы с синхронизацией остатков товаров между API маркетплейсов (Озон, Wildberries) и локальной базой данных.

## Проблемы, которые решает миграция

1. **Несоответствие схемы БД**: Добавляет недостающие поля в таблицу `inventory_data`
2. **Отсутствие логирования**: Создает таблицу `sync_logs` для отслеживания синхронизации
3. **Неоптимальные запросы**: Добавляет индексы для ускорения работы с данными
4. **Отсутствие мониторинга**: Создает представления и процедуры для мониторинга

## Изменения в схеме БД

### Обновления таблицы inventory_data

Добавляются новые поля:

- `warehouse_name` - название склада
- `stock_type` - тип склада (FBO, FBS, realFBS)
- `quantity_present` - количество товара в наличии
- `quantity_reserved` - зарезервированное количество
- `last_sync_at` - время последней синхронизации

Добавляются индексы:

- `idx_source_sync` - для поиска по источнику и времени синхронизации
- `idx_product_source` - для поиска по товару и источнику
- `idx_warehouse_stock_type` - для поиска по складу и типу
- `idx_last_sync` - для поиска по времени синхронизации

### Новая таблица sync_logs

Создается для отслеживания процессов синхронизации:

- Информация о типе и источнике синхронизации
- Статистика обработки (количество записей, ошибки)
- Временные метки и длительность выполнения
- Детали ошибок для диагностики

### Дополнительные объекты

- **Представление `v_sync_monitoring`** - для мониторинга синхронизации
- **Процедура `CleanupOldSyncLogs`** - для очистки старых логов
- **Триггер `tr_inventory_data_update_sync_time`** - для автоматического обновления времени синхронизации

## Файлы миграции

1. `inventory_sync_schema_update.sql` - основной файл миграции
2. `rollback_inventory_sync_schema_update.sql` - скрипт отката
3. `validate_inventory_sync_migration.sql` - скрипт валидации
4. `../apply_inventory_sync_migration.sh` - скрипт развертывания

## Применение миграции

### Автоматическое применение

```bash
# Установка переменных окружения
export DB_HOST=localhost
export DB_PORT=3306
export DB_USER=your_username
export DB_PASSWORD=your_password
export DB_NAME=replenishment_db

# Применение миграции
./apply_inventory_sync_migration.sh apply
```

### Ручное применение

```bash
# 1. Создание резервной копии
mysqldump -u username -p replenishment_db > backup_before_migration.sql

# 2. Применение миграции
mysql -u username -p replenishment_db < migrations/inventory_sync_schema_update.sql

# 3. Валидация результатов
mysql -u username -p replenishment_db < migrations/validate_inventory_sync_migration.sql
```

## Откат миграции

### Автоматический откат

```bash
./apply_inventory_sync_migration.sh rollback
```

### Ручной откат

```bash
# Вариант 1: Использование скрипта отката
mysql -u username -p replenishment_db < migrations/rollback_inventory_sync_schema_update.sql

# Вариант 2: Восстановление из резервной копии
mysql -u username -p replenishment_db < backup_before_migration.sql
```

## Валидация

Для проверки корректности применения миграции:

```bash
./apply_inventory_sync_migration.sh validate
```

Или вручную:

```bash
mysql -u username -p replenishment_db < migrations/validate_inventory_sync_migration.sql
```

## Требования

- MySQL 5.7+ или MariaDB 10.2+
- Права на изменение структуры БД (ALTER, CREATE, DROP)
- Достаточно места для создания резервной копии

## Безопасность

1. **Резервное копирование**: Автоматически создается резервная копия перед применением
2. **Транзакции**: Все изменения выполняются в рамках транзакций
3. **Валидация**: Проверка корректности применения миграции
4. **Откат**: Возможность быстрого отката изменений

## Мониторинг после миграции

После применения миграции доступны новые возможности мониторинга:

```sql
-- Просмотр статуса синхронизации
SELECT * FROM v_sync_monitoring;

-- Проверка последних логов
SELECT * FROM sync_logs ORDER BY started_at DESC LIMIT 10;

-- Очистка старых логов (старше 90 дней)
CALL CleanupOldSyncLogs(90);
```

## Поддержка

При возникновении проблем:

1. Проверьте логи выполнения скрипта
2. Запустите валидацию миграции
3. Проверьте права доступа к БД
4. При необходимости выполните откат

## Связанные требования

Данная миграция реализует требования:

- 1.1: Корректное получение данных с API Озон
- 1.2: Корректное получение данных с API Wildberries
- 1.3: Корректное сохранение данных в БД
- 2.1: Детальное логирование ошибок синхронизации
- 2.2: Запись кодов ошибок и описаний
