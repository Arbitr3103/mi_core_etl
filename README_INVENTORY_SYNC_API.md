# API управления синхронизацией остатков

Система управления синхронизацией данных об остатках товаров с маркетплейсами Ozon и Wildberries.

## Описание

API предоставляет REST endpoints и веб-интерфейс для:

- Запуска принудительной синхронизации остатков
- Мониторинга статуса синхронизации
- Просмотра отчетов и логов синхронизации
- Управления процессами синхронизации

## Установка и запуск

### Требования

- Python 3.7+
- Flask
- Flask-CORS
- Доступ к базе данных MySQL с таблицами `inventory_data` и `sync_logs`

### Установка зависимостей

```bash
pip install flask flask-cors requests
```

### Запуск API

```bash
# Простой запуск
python inventory_sync_api.py

# Или через стартовый скрипт
python start_inventory_sync_api.py
```

API будет доступен по адресу: `http://localhost:5001`

## API Endpoints

### GET /api/sync/status

Получить текущий статус синхронизации.

**Ответ:**

```json
{
  "success": true,
  "data": {
    "sync_in_progress": false,
    "last_sync_records": [...],
    "inventory_stats": {
      "total_products": 150,
      "ozon_products": 100,
      "wb_products": 50
    },
    "timestamp": "2025-01-06T10:00:00"
  }
}
```

### POST /api/sync/trigger

Запустить принудительную синхронизацию.

**Параметры:**

```json
{
  "sources": ["Ozon", "Wildberries"]
}
```

**Ответ:**

```json
{
  "success": true,
  "message": "Синхронизация запущена в фоновом режиме",
  "sources": ["Ozon", "Wildberries"],
  "started_at": "2025-01-06T10:00:00"
}
```

### GET /api/sync/reports

Получить отчеты о синхронизации за период.

**Параметры:**

- `days` (optional) - количество дней для отчета (по умолчанию 7, максимум 90)

**Ответ:**

```json
{
  "success": true,
  "data": {
    "period_days": 7,
    "statistics": {
      "total_syncs": 14,
      "successful_syncs": 12,
      "failed_syncs": 2,
      "average_duration": 180
    },
    "records_by_source": {...},
    "all_records": [...]
  }
}
```

### GET /api/sync/logs

Получить логи синхронизации с фильтрацией.

**Параметры:**

- `source` (optional) - фильтр по источнику (Ozon, Wildberries)
- `status` (optional) - фильтр по статусу (success, failed, partial)
- `limit` (optional) - количество записей (по умолчанию 50, максимум 500)

**Ответ:**

```json
{
  "success": true,
  "data": {
    "logs": [...],
    "filters": {
      "source": "Ozon",
      "status": "success",
      "limit": 50
    },
    "total_returned": 25
  }
}
```

### GET /api/sync/health

Проверить состояние системы синхронизации.

**Ответ:**

```json
{
  "success": true,
  "data": {
    "database_connected": true,
    "sync_in_progress": false,
    "api_status": "healthy",
    "data_freshness": [...],
    "data_stale": false
  }
}
```

## Веб-интерфейс

### Главная страница (/)

Панель управления синхронизацией с:

- Текущим статусом синхронизации
- Статистикой остатков по маркетплейсам
- Кнопками управления синхронизацией
- Превью последних логов

### Страница логов (/logs)

Детальный просмотр логов синхронизации с:

- Фильтрацией по источнику и статусу
- Сортировкой по времени
- Отображением ошибок и длительности

## Функциональность

### Принудительная синхронизация

- Запуск в фоновом режиме без блокировки API
- Выбор источников для синхронизации
- Отслеживание прогресса выполнения
- Автоматическое логирование результатов

### Мониторинг

- Автоматическое обновление статуса каждые 30 секунд
- Проверка актуальности данных
- Уведомления об ошибках и проблемах
- Детальная статистика по источникам

### Безопасность

- Валидация входных параметров
- Ограничение количества запросов
- Безопасная обработка ошибок БД
- Логирование всех операций

## Тестирование

### Запуск unit тестов

```bash
python test_inventory_sync_api.py
```

### Интеграционные тесты

Для запуска интеграционных тестов API должен быть запущен:

```bash
# В одном терминале
python start_inventory_sync_api.py

# В другом терминале
python -c "from test_inventory_sync_api import run_integration_tests; run_integration_tests()"
```

## Структура файлов

```
inventory_sync_api.py           # Основной файл API
start_inventory_sync_api.py     # Скрипт запуска
test_inventory_sync_api.py      # Тесты API
README_INVENTORY_SYNC_API.md    # Документация
```

## Зависимости

API интегрируется с существующими компонентами системы:

- `inventory_sync_service_with_error_handling.py` - сервис синхронизации
- `sync_logger.py` - система логирования
- `sync_monitor.py` - мониторинг синхронизации
- `config.py` - конфигурация подключения к БД

## Логирование

Все операции API логируются с уровнями:

- INFO - успешные операции
- ERROR - ошибки выполнения
- DEBUG - детальная отладочная информация

Логи записываются в стандартный вывод и могут быть перенаправлены в файл.

## Производительность

- Асинхронное выполнение синхронизации в отдельных потоках
- Кэширование статуса для быстрого отклика
- Ограничение размера ответов для предотвращения перегрузки
- Автоматическая очистка завершенных процессов

## Мониторинг и алерты

API предоставляет endpoint `/api/sync/health` для внешних систем мониторинга:

- Статус подключения к БД
- Актуальность данных
- Наличие активных процессов синхронизации
- Общее состояние системы

## Развертывание

### Продакшн

Для продакшн развертывания рекомендуется:

- Использовать WSGI сервер (Gunicorn, uWSGI)
- Настроить reverse proxy (Nginx)
- Включить HTTPS
- Настроить мониторинг и логирование

### Docker

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 5001
CMD ["python", "start_inventory_sync_api.py"]
```

## Поддержка

При возникновении проблем:

1. Проверьте логи API
2. Убедитесь в доступности БД
3. Проверьте конфигурацию в `config.py`
4. Запустите тесты для диагностики

## Changelog

### v1.0.0 (2025-01-06)

- Первая версия API управления синхронизацией
- Веб-интерфейс для управления и мониторинга
- REST endpoints для всех операций
- Система тестирования и документация
