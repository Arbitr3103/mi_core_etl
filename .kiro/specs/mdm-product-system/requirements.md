# Requirements Document: Система управления мастер-данными товаров (MDM)

## Introduction

Создание системы управления мастер-данными товаров (Master Data Management) для решения критической проблемы: разные API эндпоинты (analytics, inventory, product info) возвращают разные идентификаторы и названия для одних и тех же товаров. Текущая проблема: невозможно получить связку "название + ID" даже с помощью мастер-таблицы из-за несовместимости данных и SQL ошибок при попытке объединения таблиц. Система должна обеспечить надежное сопоставление и единую точку истины для всех товарных данных.

## Requirements

### Requirement 1: Решение проблемы несовместимости данных между эндпоинтами

**User Story:** Как аналитик данных, я хочу получать корректные связки "название + ID" товаров без SQL ошибок, чтобы дашборды показывали реальные названия вместо заглушек типа "Товар Ozon ID 123".

#### Acceptance Criteria

1. WHEN система запрашивает данные из разных эндпоинтов THEN система SHALL корректно сопоставить product_id из inventory с названиями из product info API
2. WHEN выполняется SQL запрос с DISTINCT и ORDER BY THEN система SHALL избегать ошибок "column not in SELECT list"
3. WHEN товар имеет разные ID в разных эндпоинтах THEN система SHALL создать надежную связь через промежуточную таблицу сопоставления
4. IF данные из API недоступны THEN система SHALL использовать кэшированные названия из мастер-таблицы

### Requirement 2: Устранение проблем с SQL запросами и агрегацией данных

**User Story:** Как разработчик системы, я хочу исправить SQL ошибки при объединении данных из разных таблиц, чтобы скрипты синхронизации работали без сбоев.

#### Acceptance Criteria

1. WHEN выполняется запрос с DISTINCT THEN система SHALL корректно обрабатывать ORDER BY без включения сортируемых колонок в SELECT
2. WHEN объединяются данные из inventory_data и dim_products THEN система SHALL использовать правильные типы данных для JOIN операций
3. WHEN происходит группировка по product_id THEN система SHALL корректно агрегировать данные без потери информации
4. IF запрос содержит сложную логику THEN система SHALL разбить его на простые подзапросы для избежания ошибок

### Requirement 3: Надежная синхронизация названий товаров из Ozon API

**User Story:** Как пользователь дашборда, я хочу видеть реальные названия товаров вместо заглушек "Товар Ozon ID 123", чтобы понимать о каких товарах идет речь в отчетах.

#### Acceptance Criteria

1. WHEN запускается скрипт синхронизации THEN система SHALL успешно получить реальные названия из Ozon API без SQL ошибок
2. WHEN получены названия из API THEN система SHALL корректно обновить таблицу dim_products с правильными типами данных
3. WHEN товар не найден в API THEN система SHALL сохранить существующее название или пометить как "Требует обновления"
4. IF API недоступен THEN система SHALL использовать fallback механизм с кэшированными данными

### Requirement 4: Интерфейс управления и верификации данных

**User Story:** Как менеджер по данным, я хочу иметь удобный интерфейс для управления сопоставлениями, верификации автоматических решений и обогащения данных.

#### Acceptance Criteria

1. WHEN пользователь открывает интерфейс управления THEN система SHALL показать список товаров, требующих внимания
2. WHEN пользователь просматривает несопоставленный товар THEN система SHALL показать предлагаемые варианты сопоставления
3. WHEN пользователь подтверждает сопоставление THEN система SHALL обновить связи и пересчитать агрегированные данные
4. WHEN пользователь редактирует мастер-данные THEN система SHALL применить изменения ко всем связанным записям

### Requirement 5: Мониторинг качества данных

**User Story:** Как руководитель аналитики, я хочу видеть метрики качества данных и процент покрытия мастер-данными, чтобы контролировать процесс очистки данных.

#### Acceptance Criteria

1. WHEN система анализирует данные THEN система SHALL рассчитать процент товаров с полными мастер-данными
2. WHEN происходит обновление данных THEN система SHALL обновить метрики качества в реальном времени
3. WHEN качество данных снижается THEN система SHALL отправить уведомление ответственным лицам
4. IF товар имеет "Неизвестный бренд" или "Без категории" THEN система SHALL включить его в отчет о проблемных данных

### Requirement 6: Интеграция с существующими системами

**User Story:** Как разработчик, я хочу интегрировать MDM систему с существующими дашбордами и API, чтобы все отчеты использовали очищенные мастер-данные.

#### Acceptance Criteria

1. WHEN API запрашивает данные товара THEN система SHALL возвращать данные из мастер-таблицы, а не из сырых источников
2. WHEN происходит агрегация данных THEN система SHALL группировать по Master ID, а не по внешним SKU
3. WHEN обновляются мастер-данные THEN система SHALL автоматически обновить все зависимые отчеты и дашборды
4. IF внешний источник недоступен THEN система SHALL продолжать работать с данными из мастер-таблицы

### Requirement 7: Процессы ETL и синхронизации

**User Story:** Как системный администратор, я хочу автоматизировать процессы извлечения, трансформации и загрузки данных из внешних источников в MDM систему.

#### Acceptance Criteria

1. WHEN запускается ETL процесс THEN система SHALL извлечь данные из всех настроенных источников
2. WHEN данные трансформируются THEN система SHALL применить правила очистки и стандартизации
3. WHEN данные загружаются THEN система SHALL выполнить сопоставление с существующими мастер-данными
4. IF процесс ETL завершается с ошибками THEN система SHALL зафиксировать детали ошибок и отправить уведомления

### Requirement 8: Исправление критических проблем с данными

**User Story:** Как технический специалист, я хочу устранить текущие проблемы с несовместимостью данных между эндпоинтами, чтобы система работала стабильно без SQL ошибок.

#### Acceptance Criteria

1. WHEN выполняется скрипт sync-real-product-names.php THEN система SHALL работать без ошибки "Expression #1 of ORDER BY clause is not in SELECT list"
2. WHEN происходит JOIN между inventory_data и dim_products THEN система SHALL использовать совместимые типы данных (VARCHAR vs INT)
3. WHEN товар имеет product_id в inventory но отсутствует в dim_products THEN система SHALL создать запись с временным названием
4. IF разные эндпоинты возвращают разные ID для одного товара THEN система SHALL создать таблицу cross-reference для сопоставления
