# Implementation Plan: Исправление критических проблем MDM системы

- [x] 1. Исправление SQL ошибок и проблем с типами данных

  - [-] 1.1 Создать таблицу product_cross_reference для решения проблем с типами данных

    - Создать таблицу с унифицированными VARCHAR полями для всех типов ID
    - Добавить поля для кэширования названий товаров (fallback данные)
    - Создать индексы для быстрого поиска по разным типам ID
    - Добавить поле sync_status для отслеживания состояния синхронизации
    - _Requirements: 1.1, 1.3, 8.4_

  - [x] 1.2 Исправить существующую таблицу dim_products

    - Изменить тип поля sku_ozon с INT на VARCHAR для совместимости
    - Добавить связь с таблицей product_cross_reference
    - Создать миграционный скрипт для безопасного изменения типа данных
    - Обновить существующие данные для совместимости с новой схемой
    - _Requirements: 1.1, 2.2, 8.2_

  - [x] 1.3 Создать исправленные SQL запросы без ошибок
    - Переписать проблемный запрос с DISTINCT и ORDER BY
    - Создать безопасные паттерны запросов для избежания SQL ошибок
    - Добавить подзапросы для сложной логики вместо прямых JOIN
    - Протестировать все запросы на совместимость с MySQL ONLY_FULL_GROUP_BY
    - _Requirements: 2.1, 2.4, 8.1_

- [x] 2. Создание надежного движка синхронизации без ошибок

  - [x] 2.1 Реализовать класс SafeSyncEngine

    - Создать класс с безопасными методами извлечения данных
    - Добавить проверку типов данных перед выполнением запросов
    - Реализовать пакетную обработку для избежания timeout
    - Создать обработку ошибок с детальным логированием
    - _Requirements: 3.1, 3.4, 8.1_

  - [x] 2.2 Добавить FallbackDataProvider для резервных данных

    - Реализовать кэширование названий товаров в cross_reference таблице
    - Создать механизм получения данных из кэша при недоступности API
    - Добавить автоматическое создание временных названий для новых товаров
    - Реализовать обновление кэша при успешных API запросах
    - _Requirements: 3.3, 3.4, 8.4_

  - [x] 2.3 Создать DataTypeNormalizer для приведения типов

    - Реализовать автоматическое приведение INT к VARCHAR для ID полей
    - Добавить валидацию данных перед записью в базу
    - Создать методы для безопасного сравнения разных типов ID
    - Реализовать нормализацию данных из разных API эндпоинтов
    - _Requirements: 2.2, 2.3, 8.2_

  - [x] 2.4 Написать unit тесты для синхронизации
    - Создать тесты для SafeSyncEngine с различными сценариями ошибок
    - Добавить тесты для FallbackDataProvider и кэширования
    - Протестировать DataTypeNormalizer на разных типах данных
    - Создать интеграционные тесты для полного цикла синхронизации
    - _Requirements: 2.1, 2.2, 3.1_

- [x] 3. Исправление скрипта sync-real-product-names.php

  - [x] 3.1 Переписать проблемный SQL запрос

    - Исправить ошибку "Expression #1 of ORDER BY clause is not in SELECT list"
    - Заменить DISTINCT + ORDER BY на подзапрос или GROUP BY
    - Добавить правильное приведение типов для JOIN операций
    - Протестировать запрос на совместимость с разными версиями MySQL
    - _Requirements: 2.1, 8.1_

  - [x] 3.2 Добавить обработку ошибок и retry логику

    - Реализовать try-catch блоки для всех критических операций
    - Добавить повторные попытки при временных сбоях API
    - Создать детальное логирование ошибок для диагностики
    - Реализовать graceful degradation при недоступности данных
    - _Requirements: 3.4, 8.1_

  - [x] 3.3 Интегрировать с product_cross_reference таблицей

    - Обновить скрипт для использования новой схемы данных
    - Добавить создание записей в cross_reference для новых товаров
    - Реализовать обновление кэшированных названий
    - Создать синхронизацию статуса обработки товаров
    - _Requirements: 1.1, 3.1, 8.4_

  - [x] 3.4 Создать улучшенную версию скрипта
    - Переписать скрипт с использованием новых классов SafeSyncEngine
    - Добавить прогресс-бар и детальную отчетность
    - Реализовать возможность продолжения с места остановки
    - Создать валидацию результатов синхронизации
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 4. Обновление дашборда для отображения реальных названий

  - [x] 4.1 Исправить API endpoints для использования исправленных данных

    - Обновить analytics.php для работы с product_cross_reference таблицей
    - Исправить SQL запросы в API для избежания ошибок с типами данных
    - Добавить fallback логику для отображения кэшированных названий
    - Протестировать API endpoints на корректность возвращаемых данных
    - _Requirements: 1.1, 1.2, 1.3_

  - [x] 4.2 Обновить дашборд для отображения реальных названий товаров

    - Заменить заглушки "Товар Ozon ID 123" на реальные названия
    - Добавить индикаторы качества данных (синхронизировано/требует обновления)
    - Реализовать автоматическое обновление данных при изменении в БД
    - Создать возможность принудительной синхронизации конкретных товаров
    - _Requirements: 3.1, 3.2_

  - [x] 4.3 Добавить мониторинг состояния синхронизации

    - Создать виджет с количеством товаров в разных статусах синхронизации
    - Добавить отображение последнего времени успешной синхронизации
    - Реализовать алерты для товаров с failed статусом синхронизации
    - Создать кнопку для запуска ручной синхронизации
    - _Requirements: 3.3, 8.3_

  - [x] 4.4 Создать отчеты о проблемах с данными
    - Реализовать отчет о товарах с отсутствующими названиями
    - Добавить анализ товаров с ошибками синхронизации
    - Создать отчет о товарах, требующих ручной проверки
    - Реализовать экспорт списка проблемных товаров для исправления
    - _Requirements: 8.1, 8.2, 8.3_

- [x] 5. Тестирование и валидация исправлений

  - [x] 5.1 Протестировать исправленные SQL запросы

    - Выполнить все исправленные запросы на тестовой базе данных
    - Проверить совместимость с разными версиями MySQL
    - Протестировать производительность на больших объемах данных
    - Валидировать корректность возвращаемых результатов
    - _Requirements: 2.1, 2.4, 8.1_

  - [x] 5.2 Протестировать синхронизацию названий товаров

    - Запустить исправленный скрипт sync-real-product-names.php
    - Проверить корректность обновления данных в dim_products
    - Протестировать fallback механизмы при недоступности API
    - Валидировать отображение реальных названий в дашборде
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

  - [x] 5.3 Создать автоматизированные тесты для предотвращения регрессии
    - Написать unit тесты для всех исправленных компонентов
    - Создать интеграционные тесты для полного цикла синхронизации
    - Добавить тесты для проверки совместимости типов данных
    - Реализовать CI/CD pipeline для автоматического тестирования
    - _Requirements: 2.1, 2.2, 3.1_

- [x] 6. Документация и мониторинг

  - [x] 6.1 Создать документацию по исправлениям

    - Документировать все изменения в схеме базы данных
    - Создать руководство по использованию новых классов и методов
    - Написать troubleshooting guide для типичных проблем
    - Создать инструкции по мониторингу состояния синхронизации
    - _Requirements: 1.1, 2.1, 3.1_

  - [x] 6.2 Настроить мониторинг качества данных

    - Создать алерты для товаров с failed статусом синхронизации
    - Добавить мониторинг процента товаров с реальными названиями
    - Реализовать уведомления о критических ошибках синхронизации
    - Создать dashboard для отслеживания метрик качества данных
    - _Requirements: 8.3, 4.3_
