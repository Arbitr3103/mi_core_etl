# Implementation Plan - Warehouse Dashboard

## Task List

-   [x] 1. Подготовка базы данных
-   [x] 1.1 Создать миграцию для расширения таблицы inventory

    -   Добавить поля для метрик Ozon (preparing_for_sale, in_transit, и т.д.)
    -   Добавить поле cluster для группировки складов
    -   _Requirements: 2, 6_

-   [x] 1.2 Создать таблицу warehouse_sales_metrics

    -   Создать таблицу для кэширования расчетных метрик
    -   Добавить индексы на product_id, warehouse_name, liquidity_status
    -   _Requirements: 3, 4, 5, 7_

-   [x] 1.3 Создать SQL функции для расчета метрик

    -   Функция calculate_daily_sales_avg() для расчета среднесуточных продаж
    -   Функция calculate_days_of_stock() для расчета ликвидности в днях
    -   Функция determine_liquidity_status() для определения статуса
    -   _Requirements: 4, 5, 7_

-   [x] 2. Backend API - Сервисы
-   [x] 2.1 Создать SalesAnalyticsService

    -   Метод calculateDailySalesAvg() - расчет среднесуточных продаж за 28 дней
    -   Метод getDaysWithoutSales() - подсчет дней без продаж
    -   Метод getSalesLast28Days() - общее количество продаж за период
    -   Метод getDaysWithStock() - количество дней когда товар был в наличии
    -   _Requirements: 4, 8_

-   [x] 2.2 Создать ReplenishmentCalculator

    -   Метод calculateTargetStock() - расчет целевого запаса на месяц
    -   Метод calculateReplenishmentNeed() - расчет потребности в пополнении
    -   Метод calculateDaysOfStock() - расчет на сколько дней хватит остатков
    -   Метод determineLiquidityStatus() - определение статуса ликвидности
    -   _Requirements: 3, 5, 7_

-   [x] 2.3 Создать WarehouseService

    -   Метод getDashboardData() - получение данных для дашборда с фильтрами
    -   Метод getWarehouseList() - список всех складов
    -   Метод getClusterList() - список всех кластеров
    -   Метод exportToCSV() - экспорт данных в CSV
    -   _Requirements: 1, 2, 9, 10_

-   [x] 3. Backend API - Контроллер и роуты
-   [x] 3.1 Создать WarehouseController

    -   Метод getDashboard() - обработка GET /api/warehouse/dashboard
    -   Метод export() - обработка GET /api/warehouse/export
    -   Валидация параметров запроса
    -   Обработка ошибок
    -   _Requirements: 1, 2, 9, 10_

-   [x] 3.2 Добавить роуты в api.php

    -   GET /api/warehouse/dashboard - получение данных дашборда
    -   GET /api/warehouse/export - экспорт в CSV
    -   GET /api/warehouse/warehouses - список складов
    -   GET /api/warehouse/clusters - список кластеров
    -   _Requirements: 1, 2, 9, 10_

-   [x] 4. Backend - Фоновые задачи
-   [x] 4.1 Создать скрипт обновления метрик

    -   Скрипт refresh_warehouse_metrics.php для пересчета метрик
    -   Обновление таблицы warehouse_sales_metrics
    -   Логирование процесса обновления
    -   _Requirements: 11, 12_

-   [x] 4.2 Настроить cron для автоматического обновления

    -   Добавить задачу в cron для запуска каждый час
    -   Мониторинг выполнения задачи
    -   _Requirements: 11_

-   [x] 5. Frontend - Типы и сервисы
-   [x] 5.1 Создать TypeScript типы

    -   Создать файл types/warehouse.ts с интерфейсами
    -   WarehouseItem, WarehouseDashboardData, FilterState и др.
    -   _Requirements: 1-12_

-   [x] 5.2 Создать warehouse API service

    -   Создать services/warehouse.ts
    -   Функция getDashboardData() для получения данных
    -   Функция exportToCSV() для экспорта
    -   Функция getWarehouses() и getClusters() для фильтров
    -   _Requirements: 1, 2, 9, 10, 11_

-   [x] 5.3 Создать React hooks

    -   Hook useWarehouseDashboard() для загрузки данных
    -   Hook useWarehouses() для списка складов
    -   Hook useClusters() для списка кластеров
    -   _Requirements: 1, 2, 9, 11_

-   [x] 6. Frontend - UI компоненты
-   [x] 6.1 Создать LiquidityBadge компонент

    -   Отображение статуса ликвидности с цветовым индикатором
    -   Показ количества дней запаса
    -   _Requirements: 5, 7_

-   [x] 6.2 Создать ReplenishmentIndicator компонент

    -   Отображение потребности в пополнении
    -   Выделение срочных позиций (> 50% от целевого запаса)
    -   _Requirements: 3_

-   [x] 6.3 Создать MetricsTooltip компонент

    -   Тултип с детальными метриками Ozon
    -   Отображение всех метрик (в пути, на проверке и т.д.)
    -   _Requirements: 6_

-   [x] 6.4 Создать WarehouseFilters компонент

    -   Фильтр по складу (dropdown)
    -   Фильтр по кластеру (dropdown)
    -   Фильтр по статусу ликвидности (dropdown)
    -   Чекбокс "Только активные товары"
    -   Чекбокс "Только с потребностью в пополнении"
    -   _Requirements: 1, 9_

-   [x] 6.5 Создать WarehouseTable компонент

    -   Таблица с колонками: Товар, Склад, Доступно, Продажи/день, Дней запаса, Нужно заказать, Статус
    -   Сортировка по клику на заголовок колонки
    -   Группировка по складам
    -   Отображение итогов по складу
    -   _Requirements: 2, 3, 4, 5, 7, 9_

-   [x] 6.6 Создать DashboardHeader компонент

    -   Отображение сводной статистики (всего товаров, активных, по статусам)
    -   Кнопка "Обновить данные"
    -   Кнопка "Экспорт в CSV"
    -   Время последнего обновления
    -   _Requirements: 10, 11_

-   [x] 7. Frontend - Главная страница
-   [x] 7.1 Создать WarehouseDashboardPage

    -   Интеграция всех компонентов
    -   Управление состоянием фильтров и сортировки
    -   Обработка загрузки и ошибок
    -   _Requirements: 1-12_

-   [x] 7.2 Добавить роут в приложение

    -   Добавить /warehouse-dashboard в роутинг
    -   Добавить пункт в навигационное меню
    -   _Requirements: 1-12_

-   [x] 8. Оптимизация производительности
-   [x] 8.1 Добавить пагинацию

    -   Пагинация на backend (лимит 100 товаров)
    -   Пагинация на frontend
    -   _Requirements: 12_

-   [x] 8.2 Добавить виртуализацию таблицы

    -   Использовать @tanstack/react-virtual для больших списков
    -   Виртуализация при > 50 строках
    -   _Requirements: 12_

-   [x] 8.3 Добавить мемоизацию

    -   React.memo для компонентов строк таблицы
    -   useMemo для расчетов
    -   _Requirements: 12_

-   [ ] 9. Тестирование и документация
-   [x] 9.1 Написать backend unit tests

    -   Тесты для SalesAnalyticsService
    -   Тесты для ReplenishmentCalculator
    -   Тесты для WarehouseService
    -   _Requirements: 3, 4, 5_

-   [x] 9.2 Написать frontend unit tests

    -   Тесты для компонентов
    -   Тесты для hooks
    -   Тесты для утилит
    -   _Requirements: 1-12_

-   [x] 9.3 Написать integration tests

    -   Тесты API endpoints
    -   Тесты взаимодействия компонентов
    -   _Requirements: 1-12_

-   [x] 9.4 Обновить документацию

    -   Добавить описание нового дашборда в README
    -   Документировать API endpoints
    -   Создать user guide для менеджеров
    -   _Requirements: 1-12_

-   [x] 10. Подготовка данных
-   [x] 10.1 Создать скрипт импорта данных Ozon

    -   Парсер CSV отчета "Товар-склад"
    -   Парсер CSV отчета о продажах
    -   Загрузка данных в PostgreSQL
    -   _Requirements: 1, 2, 4_

-   [x] 10.2 Загрузить тестовые данные

    -   Получить отчеты из Ozon
    -   Запустить импорт
    -   Проверить корректность данных
    -   _Requirements: 1, 2, 4_

-   [x] 10.3 Выполнить первоначальный расчет метрик

    -   Запустить скрипт refresh_warehouse_metrics.php
    -   Проверить заполнение таблицы warehouse_sales_metrics
    -   _Requirements: 3, 4, 5, 7_

-   [x] 11. Деплой и проверка
-   [x] 11.1 Деплой backend

    -   Загрузить PHP файлы на сервер
    -   Применить миграции БД
    -   Настроить cron задачи
    -   _Requirements: 1-12_

-   [x] 11.2 Деплой frontend

    -   Собрать production build
    -   Загрузить на сервер через upload_frontend.sh
    -   Проверить работу в браузере
    -   _Requirements: 1-12_

-   [x] 11.3 Финальное тестирование
    -   Проверить все фильтры
    -   Проверить сортировку
    -   Проверить экспорт в CSV
    -   Проверить производительность
    -   Проверить на мобильных устройствах
    -   _Requirements: 1-12_

---

## Порядок выполнения

**Фаза 1: Подготовка (Tasks 1, 10)**

1. Создать миграции БД
2. Создать скрипт импорта данных
3. Загрузить данные из Ozon

**Фаза 2: Backend (Tasks 2, 3, 4)**

1. Создать сервисы для расчетов
2. Создать контроллер и роуты
3. Настроить фоновые задачи

**Фаза 3: Frontend (Tasks 5, 6, 7)**

1. Создать типы и сервисы
2. Создать UI компоненты
3. Создать главную страницу

**Фаза 4: Оптимизация и тестирование (Tasks 8, 9)**

1. Добавить оптимизации
2. Написать тесты
3. Обновить документацию

**Фаза 5: Деплой (Task 11)**

1. Деплой backend
2. Деплой frontend
3. Финальное тестирование

---

## Оценка времени

-   **Фаза 1**: 4-6 часов
-   **Фаза 2**: 8-10 часов
-   **Фаза 3**: 10-12 часов
-   **Фаза 4**: 6-8 часов
-   **Фаза 5**: 2-3 часа

**Общее время**: 30-39 часов (4-5 рабочих дней)

---

## Зависимости

-   Task 2 зависит от Task 1 (нужна схема БД)
-   Task 3 зависит от Task 2 (нужны сервисы)
-   Task 5 зависит от Task 3 (нужны API endpoints)
-   Task 6 зависит от Task 5 (нужны типы и сервисы)
-   Task 7 зависит от Task 6 (нужны компоненты)
-   Task 10 должен быть выполнен до Task 11 (нужны данные для тестирования)

---

## Критические задачи

🔥 **Критические задачи** (без них система не работает):

-   1.1, 1.2 - Схема БД
-   2.1, 2.2, 2.3 - Backend сервисы
-   3.1, 3.2 - API endpoints
-   5.1, 5.2 - Frontend сервисы
-   6.5 - Таблица (основной UI)
-   7.1 - Главная страница
-   10.1, 10.2 - Данные

⚡ **Важные задачи** (улучшают UX):

-   4.1, 4.2 - Автообновление метрик
-   6.1, 6.2, 6.3, 6.4, 6.6 - UI компоненты
-   8.1, 8.2, 8.3 - Оптимизация

📝 **Опциональные задачи** (можно отложить):

-   9.1, 9.2, 9.3 - Тесты (помечены \*)
-   9.4 - Документация
