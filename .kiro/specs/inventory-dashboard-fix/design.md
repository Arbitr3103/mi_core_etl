# Дизайн исправления дашборда складских остатков

## Обзор

Исправление дашборда складских остатков включает в себя обновление API для работы с реальными данными из базы и улучшение пользовательского интерфейса для отображения критически важной информации о товарах.

## Архитектура

### Компоненты системы

1. **API для складских данных** (`api/inventory-analytics.php`)

   - Получение данных из таблицы `inventory_data`
   - Объединение с данными о товарах из `dim_products`
   - Классификация товаров по уровням остатков
   - Группировка по складам

2. **Веб-интерфейс дашборда** (`html/inventory_marketing_dashboard.php`)

   - Отображение KPI метрик
   - Списки товаров по категориям
   - Рекомендации по действиям
   - Автообновление данных

3. **База данных**
   - `inventory_data` - основные данные об остатках
   - `dim_products` - информация о товарах
   - Связь по полю `sku`

## Компоненты и интерфейсы

### API Endpoints

#### GET /api/inventory-analytics.php?action=dashboard

Возвращает сводные данные для дашборда:

```json
{
  "status": "success",
  "data": {
    "critical_stock_count": 12,
    "low_stock_count": 28,
    "overstock_count": 15,
    "total_inventory_value": 8500000,
    "critical_products": [...],
    "low_stock_products": [...],
    "overstock_products": [...],
    "warehouses_summary": [...]
  }
}
```

#### GET /api/inventory-analytics.php?action=critical-products

Возвращает детальный список критических товаров

#### GET /api/inventory-analytics.php?action=warehouse-summary

Возвращает сводку по складам

### Модели данных

#### Товар с остатками

```php
[
    'sku' => 'BRG-6205-2RS',
    'product_name' => 'Подшипник 6205-2RS',
    'total_stock' => 15,
    'warehouses' => [
        'Основной склад' => 10,
        'Резервный склад' => 5
    ],
    'stock_status' => 'critical|low|normal|overstock',
    'last_updated' => '2025-01-13 10:30:00'
]
```

## Логика классификации остатков

### Критерии классификации

- **Критический**: `current_stock <= 5`
- **Низкий**: `current_stock > 5 AND current_stock <= 20`
- **Нормальный**: `current_stock > 20 AND current_stock <= 100`
- **Избыток**: `current_stock > 100`

### SQL запросы

#### Основной запрос для получения данных

```sql
SELECT
    i.sku,
    dp.product_name,
    dp.name as alt_name,
    i.warehouse_name,
    SUM(i.current_stock) as total_stock,
    SUM(i.available_stock) as available_stock,
    MAX(i.last_sync_at) as last_updated,
    CASE
        WHEN SUM(i.current_stock) <= 5 THEN 'critical'
        WHEN SUM(i.current_stock) <= 20 THEN 'low'
        WHEN SUM(i.current_stock) > 100 THEN 'overstock'
        ELSE 'normal'
    END as stock_status
FROM inventory_data i
LEFT JOIN dim_products dp ON i.sku = dp.sku_ozon OR i.sku = dp.sku_wb
WHERE i.current_stock IS NOT NULL
GROUP BY i.sku, i.warehouse_name
ORDER BY stock_status, total_stock ASC
```

## Обработка ошибок

### Сценарии ошибок

1. **Отсутствие данных в inventory_data**

   - Показать сообщение "Нет данных о складских остатках"
   - Предложить запустить синхронизацию

2. **Отсутствие названий товаров**

   - Использовать формат "Товар [SKU]"
   - Показать предупреждение о неполных данных

3. **Ошибки подключения к БД**
   - Показать сообщение об ошибке
   - Предложить обновить страницу

### Логирование

- Логировать все SQL ошибки
- Записывать время выполнения запросов
- Отслеживать количество обращений к API

## Стратегия тестирования

### Модульные тесты

- Тестирование SQL запросов
- Проверка классификации товаров
- Валидация API ответов

### Интеграционные тесты

- Тестирование полного цикла загрузки данных
- Проверка отображения в браузере
- Тестирование обновления данных

### Тесты производительности

- Время загрузки дашборда < 3 секунд
- Обработка до 10,000 товаров
- Автообновление без блокировки UI

## Пользовательский интерфейс

### Макет дашборда

1. **Заголовок** - название и описание
2. **KPI карточки** - критические метрики
3. **Алерты** - срочные уведомления
4. **Списки товаров** - по категориям остатков
5. **Рекомендации** - предлагаемые действия
6. **Кнопки действий** - экспорт, обновление

### Цветовая схема

- **Критический**: красный (#e74c3c)
- **Низкий**: оранжевый (#f39c12)
- **Нормальный**: зеленый (#27ae60)
- **Избыток**: синий (#3498db)

### Адаптивность

- Поддержка мобильных устройств
- Гибкая сетка для разных экранов
- Оптимизация для планшетов

## Безопасность

### Меры безопасности

- Валидация всех входных параметров
- Использование подготовленных SQL запросов
- Ограничение доступа к API
- Логирование всех действий

### Права доступа

- Только авторизованные пользователи
- Разделение прав на чтение/запись
- Аудит действий пользователей
