# План реализации рефакторинга проекта mi_core_etl

## Задачи реализации

-   [x] 1. Аудит и подготовка проекта

    -   Провести полный аудит файловой структуры в `/var/www/mi_core_etl/` и `/var/www/mi_core_api/`
    -   Создать резервную копию текущего состояния проекта
    -   Идентифицировать и задокументировать все мусорные файлы (\_old, .bak, \_test, \_copy)
    -   Проанализировать текущие cron задачи и их логирование
    -   _Требования: 1.1, 1.2, 1.3, 1.4_

-   [x] 2. Очистка проекта и миграция на PostgreSQL

    -   [x] 2.1 Очистка мусорных файлов

        -   Удалить все файлы с суффиксами \_old, .bak, \_test, \_copy, backup согласно audit отчету
        -   Удалить дублированную директорию test_deployment/
        -   Очистить временные и устаревшие backup файлы
        -   Удалить неиспользуемые тестовые скрипты из корня проекта
        -   _Требования: 1.1, 1.2_

    -   [x] 2.2 Реорганизация файловой структуры

        -   Создать новую файловую структуру согласно дизайну
        -   Перенести все PHP файлы из корня в src/api/
        -   Перенести все Python скрипты из корня в src/etl/
        -   Организовать тестовые файлы в tests/unit/ и tests/integration/
        -   Создать директории config/, public/, storage/, deployment/, docs/
        -   _Требования: 1.4, 2.1, 2.2_

    -   [x] 2.3 Миграция с MySQL на PostgreSQL

        -   Установить и настроить PostgreSQL сервер
        -   Создать схему базы данных PostgreSQL на основе текущей MySQL структуры
        -   Написать скрипт миграции данных с проверкой целостности
        -   Обновить все подключения к БД в коде для работы с PostgreSQL
        -   Протестировать работу всех ETL процессов с новой БД
        -   _Требования: 3.1, 3.2, 3.3_

-   [x] 3. Настройка новой структуры проекта

    -   [x] 3.1 Настроить конфигурацию окружения

        -   Создать файл .env.example со всеми необходимыми переменными
        -   Перенести все жестко закодированные учетные данные в .env
        -   Настроить конфигурационные файлы для PostgreSQL, API, кэша и логирования
        -   _Требования: 2.2, 5.2_

    -   [x] 3.2 Настроить Git и автоматизацию
        -   Создать .gitignore для исключения конфиденциальных файлов
        -   Настроить composer.json для PHP зависимостей
        -   Создать root package.json для общих скриптов проекта
        -   _Требования: 4.1, 5.3_

-   [x] 4. Рефакторинг Backend API

    -   [x] 4.1 Создать базовые утилиты и сервисы

        -   Реализовать класс Logger с структурированным логированием
        -   Создать класс Database для управления подключениями к PostgreSQL
        -   Реализовать CacheService для кэширования данных
        -   _Требования: 2.2, 2.3_

    -   [x] 4.2 Создать модели данных

        -   Реализовать класс Product с методами валидации и сериализации
        -   Создать класс Inventory для управления складскими данными
        -   Реализовать класс Warehouse для данных о складах
        -   _Требования: 2.1, 2.2_

    -   [x] 4.3 Реализовать унифицированный API

        -   Создать InventoryController с методами getDashboardData и getProductDetails
        -   Реализовать middleware для аутентификации, CORS и rate limiting
        -   Настроить роутинг для API endpoints
        -   Добавить обработку ошибок и валидацию входных данных
        -   _Требования: 2.1, 2.2, 7.4_

    -   [x] 4.4 Написать unit тесты для Backend
        -   Создать тесты для InventoryController
        -   Написать тесты для моделей данных
        -   Создать тесты для сервисов и утилит
        -   _Требования: 2.2_

-   [x] 5. Оптимизация PostgreSQL базы данных

    -   [x] 5.1 Очистка и оптимизация PostgreSQL схемы

        -   Удалить временные таблицы и представления (\_copy, \_test, \_backup)
        -   Создать оптимизированные индексы для PostgreSQL
        -   Настроить партиционирование больших таблиц по датам
        -   Очистить устаревшие данные согласно политике хранения
        -   _Требования: 3.1, 3.3_

    -   [x] 5.2 Создать оптимизированные представления и функции

        -   Создать материализованные представления для дашборда
        -   Реализовать PostgreSQL функции для сложных вычислений
        -   Настроить автоматическое обновление материализованных представлений
        -   Проанализировать медленные запросы с помощью EXPLAIN ANALYZE
        -   _Требования: 3.2, 3.3_

    -   [x] 5.3 Настроить резервное копирование PostgreSQL
        -   Создать скрипт для автоматического резервного копирования с pg_dump
        -   Настроить инкрементальные бэкапы с помощью WAL архивирования
        -   Настроить расписание бэкапов в cron
        -   Задокументировать процедуры восстановления
        -   _Требования: 3.4, 7.3_

-   [x] 6. Создание React приложения

    -   [x] 6.1 Инициализация React проекта

        -   Создать новое React приложение с Vite и TypeScript
        -   Настроить Tailwind CSS для стилизации
        -   Установить и настроить TanStack Query, Zustand, React Virtual
        -   Настроить конфигурацию сборки и development сервера
        -   _Требования: 2.1, 2.4, 6.1, 6.2_

    -   [x] 6.2 Создать базовые UI компоненты

        -   Реализовать компоненты Button, Card, Toggle, LoadingSpinner
        -   Создать компонент VirtualList для виртуализации больших списков
        -   Реализовать компонент ErrorMessage для отображения ошибок
        -   _Требования: 2.4, 6.2, 6.5_

    -   [x] 6.3 Реализовать типы и сервисы

        -   Создать TypeScript типы для Product, DashboardData, ApiResponse
        -   Реализовать API сервис для взаимодействия с backend
        -   Создать inventory сервис с методами для получения данных
        -   _Требования: 6.1, 6.3_

    -   [x] 6.4 Создать кастомные хуки
        -   Реализовать хук useInventory для управления данными инвентаря
        -   Создать хук useLocalStorage для сохранения пользовательских настроек
        -   Реализовать хук useVirtualization для оптимизации больших списков
        -   _Требования: 6.2, 6.4, 6.5_

-   [x] 7. Реализация основных компонентов дашборда

    -   [x] 7.1 Создать компоненты макета

        -   Реализовать компонент Layout с Header и Navigation
        -   Создать компонент Header с заголовком и навигацией
        -   _Требования: 2.4, 6.2_

    -   [x] 7.2 Реализовать компоненты инвентаря

        -   Создать компонент InventoryDashboard как главный контейнер
        -   Реализовать компонент ProductList с поддержкой виртуализации
        -   Создать компонент ProductCard для отображения информации о товаре
        -   Реализовать компонент StockStatusBadge для индикации статуса остатков
        -   _Требования: 6.1, 6.2, 6.3, 6.5_

    -   [x] 7.3 Создать компонент переключения режимов

        -   Реализовать компонент ViewModeToggle для переключения между "Топ-10" и "Показать все"
        -   Добавить отображение счетчиков товаров для каждой категории
        -   Интегрировать сохранение выбранного режима в localStorage
        -   _Требования: 6.1, 6.4_

    -   [x] 7.4 Написать тесты для React компонентов
        -   Создать тесты для InventoryDashboard компонента
        -   Написать тесты для ProductList с различными режимами отображения
        -   Создать тесты для кастомных хуков
        -   _Требования: 6.2_

-   [x] 8. Интеграция и оптимизация

    -   [x] 8.1 Интегрировать React с Backend API

        -   Настроить проксирование API запросов в development режиме
        -   Реализовать обработку ошибок и retry логику
        -   Добавить индикаторы загрузки и состояния ошибок
        -   _Требования: 6.3, 6.4_

    -   [x] 8.2 Оптимизировать производительность

        -   Реализовать мемоизацию компонентов с React.memo
        -   Настроить ленивую загрузку компонентов с React.lazy
        -   Оптимизировать bundle размер с помощью анализа Vite
        -   Настроить кэширование API ответов на 5 минут
        -   _Требования: 6.5, 3.2_

    -   [x] 8.3 Настроить сборку для продакшена
        -   Настроить Vite конфигурацию для production сборки
        -   Создать скрипт для автоматической сборки и деплоя React приложения
        -   Настроить статическую раздачу файлов через Nginx
        -   _Требования: 2.4, 4.2_

-   [x] 9. DevOps и автоматизация

    -   [x] 9.1 Создать скрипты развертывания

        -   Реализовать скрипт deploy.sh для автоматического развертывания
        -   Создать скрипт backup.sh для резервного копирования PostgreSQL
        -   Реализовать скрипт rollback.sh для отката к предыдущей версии
        -   _Требования: 4.1, 4.2, 7.3_

    -   [x] 9.2 Настроить мониторинг и логирование

        -   Систематизировать все cron задачи с комментариями
        -   Настроить централизованное логирование для всех компонентов
        -   Создать health check endpoint для мониторинга состояния API и PostgreSQL
        -   _Требования: 4.3, 4.4, 7.1_

    -   [x] 9.3 Оптимизировать серверную конфигурацию
        -   Настроить Nginx конфигурацию для статических файлов и API проксирования
        -   Оптимизировать PHP-FPM настройки для лучшей производительности
        -   Настроить PostgreSQL для оптимальной производительности
        -   Настроить gzip сжатие для API ответов и статических файлов
        -   _Требования: 4.2, 7.1_

-   [x] 10. Документация и финализация

    -   [x] 10.1 Создать документацию проекта

        -   Написать подробный README.md с описанием архитектуры и инструкциями
        -   Создать документацию API с описанием всех endpoints
        -   Написать инструкции по развертыванию и настройке PostgreSQL окружения
        -   Документировать процедуры миграции с MySQL на PostgreSQL
        -   _Требования: 5.1, 5.3, 5.4_

    -   [x] 10.2 Провести финальное тестирование

        -   Протестировать все функции дашборда в различных режимах
        -   Проверить производительность при больших объемах данных в PostgreSQL
        -   Протестировать процесс развертывания на staging окружении
        -   _Требования: 6.1, 6.2, 6.5, 7.1_

    -   [x] 10.3 Финальная очистка и оптимизация
        -   Провести финальную проверку отсутствия мусорных файлов
        -   Оптимизировать PostgreSQL индексы на основе реального использования
        -   Обновить все ссылки и интеграции на новый React дашборд
        -   _Требования: 1.1, 1.2, 2.4_

-   [x] 11. Запуск и мониторинг

    -   [x] 11.1 Развертывание в продакшене

        -   Выполнить финальное развертывание на сервере Elysia с PostgreSQL
        -   Настроить мониторинг производительности PostgreSQL и ошибок
        -   Провести smoke тестирование всех критических функций
        -   _Требования: 4.1, 4.2, 7.1_

    -   [x] 11.2 Передача проекта
        -   Провести демонстрацию нового дашборда заинтересованным сторонам
        -   Передать документацию и инструкции по поддержке PostgreSQL
        -   Настроить процедуры мониторинга и обслуживания
        -   _Требования: 5.1, 7.1, 7.2_
