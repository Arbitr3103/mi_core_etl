# Requirements Document - Warehouse Multi-Source Integration

## Introduction

Модернизация системы складского дашборда для получения данных по всем 32 складам Ozon через гибридную модель: приоритетное использование API v2/analytics/stock_on_warehouses с fallback на парсинг UI-отчетов. Система должна обеспечить полную детализацию остатков по складам с валидацией качества данных.

## Glossary

-   **System** - Warehouse Multi-Source Integration System (система интеграции множественных источников данных складов)
-   **API_Source** - данные, полученные через Ozon API v2/analytics/stock_on_warehouses
-   **UI_Source** - данные, полученные через парсинг UI-отчетов Ozon (CSV/XLS)
-   **Hybrid_Loader** - компонент, который управляет загрузкой из разных источников
-   **Data_Validator** - компонент для валидации и сравнения данных из разных источников
-   **Warehouse_Detail** - детальная информация по конкретному складу (не кластеру)
-   **Stock_Report** - отчет "Товар-склад" из UI Ozon
-   **Sales_Report** - отчет по продажам со склада из UI Ozon
-   **Data_Quality_Score** - оценка качества данных (API=100%, UI=80%, устаревшие=50%)
-   **Fallback_Strategy** - стратегия переключения на альтернативный источник данных

## Requirements

### Requirement 1: Тестирование API v2/analytics/stock_on_warehouses

**User Story:** Как разработчик, я хочу протестировать возможности API v2/analytics/stock_on_warehouses, чтобы понять какие данные по складам он может предоставить

#### Acceptance Criteria

1. THE System SHALL выполнить тестовый запрос к POST /v2/analytics/stock_on_warehouses с валидными Client-Id и Api-Key
2. THE System SHALL логировать полный JSON ответ для анализа структуры данных
3. WHEN API возвращает данные по складам, THE System SHALL извлечь список доступных складов и их метрики
4. WHEN API не предоставляет детализацию по складам, THE System SHALL зафиксировать это ограничение в логах
5. THE System SHALL проверить лимиты частоты запросов и документировать их

### Requirement 2: Создание гибридного загрузчика данных

**User Story:** Как система, я хочу автоматически выбирать лучший источник данных, чтобы обеспечить максимальную детализацию по складам

#### Acceptance Criteria

1. THE System SHALL создать Hybrid_Loader с приоритетной стратегией: API_Source → UI_Source
2. WHEN API_Source предоставляет детализацию по складам, THE System SHALL использовать API_Source как основной
3. WHEN API_Source не предоставляет детализацию по складам, THE System SHALL переключиться на UI_Source
4. THE System SHALL сохранять информацию об источнике данных для каждой записи в поле data_source
5. THE System SHALL логировать все переключения между источниками с указанием причины

### Requirement 3: Парсинг UI-отчетов Ozon

**User Story:** Как система, я хочу автоматически парсить UI-отчеты Ozon, чтобы получить детализацию по всем 32 складам когда API недостаточен

#### Acceptance Criteria

1. THE System SHALL парсить CSV/XLS отчет "Товар-склад" из UI Ozon
2. THE System SHALL извлекать следующие поля: SKU, название товара, склад, доступно к продаже, зарезервировано, готовим к продаже, в пути
3. THE System SHALL парсить CSV/XLS отчет по продажам со склада для получения данных о продажах по складам
4. WHEN файл отчета поврежден или имеет неожиданную структуру, THE System SHALL логировать ошибку и пропускать файл
5. THE System SHALL поддерживать автоматическое определение кодировки файлов (UTF-8, Windows-1251)

### Requirement 4: Валидация качества данных

**User Story:** Как менеджер, я хочу видеть качество данных по каждому складу, чтобы понимать насколько можно доверять информации

#### Acceptance Criteria

1. THE System SHALL сравнивать суммарные остатки из API_Source и UI_Source для валидации
2. WHEN расхождение между источниками превышает 10%, THE System SHALL создавать алерт о низком качестве данных
3. THE System SHALL рассчитывать Data_Quality_Score: API=100%, UI=80%, смешанные данные=90%, устаревшие>24ч=50%
4. THE System SHALL отображать индикатор качества данных рядом с каждым складом в дашборде
5. THE System SHALL создавать еженедельный отчет о качестве данных с рекомендациями по улучшению

### Requirement 5: Расширение схемы базы данных

**User Story:** Как система, я хочу хранить данные из разных источников с метаинформацией, чтобы обеспечить трассируемость и качество

#### Acceptance Criteria

1. THE System SHALL добавить поле data_source ENUM('api', 'ui_report', 'mixed') в таблицу inventory
2. THE System SHALL добавить поле data_quality_score INTEGER (0-100) в таблицу inventory
3. THE System SHALL добавить поле last_api_sync TIMESTAMP для отслеживания последней синхронизации через API
4. THE System SHALL добавить поле last_ui_sync TIMESTAMP для отслеживания последней синхронизации через UI-отчеты
5. THE System SHALL создать таблицу data_quality_log для хранения истории валидации данных

### Requirement 6: Автоматизация загрузки UI-отчетов

**User Story:** Как система, я хочу автоматически загружать UI-отчеты по расписанию, чтобы обеспечить актуальность данных без ручного вмешательства

#### Acceptance Criteria

1. THE System SHALL создать скрипт для автоматической загрузки отчетов из директории uploads/ozon_reports/
2. THE System SHALL обрабатывать файлы по маске: stock*report*_.csv, sales*report*_.csv
3. WHEN новый файл отчета обнаружен, THE System SHALL автоматически запустить парсинг
4. THE System SHALL перемещать обработанные файлы в архивную директорию с timestamp
5. THE System SHALL отправлять уведомления об ошибках парсинга администратору системы

### Requirement 7: Мониторинг и алертинг

**User Story:** Как администратор, я хочу получать уведомления о проблемах с загрузкой данных, чтобы оперативно реагировать на сбои

#### Acceptance Criteria

1. THE System SHALL мониторить успешность API запросов и создавать алерт при failure rate > 20%
2. THE System SHALL мониторить актуальность данных и создавать алерт когда данные старше 6 часов
3. THE System SHALL мониторить расхождения между источниками и создавать алерт при расхождении > 15%
4. THE System SHALL отправлять ежедневный summary report о состоянии системы
5. THE System SHALL создавать критический алерт когда данные по складам недоступны более 12 часов

### Requirement 8: API для управления источниками данных

**User Story:** Как администратор, я хочу управлять источниками данных через API, чтобы настраивать приоритеты и стратегии загрузки

#### Acceptance Criteria

1. THE System SHALL предоставить endpoint GET /api/warehouse/data-sources для просмотра статуса источников
2. THE System SHALL предоставить endpoint POST /api/warehouse/sync для принудительной синхронизации
3. THE System SHALL предоставить endpoint GET /api/warehouse/data-quality для просмотра метрик качества
4. THE System SHALL предоставить endpoint PUT /api/warehouse/source-priority для изменения приоритета источников
5. THE System SHALL логировать все административные действия с источниками данных

### Requirement 9: Расширение дашборда для отображения источников

**User Story:** Как менеджер, я хочу видеть источник данных для каждого склада, чтобы понимать надежность информации

#### Acceptance Criteria

1. THE System SHALL отображать иконку источника данных рядом с названием каждого склада
2. THE System SHALL использовать цветовое кодирование: зеленый=API, желтый=UI-отчеты, красный=устаревшие данные
3. THE System SHALL показывать tooltip с детальной информацией о качестве данных при наведении на иконку
4. THE System SHALL добавить фильтр "Источник данных" в панель фильтров дашборда
5. THE System SHALL добавить toggle "Показать только API данные" для фильтрации по качеству

### Requirement 10: Оптимизация производительности

**User Story:** Как пользователь, я хочу чтобы дашборд загружался быстро даже с данными по всем 32 складам

#### Acceptance Criteria

1. THE System SHALL кэшировать результаты API запросов на 2 часа (с учетом лимитов Ozon)
2. THE System SHALL использовать инкрементальную загрузку - обновлять только измененные данные
3. THE System SHALL предварительно рассчитывать агрегированные метрики в фоновом режиме
4. WHEN количество складов превышает 10, THE System SHALL использовать пагинацию в дашборде
5. THE System SHALL загружать дашборд в течение 3 секунд для любого количества складов

### Requirement 11: Резервное копирование и восстановление

**User Story:** Как администратор, я хочу иметь возможность восстановить данные при сбоях, чтобы обеспечить непрерывность работы

#### Acceptance Criteria

1. THE System SHALL создавать ежедневные бэкапы таблиц с данными складов
2. THE System SHALL сохранять копии всех загруженных UI-отчетов в течение 30 дней
3. THE System SHALL предоставить скрипт восстановления данных из бэкапа
4. THE System SHALL логировать все операции бэкапа и восстановления
5. THE System SHALL тестировать процедуру восстановления еженедельно

### Requirement 12: Документация и обучение

**User Story:** Как пользователь системы, я хочу понимать как работает новая система источников данных, чтобы эффективно ее использовать

#### Acceptance Criteria

1. THE System SHALL предоставить документацию по настройке API ключей Ozon
2. THE System SHALL предоставить инструкцию по загрузке UI-отчетов
3. THE System SHALL предоставить руководство по интерпретации индикаторов качества данных
4. THE System SHALL предоставить troubleshooting guide для решения типовых проблем
5. THE System SHALL создать видео-инструкцию по работе с обновленным дашбордом

### Requirement 13: Audit Trail и версионирование данных

**User Story:** Как администратор, я хочу видеть когда и как изменялись данные по складам, чтобы понимать происхождение каждой метрики

#### Acceptance Criteria

1. THE System SHALL сохранять в таблице inventory_audit историю всех изменений остатков по складам
2. THE System SHALL фиксировать источник изменения (API, UI, ручное исправление) с timestamp
3. THE System SHALL поддерживать хранение истории минимум 30 дней
4. THE System SHALL позволять откат данных до предыдущей версии через админ-интерфейс
5. THE System SHALL логировать инициатора изменений при ручных правках

### Requirement 14: Data Normalization Layer

**User Story:** Как разработчик, я хочу чтобы все данные из разных источников были приведены к единому формату, чтобы их можно было корректно сравнивать

#### Acceptance Criteria

1. THE System SHALL иметь слой нормализации, который приводит поля из API и UI к единому стандарту
2. THE System SHALL стандартизировать названия складов, SKU и единицы измерения
3. THE System SHALL обрабатывать дубликаты и опечатки в названиях складов через справочник синонимов
4. THE System SHALL логировать все случаи нераспознанных SKU или складов для ручной проверки
5. THE System SHALL применять бизнес-правила для разрешения конфликтов между источниками

### Requirement 15: Error Recovery & Retry Logic

**User Story:** Как система, я хочу уметь автоматически восстанавливаться после ошибок загрузки, чтобы не требовалось ручное вмешательство

#### Acceptance Criteria

1. THE System SHALL повторять неуспешные API-запросы с экспоненциальной задержкой (1s, 2s, 4s, 8s, 16s)
2. THE System SHALL помечать неуспешные UI-файлы и повторно пытаться их обработать через 10 минут
3. THE System SHALL хранить список последних 50 ошибок с возможностью просмотра в админ-панели
4. THE System SHALL автоматически уведомлять об устойчивых сбоях (>3 попыток) администратора
5. THE System SHALL реализовать circuit breaker pattern для защиты от каскадных сбоев

### Requirement 16: Security & Access Control

**User Story:** Как администратор, я хочу чтобы доступ к данным складов и API ключам был защищен, чтобы предотвратить несанкционированное использование

#### Acceptance Criteria

1. THE System SHALL хранить API ключи в зашифрованном виде через .env с encryption или Vault
2. THE System SHALL ограничивать доступ к endpoint'ам /sync и /source-priority только для администраторов
3. THE System SHALL логировать все попытки несанкционированного доступа с IP и timestamp
4. THE System SHALL поддерживать JWT токены для авторизации административных операций
5. THE System SHALL реализовать rate limiting для API endpoints (100 запросов/минуту на пользователя)

### Requirement 17: Data Latency & Freshness Metrics

**User Story:** Как аналитик, я хочу видеть насколько свежие данные использует дашборд, чтобы понимать актуальность принимаемых решений

#### Acceptance Criteria

1. THE System SHALL отображать для каждого склада время последнего обновления в формате "X минут назад"
2. THE System SHALL считать среднюю задержку загрузки данных (API/UI) за последние 24 часа
3. THE System SHALL отображать метрику "data_age_minutes" в tooltip при наведении на склад
4. THE System SHALL создавать предупреждение при задержке обновления > 2 часов
5. THE System SHALL предоставлять SLA метрики: uptime, средняя задержка, процент успешных обновлений

### Requirement 18: Unit & Integration Testing Coverage

**User Story:** Как инженер, я хочу быть уверен что обновления не ломают работу интеграции, чтобы поддерживать стабильность системы

#### Acceptance Criteria

1. THE System SHALL иметь unit тесты для API-загрузки, парсинга UI, валидации и fallback-логики
2. THE System SHALL покрывать не менее 80% кода автоматическими тестами
3. THE System SHALL использовать mock-ответы Ozon API для тестирования без реальных запросов
4. THE System SHALL запускать CI pipeline при каждом коммите с проверкой тестов
5. THE System SHALL включать integration тесты для проверки полного цикла загрузки данных

---

## Summary

Система модернизируется для поддержки всех 32 складов Ozon через гибридную модель загрузки данных с приоритетом API и fallback на UI-отчеты. Добавляется валидация качества данных, мониторинг источников, audit trail, нормализация данных, автоматическое восстановление после ошибок, безопасность, метрики свежести данных и полное тестовое покрытие для обеспечения enterprise-уровня надежности системы.
