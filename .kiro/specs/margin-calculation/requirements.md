# Requirements Document

## Introduction

Данная спецификация описывает требования к улучшению системы расчета маржинальности в ETL системе управления остатками товаров. Цель - создать полноценный расчет чистой прибыли с каждой продажи после вычета всех прямых расходов, включая себестоимость, комиссии маркетплейса и расходы на логистику.

## Requirements

### Requirement 1

**User Story:** Как аналитик, я хочу видеть точную маржинальность по каждому товару и дате, чтобы принимать обоснованные решения о ценообразовании и ассортименте.

#### Acceptance Criteria

1. WHEN система выполняет агрегацию ежедневных метрик THEN она SHALL рассчитывать полную маржинальность по формуле: Маржа = (Цена продажи) - (Себестоимость) - (Комиссии маркетплейса) - (Расходы на логистику)
2. WHEN в таблице fact_orders есть продажи за определенную дату THEN система SHALL объединять данные из fact_orders, dim_products и fact_transactions для получения всех компонентов расчета
3. WHEN система рассчитывает маржинальность THEN она SHALL сохранять результат в таблицу metrics_daily с полями profit_sum и margin_percent

### Requirement 2

**User Story:** Как разработчик, я хочу иметь детализированный расчет всех компонентов маржинальности, чтобы понимать структуру расходов и прибыли.

#### Acceptance Criteria

1. WHEN система обрабатывает транзакции THEN она SHALL корректно классифицировать типы расходов (комиссии, логистика, эквайринг)
2. WHEN система рассчитывает себестоимость THEN она SHALL использовать данные из поля cost_price таблицы dim_products
3. WHEN система агрегирует данные THEN она SHALL группировать по client_id и дате для получения итоговых метрик

### Requirement 3

**User Story:** Как системный администратор, я хочу иметь надежный и производительный процесс расчета маржинальности, чтобы система работала стабильно при больших объемах данных.

#### Acceptance Criteria

1. WHEN скрипт агрегации выполняется THEN он SHALL обрабатывать данные пакетами по датам для оптимизации производительности
2. WHEN происходит ошибка в процессе расчета THEN система SHALL логировать детальную информацию об ошибке и откатывать транзакцию
3. WHEN скрипт запускается повторно THEN он SHALL корректно обновлять существующие записи через ON DUPLICATE KEY UPDATE

### Requirement 4

**User Story:** Как бизнес-аналитик, я хочу видеть процент маржинальности в дополнение к абсолютным значениям, чтобы сравнивать эффективность разных товаров и периодов.

#### Acceptance Criteria

1. WHEN система рассчитывает прибыль THEN она SHALL также рассчитывать margin_percent как (profit_sum / revenue_sum) \* 100
2. WHEN выручка равна нулю THEN система SHALL устанавливать margin_percent в NULL для избежания деления на ноль
3. WHEN система сохраняет метрики THEN она SHALL включать как абсолютные значения (profit_sum), так и относительные (margin_percent)
