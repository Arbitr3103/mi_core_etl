# Requirements Document

## Introduction

Рефакторинг ETL-системы Ozon для получения достоверных данных об остатках товаров. Текущая система использует только отчет `warehouse/stock`, что не отражает реальное состояние товаров "В продаже". Необходимо перейти к двухкомпонентной системе сбора данных для обеспечения 100% соответствия данных в дашборде с личным кабинетом Ozon.

## Glossary

-   **ETL_System**: Система извлечения, трансформации и загрузки данных из Ozon API
-   **ProductETL**: Компонент ETL для обработки справочника товаров
-   **InventoryETL**: Компонент ETL для обработки остатков товаров
-   **Ozon_API**: API платформы Ozon для получения данных о товарах и остатках
-   **Dashboard**: Веб-интерфейс для отображения данных об остатках товаров
-   **Visibility_Status**: Статус видимости товара в системе Ozon (VISIBLE, ACTIVE, продаётся)
-   **Available_Stock**: Доступный остаток, рассчитываемый как (present - reserved)
-   **Stock_Status**: Комбинированная метрика статуса товара на основе видимости и остатков

## Requirements

### Requirement 1

**User Story:** Как менеджер склада, я хочу видеть в дашборде только те товары, которые действительно "В продаже" в Ozon, чтобы принимать корректные решения по управлению запасами.

#### Acceptance Criteria

1. WHEN ProductETL выполняется, THE ETL_System SHALL получать данные о видимости товаров из отчета `/v1/report/products/create`
2. WHEN InventoryETL выполняется, THE ETL_System SHALL получать количественные данные остатков из отчета `/v1/report/warehouse/stock`
3. WHEN данные обрабатываются, THE ETL_System SHALL вычислять Stock_Status как комбинацию Visibility_Status и Available_Stock
4. WHEN Dashboard отображает данные, THE ETL_System SHALL показывать только товары со статусом "В продаже"
5. WHEN менеджер сравнивает данные, THE Dashboard SHALL отображать количество активных товаров, соответствующее личному кабинету Ozon

### Requirement 2

**User Story:** Как разработчик системы, я хочу иметь модульную архитектуру ETL-процессов, чтобы каждый компонент отвечал за свою область данных и был легко поддерживаем.

#### Acceptance Criteria

1. WHEN ProductETL обрабатывает данные, THE ETL_System SHALL сохранять информацию о видимости товаров в поле visibility таблицы dim_products
2. WHEN InventoryETL обрабатывает данные, THE ETL_System SHALL сохранять количественные данные остатков в таблице inventory
3. WHEN представление v_detailed_inventory формируется, THE ETL_System SHALL объединять данные из обеих таблиц для расчета финального статуса
4. WHEN ETL-процессы запускаются, THE ETL_System SHALL выполнять ProductETL перед InventoryETL для обеспечения актуальности данных
5. WHERE требуется масштабирование, THE ETL_System SHALL позволять независимое изменение каждого компонента

### Requirement 3

**User Story:** Как администратор базы данных, я хочу иметь оптимизированную схему данных с правильными индексами, чтобы обеспечить быструю работу запросов к большим объемам данных.

#### Acceptance Criteria

1. WHEN схема базы данных обновляется, THE ETL_System SHALL добавить поле visibility в таблицу dim_products
2. WHEN индексы создаются, THE ETL_System SHALL создать индекс idx_dim_products_visibility для оптимизации запросов по видимости
3. WHEN представление v_detailed_inventory обновляется, THE ETL_System SHALL использовать эффективные JOIN операции между таблицами
4. WHEN API запрашивает данные, THE ETL_System SHALL обеспечивать время отклика менее 2 секунд для запросов к детализированным остаткам
5. WHERE выполняются массовые операции, THE ETL_System SHALL использовать оптимизированные стратегии загрузки данных

### Requirement 4

**User Story:** Как пользователь API, я хочу получать точные и актуальные данные через существующие эндпоинты, чтобы интеграции продолжали работать без изменений.

#### Acceptance Criteria

1. WHEN API эндпоинт `/api/inventory/detailed-stock` вызывается, THE ETL_System SHALL возвращать данные из обновленного представления v_detailed_inventory
2. WHEN клиент запрашивает фильтрацию, THE ETL_System SHALL поддерживать фильтрацию по новому полю stock_status
3. WHEN возвращаются данные, THE ETL_System SHALL исключать товары со статусом archived_or_hidden и out_of_stock по умолчанию
4. WHEN происходит ошибка, THE ETL_System SHALL возвращать информативные сообщения об ошибках с соответствующими HTTP кодами
5. WHERE требуется обратная совместимость, THE ETL_System SHALL сохранять существующий формат ответов API

### Requirement 5

**User Story:** Как DevOps инженер, я хочу иметь надежную систему планирования ETL-процессов с мониторингом, чтобы обеспечить стабильную работу системы.

#### Acceptance Criteria

1. WHEN планировщик запускает ETL-процессы, THE ETL_System SHALL выполнять ProductETL перед InventoryETL в правильной последовательности
2. WHEN ETL-процесс завершается с ошибкой, THE ETL_System SHALL логировать детальную информацию об ошибке
3. WHEN данные обновляются, THE ETL_System SHALL создавать метки времени последнего успешного обновления
4. WHEN система мониторинга проверяет статус, THE ETL_System SHALL предоставлять информацию о состоянии каждого компонента
5. WHERE происходит сбой, THE ETL_System SHALL поддерживать возможность повторного запуска отдельных компонентов

### Requirement 6

**User Story:** Как тестировщик системы, я хочу иметь возможность верификации корректности данных, чтобы убедиться в соответствии результатов с эталонными данными из Ozon.

#### Acceptance Criteria

1. WHEN тестирование выполняется, THE ETL_System SHALL предоставлять SQL-запросы для проверки количества активных товаров
2. WHEN сравнение проводится, THE ETL_System SHALL обеспечивать точное соответствие количества товаров с личным кабинетом Ozon
3. WHEN выбираются тестовые SKU, THE ETL_System SHALL позволять точечную проверку остатков и статусов конкретных товаров
4. WHEN данные валидируются, THE ETL_System SHALL предоставлять отчеты о расхождениях между источниками данных
5. WHERE требуется отладка, THE ETL_System SHALL сохранять промежуточные результаты трансформации данных
