# Implementation Plan

- [x] 1. Обновление схемы базы данных

  - Создать миграционный скрипт для обновления таблицы inventory_data
  - Добавить новые поля: warehouse_name, stock_type, quantity_present, quantity_reserved, last_sync_at
  - Создать таблицу sync_logs для отслеживания синхронизации
  - Добавить необходимые индексы для оптимизации запросов
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2_

- [x] 2. Исправление импортера остатков

  - [x] 2.1 Обновить InventorySyncService для работы с правильной таблицей

    - Изменить все запросы с `inventory` на `inventory_data`
    - Адаптировать структуру данных под новую схему БД
    - Добавить поддержку новых полей (warehouse_name, stock_type)
    - _Requirements: 1.1, 1.4_

  - [x] 2.2 Исправить методы получения данных с API

    - Обновить метод get_ozon_inventory() для корректного парсинга CSV отчетов
    - Исправить метод get_wb_inventory() для работы с актуальным API
    - Добавить обработку различных типов складов (FBO, FBS, realFBS)
    - _Requirements: 1.1, 1.2_

  - [x] 2.3 Добавить валидацию данных

    - Создать методы проверки корректности полученных данных
    - Добавить валидацию на отрицательные остатки и некорректные значения
    - Реализовать проверку соответствия товаров в БД
    - _Requirements: 4.1, 4.2, 4.3_

  - [x] 2.4 Написать unit тесты для импортера
    - Создать тесты для методов получения данных с API
    - Написать тесты валидации данных
    - Добавить тесты для методов записи в БД
    - _Requirements: 1.1, 1.2, 4.1_

- [x] 3. Создание системы логирования синхронизации

  - [x] 3.1 Реализовать класс SyncLogger

    - Создать методы для записи результатов синхронизации в sync_logs
    - Добавить логирование времени выполнения и количества обработанных записей
    - Реализовать запись ошибок и предупреждений
    - _Requirements: 2.1, 2.2, 2.3_

  - [x] 3.2 Добавить детальное логирование в импортер

    - Интегрировать SyncLogger в InventorySyncService
    - Добавить логирование каждого этапа синхронизации
    - Реализовать запись статистики обработки данных
    - _Requirements: 2.1, 2.2, 2.3_

  - [x] 3.3 Создать тесты для системы логирования
    - Написать unit тесты для SyncLogger
    - Добавить integration тесты для записи в sync_logs
    - Проверить корректность логирования ошибок
    - _Requirements: 2.1, 2.2_

- [x] 4. Реализация мониторинга и алертов

  - [x] 4.1 Создать класс SyncMonitor

    - Реализовать методы проверки актуальности данных
    - Добавить детекцию аномалий в данных остатков
    - Создать методы для генерации отчетов о синхронизации
    - _Requirements: 2.4, 4.4_

  - [x] 4.2 Добавить систему уведомлений

    - Реализовать отправку email уведомлений при критических ошибках
    - Добавить уведомления о длительном отсутствии синхронизации
    - Создать еженедельные отчеты о состоянии системы
    - _Requirements: 2.4, 4.4_

  - [x] 4.3 Написать тесты для мониторинга
    - Создать unit тесты для SyncMonitor
    - Добавить тесты для системы уведомлений
    - Проверить корректность детекции аномалий
    - _Requirements: 2.4, 4.4_

- [x] 5. Обработка ошибок и восстановление

  - [x] 5.1 Реализовать стратегии обработки ошибок API

    - Добавить retry логику с экспоненциальной задержкой
    - Реализовать обработку rate limits маркетплейсов
    - Создать fallback механизмы при недоступности API
    - _Requirements: 2.1, 2.2, 2.3_

  - [x] 5.2 Добавить механизмы восстановления данных

    - Реализовать принудительную пересинхронизацию
    - Добавить очистку поврежденных данных
    - Создать процедуры восстановления после сбоев
    - _Requirements: 5.1, 5.2, 5.3, 5.4_

  - [x] 5.3 Создать тесты для обработки ошибок
    - Написать тесты для различных типов ошибок API
    - Добавить тесты для механизмов восстановления
    - Проверить корректность retry логики
    - _Requirements: 2.1, 2.2, 5.1_

- [x] 6. Настройка автоматизации

  - [x] 6.1 Создать cron задачи для регулярной синхронизации

    - Настроить запуск синхронизации каждые 6 часов
    - Добавить отдельные задачи для Ozon и Wildberries
    - Создать задачу для еженедельной полной пересинхронизации
    - _Requirements: 3.1, 3.2, 3.3_

  - [x] 6.2 Добавить мониторинг выполнения cron задач

    - Реализовать проверку успешности выполнения задач
    - Добавить уведомления о пропущенных запусках
    - Создать dashboard для отслеживания расписания
    - _Requirements: 3.3, 3.4_

  - [x] 6.3 Протестировать автоматизацию
    - Проверить корректность выполнения cron задач
    - Добавить тесты для мониторинга расписания
    - Протестировать восстановление после сбоев
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 7. Создание API для управления синхронизацией

  - [x] 7.1 Реализовать REST API endpoints

    - Создать endpoint для запуска принудительной синхронизации
    - Добавить endpoint для получения статуса последней синхронизации
    - Реализовать endpoint для получения отчетов о синхронизации
    - _Requirements: 4.1, 4.2, 4.3_

  - [x] 7.2 Добавить веб-интерфейс для управления

    - Создать страницу с текущим статусом остатков
    - Добавить кнопки для запуска синхронизации
    - Реализовать отображение логов и ошибок
    - _Requirements: 3.4, 4.1, 4.2_

  - [x] 7.3 Написать API тесты
    - Создать integration тесты для всех endpoints
    - Добавить тесты для веб-интерфейса
    - Проверить безопасность API endpoints
    - _Requirements: 4.1, 4.2, 4.3_

- [x] 8. Оптимизация производительности

  - [x] 8.1 Оптимизировать запросы к базе данных

    - Добавить недостающие индексы для быстрого поиска
    - Оптимизировать UPSERT операции для больших объемов данных
    - Реализовать пакетную обработку записей
    - _Requirements: 1.3, 1.4_

  - [x] 8.2 Улучшить обработку API запросов

    - Добавить параллельную обработку данных с разных маркетплейсов
    - Реализовать кэширование неизменяемых данных
    - Оптимизировать размер батчей для API запросов
    - _Requirements: 1.1, 1.2_

  - [x] 8.3 Провести нагрузочное тестирование
    - Протестировать систему с большим объемом данных
    - Измерить время выполнения синхронизации
    - Проверить использование памяти и CPU
    - _Requirements: 1.1, 1.2, 1.3_

- [x] 9. Документация и развертывание

  - [x] 9.1 Создать документацию по настройке

    - Написать инструкции по установке и конфигурации
    - Добавить примеры настройки cron задач
    - Создать troubleshooting guide для типичных проблем
    - _Requirements: 2.4, 3.4_

  - [x] 9.2 Подготовить миграционные скрипты

    - Создать скрипты для безопасного обновления продакшн БД
    - Добавить rollback процедуры на случай проблем
    - Протестировать миграцию на копии продакшн данных
    - _Requirements: 1.1, 1.2, 5.1_

  - [x] 9.3 Развернуть систему в продакшн
    - Выполнить миграцию базы данных
    - Развернуть обновленный код импортера
    - Настроить cron задачи и мониторинг
    - Провести финальное тестирование работоспособности
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.3_

- [ ] 10. Исправление критических проблем после развертывания

  - [x] 10.1 Исправить парсинг данных Ozon API

    - Проанализировать структуру ответа API v4/product/info/stocks
    - Обновить метод обработки данных для корректного извлечения остатков
    - Добавить обработку различных типов складов (fbo, fbs, realFbs)
    - Протестировать с реальными данными API
    - _Requirements: 1.1, 1.2_

  - [x] 10.2 Исправить URL для Wildberries API

    - Заменить неработающий домен suppliers-api.wildberries.ru на statistics-api.wildberries.ru
    - Обновить все API endpoints для соответствия актуальной документации WB
    - Проверить корректность API ключей и методов авторизации
    - Протестировать подключение к обновленным endpoints
    - _Requirements: 1.2_

  - [x] 10.3 Провести полное тестирование исправлений
    - Запустить импортер с исправленными настройками
    - Проверить корректность получения и сохранения данных
    - Убедиться в работоспособности обеих интеграций (Ozon + WB)
    - Проверить логирование и мониторинг
    - _Requirements: 1.1, 1.2, 2.1, 2.2_
