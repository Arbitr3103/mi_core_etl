<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç Ozon API</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      .loading {
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ –¢–µ—Å—Ç Ozon Analytics API</h1>

      <div class="test-section">
        <h2>1. –¢–µ—Å—Ç Health Check</h2>
        <button onclick="testHealthCheck()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health Check</button>
        <div id="health-result"></div>
      </div>

      <div class="test-section">
        <h2>2. –¢–µ—Å—Ç Funnel Data</h2>
        <button onclick="testFunnelData()">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–æ—Ä–æ–Ω–∫–∏</button>
        <div id="funnel-result"></div>
      </div>

      <div class="test-section">
        <h2>3. –¢–µ—Å—Ç Demographics</h2>
        <button onclick="testDemographics()">
          –ü–æ–ª—É—á–∏—Ç—å –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        </button>
        <div id="demographics-result"></div>
      </div>

      <div class="test-section">
        <h2>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö</h2>
        <div id="structure-check"></div>
      </div>
    </div>

    <script>
      const API_BASE = "src/api/ozon-analytics.php";

      async function makeRequest(url, elementId) {
        const element = document.getElementById(elementId);
        element.innerHTML = '<p class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';

        try {
          const response = await fetch(url);
          const data = await response.json();

          let html = `<h3>–°—Ç–∞—Ç—É—Å: ${response.status}</h3>`;
          html += `<h4>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</h4>`;
          html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

          if (data.success) {
            element.className = "test-section success";
            html = `<p>‚úÖ –£—Å–ø–µ—à–Ω–æ!</p>` + html;
          } else {
            element.className = "test-section error";
            html =
              `<p>‚ùå –û—à–∏–±–∫–∞: ${data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}</p>` +
              html;
          }

          element.innerHTML = html;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è funnel data
          if (elementId === "funnel-result" && data.success && data.data) {
            checkDataStructure(data.data);
          }
        } catch (error) {
          element.className = "test-section error";
          element.innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</p>`;
        }
      }

      function testHealthCheck() {
        const url = `${API_BASE}?action=health`;
        makeRequest(url, "health-result");
      }

      function testFunnelData() {
        const dateFrom = "2024-01-01";
        const dateTo = "2024-01-31";
        const url = `${API_BASE}?action=funnel-data&date_from=${dateFrom}&date_to=${dateTo}`;
        makeRequest(url, "funnel-result");
      }

      function testDemographics() {
        const dateFrom = "2024-01-01";
        const dateTo = "2024-01-31";
        const url = `${API_BASE}?action=demographics&date_from=${dateFrom}&date_to=${dateTo}`;
        makeRequest(url, "demographics-result");
      }

      function checkDataStructure(data) {
        const structureElement = document.getElementById("structure-check");
        let html = "<h3>üîç –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:</h3>";

        if (!Array.isArray(data) || data.length === 0) {
          html +=
            '<p class="error">‚ùå –î–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º</p>';
          structureElement.innerHTML = html;
          return;
        }

        const firstRecord = data[0];
        const requiredFields = [
          "product_id",
          "views",
          "orders",
          "revenue",
          "conversion_overall",
        ];
        const missingFields = [];
        const presentFields = [];

        requiredFields.forEach((field) => {
          if (firstRecord.hasOwnProperty(field)) {
            presentFields.push(field);
          } else {
            missingFields.push(field);
          }
        });

        html += `<p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</strong> ${data.length}</p>`;
        html += `<p><strong>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è:</strong> ${presentFields.join(
          ", "
        )}</p>`;

        if (missingFields.length > 0) {
          html += `<p class="error"><strong>‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è:</strong> ${missingFields.join(
            ", "
          )}</p>`;
        } else {
          html += `<p class="success">‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>`;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        html += "<h4>–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:</h4>";
        html += "<ul>";
        html += `<li><strong>Product ID:</strong> ${
          firstRecord.product_id || "null"
        }</li>`;
        html += `<li><strong>Views:</strong> ${firstRecord.views || 0}</li>`;
        html += `<li><strong>Orders:</strong> ${firstRecord.orders || 0}</li>`;
        html += `<li><strong>Revenue:</strong> ${
          firstRecord.revenue || 0
        }</li>`;
        html += `<li><strong>Conversion:</strong> ${
          firstRecord.conversion_overall || 0
        }%</li>`;
        html += "</ul>";

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        if (firstRecord.debug_raw_response) {
          html += "<h4>üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞:</h4>";
          html += `<pre>${JSON.stringify(
            firstRecord.debug_raw_response,
            null,
            2
          ).substring(0, 500)}...</pre>`;
        }

        structureElement.innerHTML = html;
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º health check –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.onload = function () {
        testHealthCheck();
      };
    </script>
  </body>
</html>
