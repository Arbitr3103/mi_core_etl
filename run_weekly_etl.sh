#!/bin/bash

# ===================================================================
# ะะะะะะะะะฌะะซะ ETL ะกะะะะะข ะะะฏ CRON JOB
# ะะฐะฟััะบะฐะตััั ะบะฐะถะดัะน ะฟะพะฝะตะดะตะปัะฝะธะบ ะฒ 3:00
# ===================================================================

# ะะฐัััะพะนะบะธ
PROJECT_DIR="/path/to/mi_core_etl"  # ะะะะะะะขะ ะะ ะะะะะฌะะซะ ะะฃะขะฌ
LOG_DIR="$PROJECT_DIR/logs"
LOG_FILE="$LOG_DIR/weekly_etl_$(date +%Y%m%d_%H%M%S).log"

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ ะตัะปะธ ะฝะต ัััะตััะฒัะตั
mkdir -p "$LOG_DIR"

# ะคัะฝะบัะธั ะปะพะณะธัะพะฒะฐะฝะธั
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "๐ ะะฐะฟััะบ ะตะถะตะฝะตะดะตะปัะฝะพะณะพ ETL ะฟัะพัะตััะฐ"
log "๐ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $PROJECT_DIR"
log "๐ ะะพะณ ัะฐะนะป: $LOG_FILE"

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd "$PROJECT_DIR" || {
    log "โ ะะจะะะะ: ะะต ัะดะฐะปะพัั ะฟะตัะตะนัะธ ะฒ ะดะธัะตะบัะพัะธั $PROJECT_DIR"
    exit 1
}

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท ัะตะฟะพะทะธัะพัะธั
log "๐ฅ ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท Git ัะตะฟะพะทะธัะพัะธั..."
git pull origin main >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
    log "โ ะะพะด ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝ"
else
    log "โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะะต ัะดะฐะปะพัั ะพะฑะฝะพะฒะธัั ะบะพะด ะธะท Git"
fi

# ะะฐะฟััะบะฐะตะผ ETL ะฟัะพัะตัั ะทะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน
log "๐ ะะฐะฟััะบ ETL ะฟัะพัะตััะฐ Ozon ะทะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน..."
python3 main.py --source=ozon --last-7-days >> "$LOG_FILE" 2>&1

# ะัะพะฒะตััะตะผ ัะตะทัะปััะฐั ะฒัะฟะพะปะฝะตะฝะธั Ozon
if [ $? -eq 0 ]; then
    log "โ ETL ะฟัะพัะตัั Ozon ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ"
else
    log "โ ะะจะะะะ: ETL ะฟัะพัะตัั Ozon ะทะฐะฒะตััะธะปัั ั ะพัะธะฑะบะพะน"
fi

# ะะฐะฟััะบะฐะตะผ ETL ะฟัะพัะตัั Wildberries ะทะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน
log "๐ ะะฐะฟััะบ ETL ะฟัะพัะตััะฐ Wildberries ะทะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน..."
python3 main.py --source=wb --last-7-days >> "$LOG_FILE" 2>&1

# ะัะพะฒะตััะตะผ ัะตะทัะปััะฐั ะฒัะฟะพะปะฝะตะฝะธั Wildberries
if [ $? -eq 0 ]; then
    log "โ ETL ะฟัะพัะตัั Wildberries ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ"
else
    log "โ ะะจะะะะ: ETL ะฟัะพัะตัั Wildberries ะทะฐะฒะตััะธะปัั ั ะพัะธะฑะบะพะน"
fi

# ะะพะบะฐะทัะฒะฐะตะผ ััะฐัะธััะธะบั ะทะฐะณััะถะตะฝะฝัั ะดะฐะฝะฝัั
log "๐ ะะฐะฟััะบ ะฟัะพัะผะพััะฐ ััะฐัะธััะธะบะธ..."
python3 view_orders.py >> "$LOG_FILE" 2>&1

log "๐ ะะถะตะฝะตะดะตะปัะฝัะน ETL ะฟัะพัะตัั ะฟะพะปะฝะพัััั ะทะฐะฒะตััะตะฝ"
exit 0
