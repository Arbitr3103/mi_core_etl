<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Ozon Funnel Chart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="src/js/OzonFunnelChart.js"></script>
    <style>
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .chart-container {
        height: 500px;
        margin-bottom: 30px;
      }

      .test-controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üß™ Test Ozon Funnel Chart</h1>

      <div class="test-controls">
        <h5>Test Controls</h5>
        <div class="row g-3">
          <div class="col-md-3">
            <button class="btn btn-primary" onclick="loadSampleData()">
              üìä Load Sample Data
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-success" onclick="updateWithNewData()">
              üîÑ Update Data
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-warning" onclick="showError()">
              ‚ö†Ô∏è Show Error
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-info" onclick="exportChart()">
              üì§ Export Chart
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5>üîÑ Ozon Funnel Chart Test</h5>
        </div>
        <div class="card-body">
          <div id="testFunnelChart" class="chart-container">
            <!-- Chart will be rendered here -->
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">
          <h5>üìã Test Log</h5>
        </div>
        <div class="card-body">
          <div
            id="testLog"
            style="
              height: 200px;
              overflow-y: auto;
              background: #f8f9fa;
              padding: 10px;
              border-radius: 5px;
            "
          >
            <div class="text-muted">Test log will appear here...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let funnelChart = null;

      // Initialize the chart when page loads
      document.addEventListener("DOMContentLoaded", function () {
        log("Initializing Ozon Funnel Chart...");

        try {
          funnelChart = new OzonFunnelChart("testFunnelChart", {
            responsive: true,
            maintainAspectRatio: false,
            showConversions: true,
            animationDuration: 800,
          });

          log("‚úÖ Chart initialized successfully");

          // Listen for stage click events
          document
            .getElementById("testFunnelChart")
            .addEventListener("funnelStageClick", function (event) {
              log(
                `üñ±Ô∏è Stage clicked: ${event.detail.stage} (Index: ${event.detail.stageIndex})`
              );
            });

          // Listen for retry events
          document
            .getElementById("testFunnelChart")
            .addEventListener("retryLoad", function () {
              log("üîÑ Retry button clicked");
              loadSampleData();
            });
        } catch (error) {
          log("‚ùå Error initializing chart: " + error.message);
        }
      });

      function loadSampleData() {
        log("üìä Loading sample data...");

        const sampleData = {
          totals: {
            views: 15420,
            cart_additions: 2340,
            orders: 456,
            conversion_view_to_cart: 15.2,
            conversion_cart_to_order: 19.5,
            conversion_overall: 2.96,
          },
          daily: [
            {
              date: "2025-01-01",
              views: 1200,
              cart_additions: 180,
              orders: 35,
            },
            {
              date: "2025-01-02",
              views: 1350,
              cart_additions: 205,
              orders: 42,
            },
          ],
        };

        try {
          funnelChart.renderFunnel(sampleData);
          log("‚úÖ Sample data loaded successfully");
          log(
            `üìà Views: ${sampleData.totals.views.toLocaleString()}, Cart: ${sampleData.totals.cart_additions.toLocaleString()}, Orders: ${sampleData.totals.orders.toLocaleString()}`
          );
        } catch (error) {
          log("‚ùå Error loading sample data: " + error.message);
        }
      }

      function updateWithNewData() {
        log("üîÑ Updating with new data...");

        const newData = {
          totals: {
            views: Math.floor(Math.random() * 20000) + 10000,
            cart_additions: Math.floor(Math.random() * 3000) + 1500,
            orders: Math.floor(Math.random() * 600) + 300,
            conversion_view_to_cart: Math.random() * 20 + 10,
            conversion_cart_to_order: Math.random() * 25 + 15,
            conversion_overall: Math.random() * 5 + 2,
          },
        };

        // Calculate conversions
        newData.totals.conversion_view_to_cart =
          (newData.totals.cart_additions / newData.totals.views) * 100;
        newData.totals.conversion_cart_to_order =
          (newData.totals.orders / newData.totals.cart_additions) * 100;
        newData.totals.conversion_overall =
          (newData.totals.orders / newData.totals.views) * 100;

        try {
          funnelChart.updateData(newData);
          log("‚úÖ Data updated successfully");
          log(
            `üìà New Values - Views: ${newData.totals.views.toLocaleString()}, Cart: ${newData.totals.cart_additions.toLocaleString()}, Orders: ${newData.totals.orders.toLocaleString()}`
          );
        } catch (error) {
          log("‚ùå Error updating data: " + error.message);
        }
      }

      function showError() {
        log("‚ö†Ô∏è Showing error state...");

        try {
          funnelChart.showError("–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏");
          log("‚úÖ Error state displayed");
        } catch (error) {
          log("‚ùå Error showing error state: " + error.message);
        }
      }

      function exportChart() {
        log("üì§ Exporting chart...");

        try {
          const imageData = funnelChart.exportAsImage("png");
          if (imageData) {
            // Create download link
            const link = document.createElement("a");
            link.download = "ozon_funnel_chart_test.png";
            link.href = imageData;
            link.click();

            log("‚úÖ Chart exported successfully");
          } else {
            log("‚ùå Failed to export chart");
          }
        } catch (error) {
          log("‚ùå Error exporting chart: " + error.message);
        }
      }

      function log(message) {
        const logContainer = document.getElementById("testLog");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }
    </script>
  </body>
</html>
