#!/bin/bash

# –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
# –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö

set -e

echo "üîß –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤..."
echo "============================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -d "/var/www/mi_core_api" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/mi_core_api –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/mi_core_api

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é API —Ñ–∞–π–ª–∞
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é API —Ñ–∞–π–ª–∞..."
if [ -f "api/inventory-analytics.php" ]; then
    cp api/inventory-analytics.php "api/inventory-analytics.php.backup.$(date +%Y%m%d_%H%M%S)"
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
else
    echo "‚ö†Ô∏è  –§–∞–π–ª api/inventory-analytics.php –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∞–≤–∞ vladimir –¥–ª—è git pull
echo "üîê –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é vladimir..."
sudo chown -R vladimir:vladimir .

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì• –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git pull origin main

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (www-data)
echo "üîê –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (www-data)..."
sudo chown -R www-data:www-data .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
sudo chmod 644 api/inventory-analytics.php

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PHP
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PHP —Ñ–∞–π–ª–∞..."
if php -l api/inventory-analytics.php > /dev/null 2>&1; then
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å PHP –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PHP!"
    php -l api/inventory-analytics.php
    exit 1
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º API endpoint
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º API endpoint —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π..."
if curl -s -f -o /dev/null "http://localhost/api/inventory-analytics.php?action=dashboard&active_only=1"; then
    echo "‚úÖ API endpoint –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å API endpoint (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
fi

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "================================"
echo ""
echo "üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
echo "  ‚Ä¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö"
echo "  ‚Ä¢ –ó–∞–º–µ–Ω–µ–Ω–æ {$activeFilter} –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é —Å—Ç—Ä–æ–∫"
echo "  ‚Ä¢ –¢–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
echo ""
echo "üß™ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
echo "  ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ http://your-server/test_dashboard.html"
echo "  ‚Ä¢ –î–∞—à–±–æ—Ä–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å ~51 –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–≤–∞—Ä –≤–º–µ—Å—Ç–æ 446"
echo "  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è"
echo ""
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"