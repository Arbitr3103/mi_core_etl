# Тесты дашборда складских остатков

Этот документ описывает комплексную систему тестирования для дашборда складских остатков, созданную в рамках задачи 6 спецификации.

## Обзор

Система тестирования включает в себя три основных блока тестов:

1. **Тесты API endpoints** - проверка всех API функций
2. **Тесты классификации товаров** - проверка логики классификации по уровням остатков
3. **Интеграционные тесты** - проверка полного цикла работы дашборда

## Структура файлов

```
tests/
├── test_inventory_dashboard_api.php      # Тесты API endpoints
├── test_product_classification.php       # Тесты классификации товаров
├── test_dashboard_integration.php        # Интеграционные тесты
├── run_inventory_dashboard_tests.php     # Главный тест-раннер
└── README_INVENTORY_DASHBOARD_TESTS.md   # Этот файл

run_dashboard_tests.sh                    # Скрипт запуска тестов
```

## Покрытие требований

Тесты покрывают все требования из спецификации:

### Требование 1.1 - Отображение реальных данных

- ✅ Проверка использования таблицы `inventory_data`
- ✅ Проверка корректности SQL запросов
- ✅ Валидация структуры ответа API

### Требование 1.2 - Правильные названия колонок

- ✅ Проверка использования `current_stock` вместо `stock_quantity`
- ✅ Проверка корректности полей в запросах

### Требования 2.1, 2.2, 2.3 - Классификация товаров

- ✅ **Критические товары** (≤5 единиц): тестирование граничных значений
- ✅ **Низкие остатки** (6-20 единиц): проверка диапазона
- ✅ **Избыток** (>100 единиц): валидация классификации
- ✅ **Нормальные остатки** (21-100 единиц): проверка промежуточных значений

### Требования 3.1, 3.2 - Названия товаров

- ✅ Получение названий из `dim_products`
- ✅ Fallback для отсутствующих названий ("Товар [SKU]")
- ✅ Обработка кросс-референсов SKU

### Требования 4.1, 4.2, 4.3 - Рекомендации

- ✅ Срочное пополнение для критических товаров
- ✅ Проведение акций для товаров с избытком
- ✅ Плановое пополнение для товаров с низкими остатками

### Требования 5.1, 5.2, 5.3 - Группировка по складам

- ✅ Агрегация остатков по складам
- ✅ Сводка по складам
- ✅ Отображение информации о складах

## Запуск тестов

### Быстрый запуск

```bash
./run_dashboard_tests.sh
```

### Запуск отдельных блоков тестов

#### API endpoints

```bash
php tests/test_inventory_dashboard_api.php
```

#### Классификация товаров

```bash
php tests/test_product_classification.php
```

#### Интеграционные тесты

```bash
php tests/test_dashboard_integration.php
```

#### Полный набор тестов

```bash
php tests/run_inventory_dashboard_tests.php
```

## Описание тестов

### 1. Тесты API Endpoints (`test_inventory_dashboard_api.php`)

#### `testDashboardEndpoint()`

- Проверяет основной endpoint `/api/inventory-analytics.php?action=dashboard`
- Валидирует структуру ответа
- Проверяет наличие всех обязательных полей
- Тестирует корректность типов данных

#### `testCriticalProductsEndpoint()`

- Тестирует endpoint для критических товаров
- Проверяет что все товары имеют остаток ≤5 единиц
- Валидирует структуру данных о товарах

#### `testOverstockProductsEndpoint()`

- Проверяет endpoint для товаров с избытком
- Тестирует что все товары имеют остаток >100 единиц
- Проверяет наличие поля `excess_stock`

#### `testWarehouseSummaryEndpoint()`

- Тестирует сводку по складам
- Проверяет агрегацию данных
- Валидирует структуру данных по складам

#### `testRecommendationsEndpoint()`

- Проверяет генерацию рекомендаций
- Тестирует типы рекомендаций (urgent, optimization, planning)
- Валидирует структуру рекомендаций

#### `testErrorHandling()`

- Тестирует обработку ошибок
- Проверяет валидацию параметров
- Тестирует коды ошибок

### 2. Тесты классификации (`test_product_classification.php`)

#### `testCriticalStockClassification()`

- Тестирует классификацию критических товаров (≤5)
- Проверяет граничные значения (0, 1, 3, 5)
- Валидирует корректность логики

#### `testLowStockClassification()`

- Тестирует классификацию товаров с низким остатком (6-20)
- Проверяет границы диапазона
- Тестирует промежуточные значения

#### `testOverstockClassification()`

- Тестирует классификацию товаров с избытком (>100)
- Проверяет различные уровни избытка
- Валидирует логику классификации

#### `testBoundaryValues()`

- Специальные тесты граничных значений
- Проверяет переходы между категориями
- Тестирует критические точки (5/6, 20/21, 100/101)

#### `testDatabaseClassification()`

- Тестирует классификацию с реальными данными из БД
- Проверяет SQL логику классификации
- Валидирует консистентность

#### `testClassificationPerformance()`

- Тестирует производительность классификации
- Проверяет время выполнения на 1000 товарах
- Валидирует что время < 100мс

### 3. Интеграционные тесты (`test_dashboard_integration.php`)

#### `testFullDashboardLoad()`

- Тестирует полный цикл загрузки дашборда
- Проверяет интеграцию API и данных
- Валидирует консистентность данных

#### `testProductNameFallback()`

- Тестирует обработку товаров без названий
- Проверяет fallback логику ("Товар [SKU]")
- Валидирует требование 3.2

#### `testWarehouseGrouping()`

- Тестирует группировку по складам
- Проверяет агрегацию данных
- Валидирует требования 5.1-5.3

#### `testRecommendationsGeneration()`

- Тестирует генерацию рекомендаций
- Проверяет все типы рекомендаций
- Валидирует требования 4.1-4.3

#### `testDashboardPerformance()`

- Тестирует производительность дашборда
- Проверяет время загрузки всех endpoints
- Валидирует что время < 3 секунд

#### `testErrorHandlingIntegration()`

- Тестирует обработку ошибок в интеграции
- Проверяет различные сценарии ошибок
- Валидирует корректность ответов

#### `testDataConsistency()`

- Тестирует консистентность данных между endpoints
- Проверяет соответствие счетчиков
- Валидирует целостность данных

## Тестовые данные

Каждый блок тестов создает свои тестовые данные с префиксами:

- `TEST-*` - для API тестов
- `TEST-CLASS-*` - для тестов классификации
- `INT-TEST-*` - для интеграционных тестов

Все тестовые данные автоматически очищаются после выполнения тестов.

## Отчеты

### Консольный вывод

Тесты выводят подробную информацию в консоль:

- Статус каждого теста (✅ PASSED / ❌ FAILED)
- Детали ошибок при провале тестов
- Статистику выполнения
- Время выполнения

### JSON отчеты

Детальные отчеты сохраняются в `logs/inventory_dashboard_test_report_*.json`:

```json
{
  "timestamp": "2025-01-13 15:30:00",
  "overall_success": true,
  "execution_time_seconds": 2.45,
  "test_results": {
    "api_endpoints": "PASSED",
    "product_classification": "PASSED",
    "dashboard_integration": "PASSED"
  },
  "requirements_tested": [
    "1.1",
    "1.2",
    "2.1",
    "2.2",
    "2.3",
    "3.1",
    "3.2",
    "4.1",
    "4.2",
    "4.3",
    "5.1",
    "5.2",
    "5.3"
  ],
  "test_environment": {
    "php_version": "8.1.0",
    "server_software": "CLI",
    "database_available": true
  }
}
```

## Требования к окружению

### Обязательные компоненты

- PHP 7.4+ (рекомендуется 8.0+)
- MySQL/MariaDB с таблицами `inventory_data` и `dim_products`
- Веб-сервер (для интеграционных тестов)
- Права на запись в директорию `logs/`

### Конфигурация базы данных

Убедитесь что в `config.php` настроено подключение к БД и функция `getDatabaseConnection()` работает корректно.

### Структура таблиц

Таблицы должны иметь следующие поля:

#### `inventory_data`

- `sku` - артикул товара
- `warehouse_name` - название склада
- `current_stock` - текущий остаток
- `available_stock` - доступный остаток
- `reserved_stock` - зарезервированный остаток
- `last_sync_at` - время последней синхронизации

#### `dim_products`

- `sku_ozon` - SKU для Ozon
- `sku_wb` - SKU для Wildberries
- `product_name` - название товара
- `name` - альтернативное название
- `cost_price` - себестоимость

## Устранение неполадок

### Ошибка подключения к БД

```
❌ Подключение к базе данных: FAILED
```

**Решение:** Проверьте настройки в `config.php` и доступность БД.

### Отсутствуют таблицы

```
❌ Таблица inventory_data: НЕ НАЙДЕНА
```

**Решение:** Создайте необходимые таблицы или проверьте их названия.

### Ошибки API тестов

```
❌ Не удалось выполнить запрос к API
```

**Решение:** Убедитесь что веб-сервер запущен и API файл доступен.

### Проблемы с правами

```
❌ Права на запись в logs: НЕТ ДОСТУПА
```

**Решение:** Установите права на запись для директории `logs/`.

## Расширение тестов

Для добавления новых тестов:

1. Создайте новый метод в соответствующем классе
2. Добавьте вызов метода в `runAllTests()`
3. Следуйте соглашениям именования: `test*`
4. Используйте методы `assertEquals()`, `assertTrue()` для проверок
5. Обрабатывайте исключения и записывайте результаты в `$this->test_results`

## Заключение

Эта система тестирования обеспечивает полное покрытие функциональности дашборда складских остатков и соответствие всем требованиям спецификации. Регулярный запуск тестов поможет поддерживать качество и стабильность системы.
