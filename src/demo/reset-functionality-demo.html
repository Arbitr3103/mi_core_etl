<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–î–µ–º–æ: –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- –°—Ç–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞ -->
    <link href="../css/country-filter.css" rel="stylesheet" />

    <style>
      body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      .demo-header {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
      }

      .demo-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .scenario-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
      }

      .scenario-card.active {
        border-color: #0d6efd;
        background: #e7f3ff;
      }

      .filter-state {
        background: #e9ecef;
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin: 0.5rem 0;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
      }

      .filter-state.before {
        border-left: 4px solid #ffc107;
      }

      .filter-state.after {
        border-left: 4px solid #28a745;
      }

      .reset-button {
        margin: 0.25rem;
      }

      .test-log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
      }

      .log-entry {
        margin-bottom: 0.25rem;
        padding: 0.25rem;
        border-radius: 0.25rem;
      }

      .log-entry.success {
        background: #d4edda;
        color: #155724;
      }

      .log-entry.error {
        background: #f8d7da;
        color: #721c24;
      }

      .log-entry.info {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .status-success {
        background-color: #28a745;
      }
      .status-warning {
        background-color: #ffc107;
      }
      .status-error {
        background-color: #dc3545;
      }

      .performance-meter {
        background: #e9ecef;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 0.5rem 0;
      }

      .performance-bar {
        height: 100%;
        background: linear-gradient(
          90deg,
          #28a745 0%,
          #ffc107 70%,
          #dc3545 100%
        );
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="demo-header">
      <div class="container">
        <h1 class="mb-0">üîÑ –î–µ–º–æ: –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤</h1>
        <p class="mb-0 mt-2">
          –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–µ
          –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
        </p>
      </div>
    </div>

    <div class="container">
      <!-- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="demo-section">
        <h2>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤</h2>

        <div class="row">
          <!-- –§–∏–ª—å—Ç—Ä—ã -->
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="demo-brand" class="form-label">–ú–∞—Ä–∫–∞:</label>
                <select id="demo-brand" class="form-select">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É</option>
                  <option value="1">BMW</option>
                  <option value="2">Mercedes-Benz</option>
                  <option value="3">Audi</option>
                  <option value="4">Toyota</option>
                </select>
              </div>

              <div class="col-md-3 mb-3">
                <label for="demo-model" class="form-label">–ú–æ–¥–µ–ª—å:</label>
                <select id="demo-model" class="form-select">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
                  <option value="1">X5</option>
                  <option value="2">3 Series</option>
                  <option value="3">E-Class</option>
                </select>
              </div>

              <div class="col-md-3 mb-3">
                <div id="country-filter-demo"></div>
              </div>

              <div class="col-md-3 mb-3">
                <label for="demo-year" class="form-label">–ì–æ–¥:</label>
                <select id="demo-year" class="form-select">
                  <option value="">–õ—é–±–æ–π –≥–æ–¥</option>
                  <option value="2023">2023</option>
                  <option value="2022">2022</option>
                  <option value="2021">2021</option>
                </select>
              </div>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ -->
          <div class="col-md-4">
            <label class="form-label">–î–µ–π—Å—Ç–≤–∏—è —Å–±—Ä–æ—Å–∞:</label>
            <div class="d-grid gap-2">
              <button
                id="reset-country-only"
                class="btn btn-warning reset-button"
                onclick="resetCountryOnly()"
              >
                üåç –°–±—Ä–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω—É
              </button>
              <button
                id="reset-all-filters"
                class="btn btn-danger reset-button"
                onclick="resetAllFilters()"
              >
                üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
              </button>
              <button
                id="reset-with-reload"
                class="btn btn-info reset-button"
                onclick="resetWithReload()"
              >
                ‚Üª –°–±—Ä–æ—Å–∏—Ç—å —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
              </button>
            </div>
          </div>
        </div>

        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
        <div class="filter-state" id="current-state">
          –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...
        </div>
      </div>

      <!-- –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ -->
      <div class="demo-section">
        <h2>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="scenario-card" onclick="runScenario('basic-reset')">
              <h5>1. –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å</h5>
              <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</p>
              <small class="text-muted"
                >–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</small
              >
            </div>

            <div class="scenario-card" onclick="runScenario('partial-reset')">
              <h5>2. –ß–∞—Å—Ç–∏—á–Ω—ã–π —Å–±—Ä–æ—Å</h5>
              <p>–°–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ</p>
              <small class="text-muted">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–±—Ä–æ—Å</small>
            </div>

            <div class="scenario-card" onclick="runScenario('multiple-resets')">
              <h5>3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–±—Ä–æ—Å—ã</h5>
              <p>–ë—ã—Å—Ç—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–±—Ä–æ—Å—ã</p>
              <small class="text-muted">–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</small>
            </div>
          </div>

          <div class="col-md-6">
            <div
              class="scenario-card"
              onclick="runScenario('reset-with-errors')"
            >
              <h5>4. –°–±—Ä–æ—Å —Å –æ—à–∏–±–∫–∞–º–∏</h5>
              <p>–°–±—Ä–æ—Å –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ—à–∏–±–æ–∫ API</p>
              <small class="text-muted">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫</small>
            </div>

            <div
              class="scenario-card"
              onclick="runScenario('performance-test')"
            >
              <h5>5. –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h5>
              <p>–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–±—Ä–æ—Å–∞</p>
              <small class="text-muted">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</small>
            </div>

            <div
              class="scenario-card"
              onclick="runScenario('integration-test')"
            >
              <h5>6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç</h5>
              <p>–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º</p>
              <small class="text-muted">–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</small>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-success" onclick="runAllScenarios()">
            ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
          </button>
          <button class="btn btn-secondary" onclick="clearTestLog()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
          </button>
        </div>
      </div>

      <!-- –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <div class="demo-section">
        <h2>üìã –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="test-log" class="test-log">
          <div class="text-muted">
            –õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
      <div class="demo-section">
        <h2>‚ö° –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h2>
        <div class="row">
          <div class="col-md-4">
            <h6>–í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ —Å—Ç—Ä–∞–Ω—ã:</h6>
            <div class="performance-meter">
              <div
                id="country-reset-bar"
                class="performance-bar"
                style="width: 0%"
              ></div>
            </div>
            <small id="country-reset-time">0 –º—Å</small>
          </div>
          <div class="col-md-4">
            <h6>–í—Ä–µ–º—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞:</h6>
            <div class="performance-meter">
              <div
                id="full-reset-bar"
                class="performance-bar"
                style="width: 0%"
              ></div>
            </div>
            <small id="full-reset-time">0 –º—Å</small>
          </div>
          <div class="col-md-4">
            <h6>–û–±—â–∏–µ —Ç–µ—Å—Ç—ã:</h6>
            <div>
              <span class="status-indicator status-success"></span>
              <span id="tests-passed">0</span> –ø—Ä–æ–π–¥–µ–Ω–æ
            </div>
            <div>
              <span class="status-indicator status-error"></span>
              <span id="tests-failed">0</span> –ø—Ä–æ–≤–∞–ª–µ–Ω–æ
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/CountryFilter.js"></script>
    <script src="../js/FilterManager.js"></script>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      let filterManager;
      let testLog;
      let testStats = {
        passed: 0,
        failed: 0,
        countryResetTime: 0,
        fullResetTime: 0,
      };

      // –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      const mockData = {
        countries: [
          { id: 1, name: "–ì–µ—Ä–º–∞–Ω–∏—è" },
          { id: 2, name: "–Ø–ø–æ–Ω–∏—è" },
          { id: 3, name: "–°–®–ê" },
        ],
        countriesByBrand: {
          1: [{ id: 1, name: "–ì–µ—Ä–º–∞–Ω–∏—è" }], // BMW
          2: [{ id: 1, name: "–ì–µ—Ä–º–∞–Ω–∏—è" }], // Mercedes
          3: [{ id: 1, name: "–ì–µ—Ä–º–∞–Ω–∏—è" }], // Audi
          4: [{ id: 2, name: "–Ø–ø–æ–Ω–∏—è" }], // Toyota
        },
      };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener("DOMContentLoaded", function () {
        testLog = document.getElementById("test-log");
        initializeDemo();
        setupMockAPI();
      });

      /**
       * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–º–æ
       */
      function initializeDemo() {
        logTest("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–º–æ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤", "info");

        // –°–æ–∑–¥–∞–Ω–∏–µ FilterManager
        filterManager = new FilterManager({
          apiBaseUrl: "/api",
          onFiltersChange: onFiltersChange,
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ
        filterManager.initCountryFilter("country-filter-demo");

        // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document
          .getElementById("demo-brand")
          .addEventListener("change", onBrandChange);
        document
          .getElementById("demo-model")
          .addEventListener("change", onModelChange);
        document
          .getElementById("demo-year")
          .addEventListener("change", onYearChange);

        logTest("‚úÖ –î–µ–º–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ", "success");
        updateStateDisplay();
      }

      /**
       * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–∫–æ–≤–æ–≥–æ API
       */
      function setupMockAPI() {
        const originalFetch = window.fetch;

        window.fetch = async function (url) {
          // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å–µ—Ç–∏
          await new Promise((resolve) => setTimeout(resolve, 100));

          if (url.includes("/api/countries.php")) {
            return {
              ok: true,
              json: () =>
                Promise.resolve({
                  success: true,
                  data: mockData.countries,
                }),
            };
          }

          if (url.includes("/api/countries-by-brand.php")) {
            const brandId = new URL(
              url,
              window.location.origin
            ).searchParams.get("brand_id");
            return {
              ok: true,
              json: () =>
                Promise.resolve({
                  success: true,
                  data: mockData.countriesByBrand[brandId] || [],
                }),
            };
          }

          if (url.includes("/api/products-filter.php")) {
            return {
              ok: true,
              json: () =>
                Promise.resolve({
                  success: true,
                  data: [],
                  pagination: { total: 0 },
                }),
            };
          }

          return originalFetch.apply(this, arguments);
        };
      }

      /**
       * –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
       */
      function onBrandChange(event) {
        filterManager.onBrandChange(event.target.value);
      }

      function onModelChange(event) {
        filterManager.onModelChange(event.target.value);
      }

      function onYearChange(event) {
        filterManager.onYearChange(event.target.value);
      }

      function onFiltersChange(result, filters) {
        updateStateDisplay();
      }

      /**
       * –§—É–Ω–∫—Ü–∏–∏ —Å–±—Ä–æ—Å–∞
       */
      async function resetCountryOnly() {
        logTest("üåç –°–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ", "info");

        const startTime = performance.now();
        await filterManager.resetCountryFilter();
        const endTime = performance.now();

        testStats.countryResetTime = endTime - startTime;
        updatePerformanceDisplay();

        logTest(
          `‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ —Å–±—Ä–æ—à–µ–Ω –∑–∞ ${testStats.countryResetTime.toFixed(
            2
          )} –º—Å`,
          "success"
        );
        updateStateDisplay();
      }

      async function resetAllFilters() {
        logTest("üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤", "info");

        const startTime = performance.now();
        await filterManager.resetAllFilters();
        const endTime = performance.now();

        testStats.fullResetTime = endTime - startTime;
        updatePerformanceDisplay();

        logTest(
          `‚úÖ –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã –∑–∞ ${testStats.fullResetTime.toFixed(2)} –º—Å`,
          "success"
        );
        updateStateDisplay();
      }

      async function resetWithReload() {
        logTest("‚Üª –°–±—Ä–æ—Å —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π —Å—Ç—Ä–∞–Ω", "info");

        await filterManager.resetCountryFilter(true);

        logTest("‚úÖ –°–±—Ä–æ—Å —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω", "success");
        updateStateDisplay();
      }

      /**
       * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
       */
      function updateStateDisplay() {
        const currentFilters = filterManager.getCurrentFilters();
        const activeFilters = filterManager.getActiveFilters();

        const stateElement = document.getElementById("current-state");

        const stateInfo = {
          "–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã": currentFilters,
          "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã": activeFilters,
          "–ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ": filterManager.hasActiveFilters(),
          "–í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞":
            filterManager.countryFilter?.getSelectedCountry() || null,
        };

        stateElement.innerHTML = Object.entries(stateInfo)
          .map(
            ([key, value]) =>
              `<strong>${key}:</strong> ${JSON.stringify(value)}`
          )
          .join("<br>");
      }

      /**
       * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
       */
      function updatePerformanceDisplay() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ —Å—Ç—Ä–∞–Ω—ã
        const countryBar = document.getElementById("country-reset-bar");
        const countryTime = document.getElementById("country-reset-time");
        const countryPercent = Math.min(
          (testStats.countryResetTime / 50) * 100,
          100
        );
        countryBar.style.width = `${countryPercent}%`;
        countryTime.textContent = `${testStats.countryResetTime.toFixed(2)} –º—Å`;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
        const fullBar = document.getElementById("full-reset-bar");
        const fullTime = document.getElementById("full-reset-time");
        const fullPercent = Math.min(
          (testStats.fullResetTime / 100) * 100,
          100
        );
        fullBar.style.width = `${fullPercent}%`;
        fullTime.textContent = `${testStats.fullResetTime.toFixed(2)} –º—Å`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ—Å—Ç–æ–≤
        document.getElementById("tests-passed").textContent = testStats.passed;
        document.getElementById("tests-failed").textContent = testStats.failed;
      }

      /**
       * –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
       */
      async function runScenario(scenarioName) {
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
        document.querySelectorAll(".scenario-card").forEach((card) => {
          card.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        logTest(`üß™ –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è: ${scenarioName}`, "info");

        try {
          switch (scenarioName) {
            case "basic-reset":
              await testBasicReset();
              break;
            case "partial-reset":
              await testPartialReset();
              break;
            case "multiple-resets":
              await testMultipleResets();
              break;
            case "reset-with-errors":
              await testResetWithErrors();
              break;
            case "performance-test":
              await testPerformance();
              break;
            case "integration-test":
              await testIntegration();
              break;
          }
          testStats.passed++;
          logTest(`‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π ${scenarioName} –ø—Ä–æ–π–¥–µ–Ω`, "success");
        } catch (error) {
          testStats.failed++;
          logTest(
            `‚ùå –°—Ü–µ–Ω–∞—Ä–∏–π ${scenarioName} –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`,
            "error"
          );
        }

        updatePerformanceDisplay();
      }

      async function testBasicReset() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        filterManager.setFilter("brand_id", "1");
        filterManager.setFilter("model_id", "1");
        filterManager.setFilter("country_id", "1");

        if (!filterManager.hasActiveFilters()) {
          throw new Error("–§–∏–ª—å—Ç—Ä—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å");
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ
        await filterManager.resetAllFilters();

        if (filterManager.hasActiveFilters()) {
          throw new Error("–§–∏–ª—å—Ç—Ä—ã –Ω–µ —Å–±—Ä–æ—Å–∏–ª–∏—Å—å");
        }

        logTest("  ‚úì –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "success");
      }

      async function testPartialReset() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        filterManager.setFilter("brand_id", "1");
        filterManager.setFilter("country_id", "1");

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω—É
        await filterManager.resetCountryFilter();

        if (filterManager.getFilter("brand_id") !== "1") {
          throw new Error("–ú–∞—Ä–∫–∞ —Å–±—Ä–æ—Å–∏–ª–∞—Å—å –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —Å–±—Ä–æ—Å–µ");
        }

        if (filterManager.getFilter("country_id") !== null) {
          throw new Error("–°—Ç—Ä–∞–Ω–∞ –Ω–µ —Å–±—Ä–æ—Å–∏–ª–∞—Å—å");
        }

        logTest("  ‚úì –ß–∞—Å—Ç–∏—á–Ω—ã–π —Å–±—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "success");
      }

      async function testMultipleResets() {
        // –ë—ã—Å—Ç—Ä—ã–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–±—Ä–æ—Å—ã
        const promises = [
          filterManager.resetAllFilters(),
          filterManager.resetCountryFilter(),
          filterManager.resetAllFilters(),
        ];

        await Promise.all(promises);

        if (filterManager.hasActiveFilters()) {
          throw new Error("–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–±—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
        }

        logTest("  ‚úì –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–±—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "success");
      }

      async function testResetWithErrors() {
        // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—à–∏–±–∫—É API
        const originalFetch = window.fetch;
        window.fetch = () => Promise.reject(new Error("Network error"));

        try {
          await filterManager.resetAllFilters();
          // –°–±—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
          logTest("  ‚úì –°–±—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API", "success");
        } finally {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º fetch
          window.fetch = originalFetch;
        }
      }

      async function testPerformance() {
        const iterations = 10;
        let totalTime = 0;

        for (let i = 0; i < iterations; i++) {
          filterManager.setFilter("country_id", "1");

          const startTime = performance.now();
          await filterManager.resetCountryFilter();
          const endTime = performance.now();

          totalTime += endTime - startTime;
        }

        const averageTime = totalTime / iterations;

        if (averageTime > 50) {
          throw new Error(
            `–°–±—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π: ${averageTime.toFixed(2)} –º—Å`
          );
        }

        logTest(
          `  ‚úì –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞: ${averageTime.toFixed(2)} –º—Å`,
          "success"
        );
      }

      async function testIntegration() {
        // –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ -> —Å–±—Ä–æ—Å -> –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

        // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        await filterManager.onBrandChange("1");
        filterManager.onCountryChange("1");

        // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ
        await filterManager.resetAllFilters();

        // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        await filterManager.onBrandChange("2");
        filterManager.onCountryChange("2");

        const activeFilters = filterManager.getActiveFilters();

        if (
          activeFilters.brand_id !== "2" ||
          activeFilters.country_id !== "2"
        ) {
          throw new Error("–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω");
        }

        logTest("  ‚úì –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω", "success");
      }

      async function runAllScenarios() {
        logTest("üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤", "info");

        const scenarios = [
          "basic-reset",
          "partial-reset",
          "multiple-resets",
          "reset-with-errors",
          "performance-test",
          "integration-test",
        ];

        for (const scenario of scenarios) {
          try {
            await runScenario(scenario);
            await new Promise((resolve) => setTimeout(resolve, 500)); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
          } catch (error) {
            logTest(
              `‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ${scenario}: ${error.message}`,
              "error"
            );
          }
        }

        logTest("üèÅ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã", "info");
      }

      /**
       * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
       */
      function logTest(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;

        if (
          testLog.querySelector(".text-muted") &&
          testLog.children.length === 1
        ) {
          testLog.innerHTML = "";
        }

        testLog.appendChild(logEntry);
        testLog.scrollTop = testLog.scrollHeight;
      }

      function clearTestLog() {
        testLog.innerHTML = '<div class="text-muted">–õ–æ–≥ –æ—á–∏—â–µ–Ω...</div>';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        testStats = {
          passed: 0,
          failed: 0,
          countryResetTime: 0,
          fullResetTime: 0,
        };

        updatePerformanceDisplay();
      }
    </script>
  </body>
</html>
