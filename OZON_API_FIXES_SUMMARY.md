# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º Ozon API

## –ü—Ä–æ–±–ª–µ–º–∞

–î–∞—à–±–æ—Ä–¥ –Ω–µ –ø–æ–ª—É—á–∞–ª —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø–æ—Ç–æ–º—É —á—Ç–æ –º–µ—Ç–æ–¥ `processFunnelData()` –±—ã–ª –Ω–∞–ø–∏—Å–∞–Ω –ø–æ–¥ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É API, –∞ –Ω–µ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Ozon API.

## –†–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Ozon API

```json
{
  "data": [
    {
      "dimensions": [{ "id": "1750881567", "name": "–¢–æ–≤–∞—Ä" }],
      "metrics": [4312240, 8945, 15000] // [revenue, ordered_units, hits_view_pdp]
    }
  ],
  "totals": [4312240, 8945, 15000]
}
```

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `processFunnelData()`

**–§–∞–π–ª:** `src/classes/OzonAnalyticsAPI.php`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `product_id` –∏–∑ `dimensions[0]['id']`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏–∑ –º–∞—Å—Å–∏–≤–∞ `metrics`:
  - `metrics[0]` = revenue (–≤—ã—Ä—É—á–∫–∞)
  - `metrics[1]` = ordered_units (–∑–∞–∫–∞–∑—ã)
  - `metrics[2]` = hits_view_pdp (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞)
- ‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω—ã (40% –æ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `revenue` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 2. –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

**–§–∞–π–ª:** `src/classes/OzonAnalyticsAPI.php`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `revenue` –≤ SQL –∑–∞–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –ø–æ–ª–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### 3. –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–§–∞–π–ª:** `migrations/add_revenue_to_funnel_data.sql`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `revenue DECIMAL(15,2)` –≤ —Ç–∞–±–ª–∏—Ü—É `ozon_funnel_data`
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—è

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```bash
# –ï—Å–ª–∏ PHP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
php apply_revenue_migration.php

# –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –Ω–∞–ø—Ä—è–º—É—é
mysql -u mi_core_user -p mi_core_db < migrations/add_revenue_to_funnel_data.sql
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (–µ—Å–ª–∏ PHP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
php test_complete_funnel_flow.php
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—à–±–æ—Ä–¥

–û—Ç–∫—Ä–æ–π—Ç–µ –¥–∞—à–±–æ—Ä–¥ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–µ—Ç–æ–¥ `processFunnelData()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```php
[
    'date_from' => '2024-01-01',
    'date_to' => '2024-01-31',
    'product_id' => '1750881567',
    'campaign_id' => null,
    'views' => 15000,           // –∏–∑ metrics[2]
    'cart_additions' => 6000,   // —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ (40% –æ—Ç views)
    'orders' => 8945,           // –∏–∑ metrics[1]
    'revenue' => 4312240.50,    // –∏–∑ metrics[0]
    'conversion_view_to_cart' => 40.00,
    'conversion_cart_to_order' => 149.08,
    'conversion_overall' => 59.63,
    'cached_at' => '2024-01-31 12:00:00'
]
```

## –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã

–°–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

- `test_fixed_funnel_data.php` - —Ç–µ—Å—Ç –º–µ—Ç–æ–¥–∞ processFunnelData
- `test_complete_funnel_flow.php` - –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- `test_api_endpoint.php` - —Ç–µ—Å—Ç API endpoint
- `apply_revenue_migration.php` - —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é**

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–¥. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –¥–∞—à–±–æ—Ä–¥–∞.
