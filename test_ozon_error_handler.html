<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Тест Ozon Error Handler</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Ozon Error Handler CSS -->
    <link href="src/css/ozon-error-handler.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container mt-4">
      <h1>Тест Ozon Error Handler</h1>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Тестирование ошибок</h5>
            </div>
            <div class="card-body">
              <button class="btn btn-primary me-2" onclick="testAuthError()">
                Ошибка аутентификации
              </button>
              <button class="btn btn-warning me-2" onclick="testRateLimit()">
                Превышение лимита
              </button>
              <button class="btn btn-danger me-2" onclick="testNetworkError()">
                Сетевая ошибка
              </button>
              <button class="btn btn-info me-2" onclick="testTimeout()">
                Таймаут
              </button>
              <button class="btn btn-secondary" onclick="testNoData()">
                Нет данных
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Тестирование загрузки</h5>
            </div>
            <div class="card-body">
              <button
                class="btn btn-success me-2"
                onclick="testFunnelLoading()"
              >
                Загрузка воронки
              </button>
              <button
                class="btn btn-info me-2"
                onclick="testDemographicsLoading()"
              >
                Загрузка демографии
              </button>
              <button
                class="btn btn-primary me-2"
                onclick="testExportLoading()"
              >
                Загрузка экспорта
              </button>
              <button
                class="btn btn-outline-success"
                onclick="testSuccessfulLoad()"
              >
                Успешная загрузка
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Контейнеры для тестирования -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6>Воронка продаж</h6>
            </div>
            <div class="card-body">
              <div id="ozonFunnelChart" style="height: 300px">
                <!-- Здесь будет отображаться воронка или состояния ошибок -->
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6>Демография</h6>
            </div>
            <div class="card-body">
              <div id="ozonDemographics" style="height: 300px">
                <!-- Здесь будет отображаться демография или состояния ошибок -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h6>Кампании</h6>
              <button
                id="exportAnalyticsData"
                class="btn btn-outline-primary btn-sm"
              >
                <i class="fas fa-download me-2"></i>
                Экспорт данных
              </button>
            </div>
            <div class="card-body">
              <div id="ozonCampaigns" style="height: 200px">
                <!-- Здесь будут отображаться кампании или состояния ошибок -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Контейнер для общих ошибок -->
      <div id="ozonAnalyticsView" class="mt-4">
        <div class="ozon-analytics-container">
          <!-- Основной контент аналитики -->
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Подключаем наши скрипты -->
    <script src="src/js/MarketplaceErrorHandler.js"></script>
    <script src="src/js/OzonErrorHandler.js"></script>

    <script>
      // Инициализация обработчика ошибок
      let ozonErrorHandler;

      document.addEventListener("DOMContentLoaded", function () {
        ozonErrorHandler = new OzonErrorHandler({
          showToasts: true,
          autoHideToasts: true,
          toastDuration: 5000,
          ozonOptions: {
            maxRetries: 2,
            retryDelay: 1000,
            fallbackDataEnabled: true,
            gracefulDegradation: true,
            loadingTimeout: 5000,
          },
        });

        console.log("Ozon Error Handler инициализирован");
      });

      // Функции тестирования ошибок
      function testAuthError() {
        const error = new OzonAPIError(
          "Invalid API credentials",
          "AUTHENTICATION_ERROR",
          "authentication",
          { statusCode: 401 }
        );

        ozonErrorHandler.handleOzonAPIError(
          error,
          "/test/auth",
          "test_auth_123"
        );
      }

      function testRateLimit() {
        const error = new OzonAPIError(
          "Rate limit exceeded",
          "RATE_LIMIT_EXCEEDED",
          "rate_limit",
          { statusCode: 429, retryAfter: 60 }
        );

        ozonErrorHandler.handleOzonAPIError(
          error,
          "/test/rate-limit",
          "test_rate_123"
        );
      }

      function testNetworkError() {
        const error = new Error("Failed to fetch");
        ozonErrorHandler.handleOzonAPIError(
          error,
          "/test/network",
          "test_network_123"
        );
      }

      function testTimeout() {
        const error = new Error("Request timeout");
        error.name = "AbortError";
        ozonErrorHandler.handleOzonAPIError(
          error,
          "/test/timeout",
          "test_timeout_123"
        );
      }

      function testNoData() {
        const error = new OzonAPIError(
          "No data available for the selected period",
          "NO_DATA",
          "no_data",
          { period: "2024-01-01 to 2024-01-31" }
        );

        ozonErrorHandler.handleOzonAPIError(
          error,
          "/test/no-data",
          "test_nodata_123"
        );
      }

      // Функции тестирования загрузки
      function testFunnelLoading() {
        const requestId = "test_funnel_" + Date.now();
        ozonErrorHandler.showFunnelLoadingState(requestId);

        // Симулируем загрузку
        setTimeout(() => {
          ozonErrorHandler.hideLoadingState(requestId);

          // Показываем успешные данные
          document.getElementById("ozonFunnelChart").innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                        <h5 class="text-success">Данные воронки загружены</h5>
                        <p class="text-muted">Просмотры: 1,234 | В корзину: 456 | Заказы: 123</p>
                    </div>
                `;
        }, 3000);
      }

      function testDemographicsLoading() {
        const requestId = "test_demographics_" + Date.now();
        ozonErrorHandler.showDemographicsLoadingState(requestId);

        setTimeout(() => {
          ozonErrorHandler.hideLoadingState(requestId);

          document.getElementById("ozonDemographics").innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-users fa-3x text-info mb-3"></i>
                        <h5 class="text-info">Демографические данные загружены</h5>
                        <p class="text-muted">Возраст: 25-45 | Пол: 60% Ж, 40% М</p>
                    </div>
                `;
        }, 2000);
      }

      function testExportLoading() {
        const requestId = "test_export_" + Date.now();
        ozonErrorHandler.showExportLoadingState(requestId);

        setTimeout(() => {
          ozonErrorHandler.hideLoadingState(requestId);
          ozonErrorHandler.showToast({
            type: "success",
            title: "Экспорт завершен",
            message: "Файл готов к скачиванию",
          });
        }, 4000);
      }

      function testSuccessfulLoad() {
        ozonErrorHandler.showToast({
          type: "success",
          title: "Успешно",
          message: "Все данные загружены успешно",
          duration: 3000,
        });
      }

      // Обработчик кнопки экспорта
      document
        .getElementById("exportAnalyticsData")
        .addEventListener("click", function () {
          testExportLoading();
        });
    </script>
  </body>
</html>
