<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîß –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f7;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
      }
      .btn {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn-danger {
        background: #dc3545;
      }
      .btn-success {
        background: #28a745;
      }
      .result {
        margin: 10px 0;
        padding: 15px;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .loading {
        background: #d1ecf1;
        color: #0c5460;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 12px;
      }
      .step {
        background: #e9ecef;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞</h1>

      <div class="step">
        <h3>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
        <button
          class="btn"
          onclick="runCheck('check_db_direct.php', 'db-result')"
        >
          üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
        </button>
        <div id="db-result"></div>
      </div>

      <div class="step">
        <h3>–®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü</h3>
        <button
          class="btn btn-danger"
          onclick="runCheck('fix_missing_table.php', 'fix-result')"
        >
          üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
        </button>
        <div id="fix-result"></div>
      </div>

      <div class="step">
        <h3>–®–∞–≥ 3: –¢–µ—Å—Ç API</h3>
        <button
          class="btn"
          onclick="runCheck('test_api_direct.php', 'api-result')"
        >
          üß™ –¢–µ—Å—Ç API
        </button>
        <div id="api-result"></div>
      </div>

      <div class="step">
        <h3>–®–∞–≥ 4: –¢–µ—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞</h3>
        <button class="btn" onclick="testDashboard()">
          üìä –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
        </button>
        <button
          class="btn btn-success"
          onclick="window.open('test_dashboard.html', '_blank')"
        >
          üöÄ –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥
        </button>
        <div id="dashboard-result"></div>
      </div>

      <div class="step">
        <h3>–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏</h3>
        <a
          href="api/inventory-analytics.php?action=dashboard"
          target="_blank"
          class="btn"
          >üîó API –Ω–∞–ø—Ä—è–º—É—é</a
        >
        <a
          href="replenishment_adapter_fixed.php?action=recommendations"
          target="_blank"
          class="btn"
          >üîó API —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</a
        >
      </div>
    </div>

    <script>
      async function runCheck(scriptUrl, resultId) {
        const resultDiv = document.getElementById(resultId);
        resultDiv.innerHTML =
          '<div class="result loading">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</div>';

        try {
          const response = await fetch(scriptUrl);
          const text = await response.text();

          resultDiv.innerHTML = `
                    <div class="result success">
                        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
                        <pre>${text}</pre>
                    </div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>–û—à–∏–±–∫–∞:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      async function testDashboard() {
        const resultDiv = document.getElementById("dashboard-result");
        resultDiv.innerHTML =
          '<div class="result loading">–¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–∞—à–±–æ—Ä–¥ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä...</div>';

        try {
          const response = await fetch(
            "api/inventory-analytics.php?action=dashboard"
          );
          const data = await response.json();

          if (data.status === "success") {
            const stats = data.data;
            resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ –î–∞—à–±–æ—Ä–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç!</h4>
                            <p>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏: <strong>${
                              stats.critical_stock_count || 0
                            }</strong></p>
                            <p>–ù–∏–∑–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏: <strong>${
                              stats.low_stock_count || 0
                            }</strong></p>
                            <p>–ò–∑–±—ã—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤: <strong>${
                              stats.overstock_count || 0
                            }</strong></p>
                            <p>–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏: <strong>${
                              stats.normal_count || 0
                            }</strong></p>
                        </div>
                    `;
          } else {
            resultDiv.innerHTML = `
                        <div class="result error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞:</h4>
                            <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${
                              data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
                            }</p>
                            <p><strong>–î–µ—Ç–∞–ª–∏:</strong> ${
                              data.details || "–ù–µ—Ç"
                            }</p>
                        </div>
                    `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ë–î –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.onload = function () {
        runCheck("check_db_direct.php", "db-result");
      };
    </script>
  </body>
</html>
