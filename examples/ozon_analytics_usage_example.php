<?php
/**
 * –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞ OzonAnalyticsAPI
 * 
 * –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
 * –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö Ozon
 */

require_once '../src/classes/OzonAnalyticsAPI.php';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
$clientId = $_ENV['OZON_CLIENT_ID'] ?? 'your_client_id_here';
$apiKey = $_ENV['OZON_API_KEY'] ?? 'your_api_key_here';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
$dbHost = $_ENV['DB_HOST'] ?? 'localhost';
$dbName = $_ENV['DB_NAME'] ?? 'mi_core_db';
$dbUser = $_ENV['DB_USER'] ?? 'your_db_user';
$dbPassword = $_ENV['DB_PASSWORD'] ?? 'your_db_password';

echo "üìä –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø OzonAnalyticsAPI\n";
echo str_repeat("=", 50) . "\n\n";

try {
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    $pdo = null;
    try {
        $pdo = new PDO(
            "mysql:host=$dbHost;dbname=$dbName;charset=utf8mb4",
            $dbUser,
            $dbPassword,
            [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
            ]
        );
        echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n";
    } catch (PDOException $e) {
        echo "‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: " . $e->getMessage() . "\n";
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ API
    $ozonAPI = new OzonAnalyticsAPI($clientId, $apiKey, $pdo);
    echo "‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä OzonAnalyticsAPI —Å–æ–∑–¥–∞–Ω\n\n";
    
    // 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    echo "1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API:\n";
    $connectionTest = $ozonAPI->testConnection();
    
    if ($connectionTest['success']) {
        echo "‚úÖ " . $connectionTest['message'] . "\n";
        echo "   –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: " . ($connectionTest['token_received'] ? '–î–∞' : '–ù–µ—Ç') . "\n";
        echo "   –ò—Å—Ç–µ–∫–∞–µ—Ç: " . $connectionTest['token_expiry'] . "\n";
    } else {
        echo "‚ùå " . $connectionTest['message'] . "\n";
        echo "   –ö–æ–¥ –æ—à–∏–±–∫–∏: " . $connectionTest['error_code'] . "\n";
        echo "   –¢–∏–ø –æ—à–∏–±–∫–∏: " . $connectionTest['error_type'] . "\n";
        
        // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        echo "\n‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...\n";
    }
    
    echo "\n" . str_repeat("-", 50) . "\n";
    
    // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂
    echo "2Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂:\n";
    
    $dateFrom = date('Y-m-d', strtotime('-30 days'));
    $dateTo = date('Y-m-d');
    
    echo "–ü–µ—Ä–∏–æ–¥: $dateFrom - $dateTo\n";
    
    try {
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        $funnelData = $ozonAPI->getFunnelData($dateFrom, $dateTo, [
            'product_id' => '123456789',  // –ü—Ä–∏–º–µ—Ä ID —Ç–æ–≤–∞—Ä–∞
            'campaign_id' => 'camp_001',  // –ü—Ä–∏–º–µ—Ä ID –∫–∞–º–ø–∞–Ω–∏–∏
            'use_cache' => true           // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
        ]);
        
        echo "‚úÖ –î–∞–Ω–Ω—ã–µ –≤–æ—Ä–æ–Ω–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã (" . count($funnelData) . " –∑–∞–ø–∏—Å–µ–π)\n";
        
        if (!empty($funnelData)) {
            $sample = $funnelData[0];
            echo "   –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:\n";
            echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: " . number_format($sample['views']) . "\n";
            echo "   - –î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É: " . number_format($sample['cart_additions']) . "\n";
            echo "   - –ó–∞–∫–∞–∑—ã: " . number_format($sample['orders']) . "\n";
            echo "   - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä—ã->–∫–æ—Ä–∑–∏–Ω–∞: " . $sample['conversion_view_to_cart'] . "%\n";
            echo "   - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∫–æ—Ä–∑–∏–Ω–∞->–∑–∞–∫–∞–∑: " . $sample['conversion_cart_to_order'] . "%\n";
            echo "   - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –æ–±—â–∞—è: " . $sample['conversion_overall'] . "%\n";
            echo "   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–æ: " . $sample['cached_at'] . "\n";
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        echo "\n   üìä –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n";
        $aggregated = $ozonAPI->getAggregatedFunnelData($dateFrom, $dateTo, [
            'product_id' => '123456789'
        ]);
        
        echo "   - –í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: " . number_format($aggregated['total_views']) . "\n";
        echo "   - –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É: " . number_format($aggregated['total_cart_additions']) . "\n";
        echo "   - –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: " . number_format($aggregated['total_orders']) . "\n";
        echo "   - –°—Ä–µ–¥–Ω—è—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è: " . $aggregated['avg_conversion_overall'] . "%\n";
        echo "   - –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è: " . $aggregated['calculated_conversion_overall'] . "%\n";
        
    } catch (OzonAPIException $e) {
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–æ—Ä–æ–Ω–∫–∏: " . $e->getMessage() . "\n";
        echo "   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: " . $e->getRecommendation() . "\n";
    }
    
    echo "\n" . str_repeat("-", 50) . "\n";
    
    // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    echo "3Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:\n";
    
    try {
        $demographicsData = $ozonAPI->getDemographics($dateFrom, $dateTo);
        
        echo "‚úÖ –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã (" . count($demographicsData) . " –∑–∞–ø–∏—Å–µ–π)\n";
        
        if (!empty($demographicsData)) {
            $sample = $demographicsData[0];
            echo "   –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:\n";
            echo "   - –í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞: " . ($sample['age_group'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
            echo "   - –ü–æ–ª: " . ($sample['gender'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
            echo "   - –†–µ–≥–∏–æ–Ω: " . ($sample['region'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
            echo "   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤: " . $sample['orders_count'] . "\n";
            echo "   - –í—ã—Ä—É—á–∫–∞: " . number_format($sample['revenue'], 2) . " —Ä—É–±.\n";
        }
        
    } catch (OzonAPIException $e) {
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: " . $e->getMessage() . "\n";
        echo "   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: " . $e->getRecommendation() . "\n";
    }
    
    echo "\n" . str_repeat("-", 50) . "\n";
    
    // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
    echo "4Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π:\n";
    
    try {
        $campaignData = $ozonAPI->getCampaignData($dateFrom, $dateTo);
        
        echo "‚úÖ –î–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–π –ø–æ–ª—É—á–µ–Ω—ã (" . count($campaignData) . " –∑–∞–ø–∏—Å–µ–π)\n";
        
        if (!empty($campaignData)) {
            $sample = $campaignData[0];
            echo "   –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:\n";
            echo "   - ID –∫–∞–º–ø–∞–Ω–∏–∏: " . ($sample['campaign_id'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
            echo "   - –ù–∞–∑–≤–∞–Ω–∏–µ: " . ($sample['campaign_name'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ') . "\n";
            echo "   - –ü–æ–∫–∞–∑—ã: " . number_format($sample['impressions']) . "\n";
            echo "   - –ö–ª–∏–∫–∏: " . number_format($sample['clicks']) . "\n";
            echo "   - –†–∞—Å—Ö–æ–¥—ã: " . number_format($sample['spend'], 2) . " —Ä—É–±.\n";
            echo "   - CTR: " . $sample['ctr'] . "%\n";
            echo "   - ROAS: " . $sample['roas'] . "\n";
        }
        
    } catch (OzonAPIException $e) {
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: " . $e->getMessage() . "\n";
        echo "   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: " . $e->getRecommendation() . "\n";
    }
    
    echo "\n" . str_repeat("-", 50) . "\n";
    
    // 5. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    echo "5Ô∏è‚É£ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:\n";
    
    try {
        // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
        $jsonData = $ozonAPI->exportData('funnel', 'json', [
            'date_from' => $dateFrom,
            'date_to' => $dateTo
        ]);
        
        echo "‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON (" . strlen($jsonData) . " —Å–∏–º–≤–æ–ª–æ–≤)\n";
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        $csvFile = $ozonAPI->exportData('funnel', 'csv', [
            'date_from' => $dateFrom,
            'date_to' => $dateTo
        ]);
        
        echo "‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV: " . basename($csvFile) . "\n";
        
    } catch (Exception $e) {
        echo "‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: " . $e->getMessage() . "\n";
    }
    
    echo "\n" . str_repeat("-", 50) . "\n";
    
    // 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API
    echo "6Ô∏è‚É£ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API:\n";
    
    $stats = $ozonAPI->getApiStats();
    echo "Client ID: " . $stats['client_id'] . "\n";
    echo "–¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω: " . ($stats['token_valid'] ? '–î–∞' : '–ù–µ—Ç') . "\n";
    echo "–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞: " . ($stats['token_expiry'] ?? '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ') . "\n";
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: " . ($stats['last_request_time'] ?? '–ù–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è') . "\n";
    
} catch (Exception $e) {
    echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
    
    if ($e instanceof OzonAPIException) {
        echo "–¢–∏–ø –æ—à–∏–±–∫–∏: " . $e->getErrorType() . "\n";
        echo "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è: " . ($e->isCritical() ? '–î–∞' : '–ù–µ—Ç') . "\n";
        echo "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: " . $e->getRecommendation() . "\n";
    }
}

echo "\n" . str_repeat("=", 50) . "\n";
echo "üéØ –ü–†–ò–ú–ï–† –ó–ê–í–ï–†–®–ï–ù\n";
echo "\n–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:\n";
echo "1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ OZON_CLIENT_ID –∏ OZON_API_KEY\n";
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n";
echo "3. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ª–æ–≥–∏–∫–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n";
echo "4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤\n";
echo str_repeat("=", 50) . "\n";

?>