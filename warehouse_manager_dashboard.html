<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ —Å–∫–ª–∞–¥–æ–≤ - –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .header h1 {
        color: #2c3e50;
        font-size: 28px;
        margin-bottom: 5px;
      }

      .subtitle {
        color: #7f8c8d;
        font-size: 14px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .filters {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 12px;
      }

      select,
      input {
        padding: 8px 12px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 14px;
        min-width: 150px;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .summary-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .summary-card .number {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .summary-card .label {
        color: #7f8c8d;
        font-size: 12px;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .panel-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e1e8ed;
        font-weight: 600;
        color: #2c3e50;
      }

      .panel-content {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
      }

      .detailed-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        background: #2c3e50;
        color: white;
        padding: 15px 20px;
        font-weight: 600;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        position: sticky;
        top: 0;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .stock-level {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .stock-high {
        background: #d4edda;
        color: #155724;
      }
      .stock-medium {
        background: #fff3cd;
        color: #856404;
      }
      .stock-low {
        background: #f8d7da;
        color: #721c24;
      }
      .stock-zero {
        background: #f1f3f4;
        color: #5f6368;
      }

      .warehouse-card {
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
      }

      .warehouse-card:hover {
        border-color: #667eea;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
      }

      .warehouse-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .warehouse-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #7f8c8d;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .filter-row {
          flex-direction: column;
          align-items: stretch;
        }

        .summary-cards {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1>üìä –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ —Å–∫–ª–∞–¥–æ–≤</h1>
        <div class="subtitle">
          –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ —Å–∫–ª–∞–¥–∞–º ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ:
          <span id="lastUpdate">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label>–°–∫–ª–∞–¥</label>
            <select id="warehouseFilter">
              <option value="">–í—Å–µ —Å–∫–ª–∞–¥—ã</option>
            </select>
          </div>
          <div class="filter-group">
            <label>–¢–æ–≤–∞—Ä</label>
            <select id="productFilter">
              <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
            </select>
          </div>
          <div class="filter-group">
            <label>–£—Ä–æ–≤–µ–Ω—å –æ—Å—Ç–∞—Ç–∫–æ–≤</label>
            <select id="stockLevelFilter">
              <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π (>50)</option>
              <option value="medium">–°—Ä–µ–¥–Ω–∏–π (10-50)</option>
              <option value="low">–ù–∏–∑–∫–∏–π (1-10)</option>
              <option value="zero">–ù—É–ª–µ–≤–æ–π (0)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>–ü–æ–∏—Å–∫</label>
            <input
              type="text"
              id="searchFilter"
              placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            />
          </div>
          <button class="btn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button
            class="btn"
            onclick="resetFilters()"
            style="background: #6c757d"
          >
            –°–±—Ä–æ—Å–∏—Ç—å
          </button>
        </div>
      </div>

      <!-- –°–≤–æ–¥–∫–∞ -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="number" id="totalWarehouses">-</div>
          <div class="label">–°–∫–ª–∞–¥–æ–≤</div>
        </div>
        <div class="summary-card">
          <div class="number" id="totalProducts">-</div>
          <div class="label">–¢–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class="summary-card">
          <div class="number" id="totalStock">-</div>
          <div class="label">–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</div>
        </div>
        <div class="summary-card">
          <div class="number" id="lowStockItems">-</div>
          <div class="label">–¢—Ä–µ–±—É—é—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        </div>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="main-content">
        <!-- –¢–æ–ø —Å–∫–ª–∞–¥–æ–≤ -->
        <div class="panel">
          <div class="panel-header">üè™ –°–∫–ª–∞–¥—ã –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º</div>
          <div class="panel-content" id="warehousesPanel">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
          </div>
        </div>

        <!-- –¢–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è -->
        <div class="panel">
          <div class="panel-header">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
          <div class="panel-content" id="attentionPanel">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
          </div>
        </div>
      </div>

      <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
      <div class="detailed-table">
        <div class="table-header">
          üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ —Å–∫–ª–∞–¥–∞–º
        </div>
        <div style="overflow-x: auto">
          <table>
            <thead>
              <tr>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–°–∫–ª–∞–¥</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                <th>–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</th>
                <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody id="detailedTableBody">
              <tr>
                <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let allData = [];
      let filteredData = [];

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      async function loadData() {
        try {
          const response = await fetch("/warehouse_manager_api.php");
          const data = await response.json();

          if (data.success) {
            allData = data.data.inventory || [];
            filteredData = [...allData];

            updateSummary(data.data.summary);
            populateFilters();
            renderWarehouses();
            renderAttentionItems();
            renderDetailedTable();

            document.getElementById("lastUpdate").textContent =
              new Date().toLocaleString("ru-RU");
          } else {
            showError(
              "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " +
                (data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
            );
          }
        } catch (error) {
          showError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: " + error.message);
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
      function updateSummary(summary) {
        document.getElementById("totalWarehouses").textContent =
          summary.totalWarehouses || 0;
        document.getElementById("totalProducts").textContent =
          summary.totalProducts || 0;
        document.getElementById("totalStock").textContent = (
          summary.totalStock || 0
        ).toLocaleString("ru-RU");
        document.getElementById("lowStockItems").textContent =
          summary.lowStockItems || 0;
      }

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function populateFilters() {
        const warehouses = [
          ...new Set(allData.map((item) => item.warehouse_name)),
        ].sort();
        const products = [
          ...new Set(allData.map((item) => item.product_name)),
        ].sort();

        const warehouseSelect = document.getElementById("warehouseFilter");
        const productSelect = document.getElementById("productFilter");

        warehouseSelect.innerHTML = '<option value="">–í—Å–µ —Å–∫–ª–∞–¥—ã</option>';
        productSelect.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>';

        warehouses.forEach((warehouse) => {
          warehouseSelect.innerHTML += `<option value="${warehouse}">${warehouse}</option>`;
        });

        products.forEach((product) => {
          productSelect.innerHTML += `<option value="${product}">${product}</option>`;
        });
      }

      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function applyFilters() {
        const warehouseFilter =
          document.getElementById("warehouseFilter").value;
        const productFilter = document.getElementById("productFilter").value;
        const stockLevelFilter =
          document.getElementById("stockLevelFilter").value;
        const searchFilter = document
          .getElementById("searchFilter")
          .value.toLowerCase();

        filteredData = allData.filter((item) => {
          // –§–∏–ª—å—Ç—Ä –ø–æ —Å–∫–ª–∞–¥—É
          if (warehouseFilter && item.warehouse_name !== warehouseFilter)
            return false;

          // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É
          if (productFilter && item.product_name !== productFilter)
            return false;

          // –§–∏–ª—å—Ç—Ä –ø–æ —É—Ä–æ–≤–Ω—é –æ—Å—Ç–∞—Ç–∫–æ–≤
          if (stockLevelFilter) {
            const stock = parseInt(item.quantity_present) || 0;
            switch (stockLevelFilter) {
              case "high":
                if (stock <= 50) return false;
                break;
              case "medium":
                if (stock < 10 || stock > 50) return false;
                break;
              case "low":
                if (stock < 1 || stock >= 10) return false;
                break;
              case "zero":
                if (stock > 0) return false;
                break;
            }
          }

          // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
          if (
            searchFilter &&
            !item.product_name.toLowerCase().includes(searchFilter)
          )
            return false;

          return true;
        });

        renderWarehouses();
        renderAttentionItems();
        renderDetailedTable();
      }

      // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
      function resetFilters() {
        document.getElementById("warehouseFilter").value = "";
        document.getElementById("productFilter").value = "";
        document.getElementById("stockLevelFilter").value = "";
        document.getElementById("searchFilter").value = "";

        filteredData = [...allData];
        renderWarehouses();
        renderAttentionItems();
        renderDetailedTable();
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤
      function renderWarehouses() {
        const warehouseStats = {};

        filteredData.forEach((item) => {
          if (!warehouseStats[item.warehouse_name]) {
            warehouseStats[item.warehouse_name] = {
              totalStock: 0,
              totalItems: 0,
              lowStockItems: 0,
            };
          }

          const stock = parseInt(item.quantity_present) || 0;
          warehouseStats[item.warehouse_name].totalStock += stock;
          warehouseStats[item.warehouse_name].totalItems++;

          if (stock < 10) {
            warehouseStats[item.warehouse_name].lowStockItems++;
          }
        });

        const sortedWarehouses = Object.entries(warehouseStats).sort(
          ([, a], [, b]) => b.totalStock - a.totalStock
        );

        const html = sortedWarehouses
          .map(
            ([name, stats]) => `
                <div class="warehouse-card">
                    <div class="warehouse-name">${name}</div>
                    <div class="warehouse-stats">
                        <span>–û—Å—Ç–∞—Ç–æ–∫: ${stats.totalStock.toLocaleString(
                          "ru-RU"
                        )}</span>
                        <span>–ü–æ–∑–∏—Ü–∏–π: ${stats.totalItems}</span>
                        <span>–¢—Ä–µ–±—É—é—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${stats.lowStockItems}</span>
                    </div>
                </div>
            `
          )
          .join("");

        document.getElementById("warehousesPanel").innerHTML =
          html || '<div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–Ω–∏–º–∞–Ω–∏—è
      function renderAttentionItems() {
        const attentionItems = filteredData
          .filter((item) => (parseInt(item.quantity_present) || 0) < 10)
          .sort(
            (a, b) =>
              (parseInt(a.quantity_present) || 0) -
              (parseInt(b.quantity_present) || 0)
          )
          .slice(0, 10);

        const html = attentionItems
          .map((item) => {
            const stock = parseInt(item.quantity_present) || 0;
            const stockClass =
              stock === 0
                ? "stock-zero"
                : stock < 5
                ? "stock-low"
                : "stock-medium";

            return `
                    <div class="warehouse-card">
                        <div class="warehouse-name">${item.product_name}</div>
                        <div class="warehouse-stats">
                            <span>${item.warehouse_name}</span>
                            <span class="stock-level ${stockClass}">–û—Å—Ç–∞—Ç–æ–∫: ${stock}</span>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("attentionPanel").innerHTML =
          html || '<div class="loading">–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–æ—Ä–º–µ</div>';
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
      function renderDetailedTable() {
        const html = filteredData
          .map((item) => {
            const stock = parseInt(item.quantity_present) || 0;
            const reserved = parseInt(item.quantity_reserved) || 0;
            const available = stock - reserved;

            let stockClass = "stock-high";
            if (stock === 0) stockClass = "stock-zero";
            else if (stock < 5) stockClass = "stock-low";
            else if (stock < 20) stockClass = "stock-medium";

            return `
                    <tr>
                        <td>${item.product_name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä"}</td>
                        <td>${item.warehouse_name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∫–ª–∞–¥"}</td>
                        <td>${stock.toLocaleString("ru-RU")}</td>
                        <td>${reserved.toLocaleString("ru-RU")}</td>
                        <td>${available.toLocaleString("ru-RU")}</td>
                        <td><span class="stock-level ${stockClass}">${getStockStatus(
              stock
            )}</span></td>
                        <td>${formatDate(item.updated_at)}</td>
                    </tr>
                `;
          })
          .join("");

        document.getElementById("detailedTableBody").innerHTML =
          html ||
          '<tr><td colspan="7" class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
      }

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
      function getStockStatus(stock) {
        if (stock === 0) return "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";
        if (stock < 5) return "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ";
        if (stock < 20) return "–¢—Ä–µ–±—É–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è";
        return "–í –Ω–∞–ª–∏—á–∏–∏";
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
      function formatDate(dateString) {
        if (!dateString) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        return new Date(dateString).toLocaleString("ru-RU");
      }

      // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
      function showError(message) {
        const errorHtml = `<div class="error">${message}</div>`;
        document.getElementById("warehousesPanel").innerHTML = errorHtml;
        document.getElementById("attentionPanel").innerHTML = errorHtml;
        document.getElementById(
          "detailedTableBody"
        ).innerHTML = `<tr><td colspan="7">${errorHtml}</td></tr>`;
      }

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
      setInterval(loadData, 5 * 60 * 1000);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      loadData();
    </script>
  </body>
</html>
