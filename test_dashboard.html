<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f7;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #1d1d1f;
        margin-bottom: 30px;
        text-align: center;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-card.critical {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      }
      .stat-card.warning {
        background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
      }
      .stat-card.success {
        background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
      .section {
        margin-bottom: 30px;
      }
      .section h2 {
        color: #1d1d1f;
        border-bottom: 2px solid #007aff;
        padding-bottom: 10px;
      }
      .product-list {
        display: grid;
        gap: 10px;
      }
      .product-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007aff;
      }
      .product-item.critical {
        border-left-color: #ff3b30;
        background: #fff5f5;
      }
      .product-item.warning {
        border-left-color: #ff9500;
        background: #fffbf0;
      }
      .product-name {
        font-weight: 600;
        margin-bottom: 5px;
      }
      .product-details {
        font-size: 0.9em;
        color: #666;
      }
      .recommendations {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #2196f3;
      }
      .recommendation {
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
      }
      .recommendation:last-child {
        margin-bottom: 0;
      }
      .recommendation-title {
        font-weight: 600;
        margin-bottom: 5px;
      }
      .loading {
        text-align: center;
        padding: 50px;
        color: #666;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
      }
      .test-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #007aff;
        color: white;
      }
      .btn-primary:hover {
        background: #0056b3;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background: #545b62;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üè™ –î–∞—à–±–æ—Ä–¥ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤</h1>

      <div class="test-buttons">
        <button class="btn btn-primary" onclick="loadDashboard()">
          üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥
        </button>
        <button class="btn btn-secondary" onclick="loadCriticalProducts()">
          üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã
        </button>
        <button class="btn btn-secondary" onclick="loadOverstockProducts()">
          üìà –ò–∑–±—ã—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
        </button>
        <button class="btn btn-secondary" onclick="loadRecommendations()">
          üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        </button>
      </div>

      <div id="content">
        <div class="loading">
          –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
        </div>
      </div>
    </div>

    <script>
      async function apiCall(action) {
        try {
          const response = await fetch(
            `api/inventory-analytics.php?action=${action}`
          );
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("API Error:", error);
          return { status: "error", message: error.message };
        }
      }

      async function replenishmentApiCall(action) {
        try {
          const response = await fetch(
            `replenishment_adapter_fixed.php?action=${action}`
          );
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Replenishment API Error:", error);
          return { status: "error", message: error.message };
        }
      }

      async function loadDashboard() {
        document.getElementById("content").innerHTML =
          '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

        const result = await apiCall("dashboard");

        if (result.status === "success") {
          renderDashboard(result.data);
        } else {
          renderError(result);
        }
      }

      async function loadCriticalProducts() {
        document.getElementById("content").innerHTML =
          '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤...</div>';

        const result = await apiCall("critical-products");

        if (result.status === "success") {
          renderProductList(
            result.data,
            "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã (‚â§5 –µ–¥–∏–Ω–∏—Ü)",
            "critical"
          );
        } else {
          renderError(result);
        }
      }

      async function loadOverstockProducts() {
        document.getElementById("content").innerHTML =
          '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–±—ã—Ç–∫–æ–º...</div>';

        const result = await apiCall("overstock-products");

        if (result.status === "success") {
          renderProductList(
            result.data,
            "–¢–æ–≤–∞—Ä—ã —Å –∏–∑–±—ã—Ç–∫–æ–º (>100 –µ–¥–∏–Ω–∏—Ü)",
            "warning"
          );
        } else {
          renderError(result);
        }
      }

      async function loadRecommendations() {
        document.getElementById("content").innerHTML =
          '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</div>';

        const result = await replenishmentApiCall("recommendations");

        if (result.status === "success") {
          renderRecommendations(result.data);
        } else {
          renderError(result);
        }
      }

      function renderDashboard(data) {
        const html = `
                <div class="stats-grid">
                    <div class="stat-card critical">
                        <div class="stat-number">${
                          data.critical_stock_count
                        }</div>
                        <div class="stat-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${data.low_stock_count}</div>
                        <div class="stat-label">–ù–∏–∑–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${data.overstock_count}</div>
                        <div class="stat-label">–ò–∑–±—ã—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.normal_count}</div>
                        <div class="stat-label">–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${new Intl.NumberFormat(
                          "ru-RU"
                        ).format(data.total_inventory_value)} ‚ÇΩ</div>
                        <div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    </div>
                </div>

                ${
                  data.critical_products.length > 0
                    ? `
                <div class="section">
                    <h2>üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
                    <div class="product-list">
                        ${data.critical_products
                          .slice(0, 5)
                          .map(
                            (product) => `
                            <div class="product-item critical">
                                <div class="product-name">${product.name}</div>
                                <div class="product-details">
                                    SKU: ${product.sku} | –û—Å—Ç–∞—Ç–æ–∫: ${product.stock} —à—Ç. | –°–∫–ª–∞–¥: ${product.warehouse}
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                `
                    : ""
                }

                ${
                  data.recommendations.length > 0
                    ? `
                <div class="section">
                    <h2>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
                    <div class="recommendations">
                        ${data.recommendations
                          .map(
                            (rec) => `
                            <div class="recommendation">
                                <div class="recommendation-title">${rec.title}</div>
                                <div>${rec.message}</div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                `
                    : ""
                }

                <div class="section">
                    <h2>üè™ –°–≤–æ–¥–∫–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º (—Ç–æ–ø-5)</h2>
                    <div class="product-list">
                        ${data.warehouses_summary
                          .slice(0, 5)
                          .map(
                            (warehouse) => `
                            <div class="product-item">
                                <div class="product-name">${
                                  warehouse.warehouse_name
                                }</div>
                                <div class="product-details">
                                    –¢–æ–≤–∞—Ä–æ–≤: ${
                                      warehouse.total_products
                                    } | –û—Å—Ç–∞—Ç–∫–æ–≤: ${warehouse.total_stock} —à—Ç.
                                    ${
                                      warehouse.critical_count > 0
                                        ? ` | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${warehouse.critical_count}`
                                        : ""
                                    }
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        document.getElementById("content").innerHTML = html;
      }

      function renderProductList(products, title, type) {
        const html = `
                <div class="section">
                    <h2>${title}</h2>
                    <div class="product-list">
                        ${products
                          .map(
                            (product) => `
                            <div class="product-item ${type}">
                                <div class="product-name">${product.name}</div>
                                <div class="product-details">
                                    SKU: ${product.sku} | –û—Å—Ç–∞—Ç–æ–∫: ${
                              product.stock
                            } —à—Ç. | –°–∫–ª–∞–¥: ${product.warehouse}
                                    ${
                                      product.unit_cost > 0
                                        ? ` | –¶–µ–Ω–∞: ${product.unit_cost} ‚ÇΩ`
                                        : ""
                                    }
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        document.getElementById("content").innerHTML = html;
      }

      function renderRecommendations(recommendations) {
        const html = `
                <div class="section">
                    <h2>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–∫–ª–∞–¥–æ–º</h2>
                    <div class="recommendations">
                        ${recommendations
                          .map(
                            (rec) => `
                            <div class="recommendation">
                                <div class="recommendation-title">
                                    ${
                                      rec.type === "urgent"
                                        ? "üö®"
                                        : rec.type === "optimization"
                                        ? "üìà"
                                        : "üìã"
                                    } 
                                    ${rec.title}
                                </div>
                                <div>${rec.message}</div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        document.getElementById("content").innerHTML = html;
      }

      function renderError(error) {
        const html = `
                <div class="error">
                    <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${
                      error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
                    }</p>
                    ${
                      error.details
                        ? `<p><strong>–î–µ—Ç–∞–ª–∏:</strong> ${error.details}</p>`
                        : ""
                    }
                    ${
                      error.suggestions
                        ? `
                        <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong></p>
                        <ul>
                            ${error.suggestions
                              .map((suggestion) => `<li>${suggestion}</li>`)
                              .join("")}
                        </ul>
                    `
                        : ""
                    }
                </div>
            `;

        document.getElementById("content").innerHTML = html;
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—à–±–æ—Ä–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener("load", loadDashboard);
    </script>
  </body>
</html>
